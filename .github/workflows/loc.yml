name: Lines of Code

on:
  pull_request:
  workflow_dispatch:

jobs:
  count-loc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools (cloc, jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc jq

      - name: Count raw lines (tracked files, wc -l)
        id: raw
        shell: bash
        run: |
          # –°—á–∏—Ç–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–æ–ª—å–∫–æ –≤ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö git-—Ñ–∞–π–ª–∞—Ö (—É–≤–∞–∂–∞–µ—Ç .gitignore)
          RAW_TOTAL=$(git ls-files -z \
            | xargs -0 wc -l \
            | tail -n1 \
            | awk '{print $1}')
          echo "RAW_TOTAL=$RAW_TOTAL" >> $GITHUB_ENV
          echo "Raw total lines: $RAW_TOTAL"
      
      - name: Count via cloc (code/comment/blank per language)
        id: cloc
        shell: bash
        run: |
          # cloc –¥–∞—ë—Ç —Ä–∞–∑–±–∏–≤–∫—É –ø–æ —è–∑—ã–∫–∞–º –∏ —Å—É–º–º–∞—Ä–Ω—É—é —Å—Ç—Ä–æ–∫—É SUM
          cloc . --json --quiet | tee cloc.json
          CODE=$(jq -r '.SUM.code // 0' cloc.json)
          COMMENT=$(jq -r '.SUM.comment // 0' cloc.json)
          BLANK=$(jq -r '.SUM.blank // 0' cloc.json)
          SUM=$((CODE + COMMENT + BLANK))
          echo "CLOC_CODE=$CODE" >> $GITHUB_ENV
          echo "CLOC_COMMENT=$COMMENT" >> $GITHUB_ENV
          echo "CLOC_BLANK=$BLANK" >> $GITHUB_ENV
          echo "CLOC_TOTAL=$SUM" >> $GITHUB_ENV
          echo "cloc total (code+comment+blank): $SUM"

      - name: Show report in Check Summary
        shell: bash
        run: |
          # –ö—Ä–∞—Å–∏–≤—ã–π –æ—Ç—á—ë—Ç –≤ Summary –≤–∫–ª–∞–¥–∫–µ Checks
          {
            echo "## üìä Lines of Code Report"
            echo ""
            echo "| Metric | Lines |"
            echo "|---|---:|"
            echo "| **Raw (wc -l, tracked)** | $RAW_TOTAL |"
            echo "| Code (cloc) | $CLOC_CODE |"
            echo "| Comments (cloc) | $CLOC_COMMENT |"
            echo "| Blank (cloc) | $CLOC_BLANK |"
            echo "| **Total (cloc: code+comment+blank)** | **$CLOC_TOTAL** |"
            echo ""
            echo "<sub>Raw —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã; cloc –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –±–∏–Ω–∞—Ä–Ω–∏–∫–∏ –∏ –¥–∞—ë—Ç —Ä–∞–∑–±–∏–≤–∫—É –ø–æ —è–∑—ã–∫–∞–º.</sub>"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload cloc.json artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: cloc-json
          path: cloc.json
