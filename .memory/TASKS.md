---
id: tasks
updated: 2025-10-27
---

# Tasks (канбан)

## TODO
- [ ] **4. Фаза 4 — Реализация серверного приложения (IMPL)**
  - *Цель:* реализовать основную бизнес-логику ingest/очереди/воркеров/админ-API.
  - *Задачи:*
    - [ ] 4.1 Завершить Ingest API.
      - [x] 4.1.1 Подключить `ingest_slot` к контейнеру сервисов и внедрить зависимости `JobService`/`SlotService`/`MediaService`/`SettingsService`.
      - [x] 4.1.2 Реализовать проверку ingest-пароля, выбор валидного слота и возврат 401/404 с журналированием попыток.
      - [x] 4.1.3 Валидировать multipart payload (MIME, размер, обязательные поля) и маппить ошибки в 400/413/415.
      - [x] 4.1.4 Сохранить входной файл в `MEDIA_ROOT/payloads`, зарегистрировать `MediaObject` c TTL = `min(job.expires_at, now + T_sync_response)`.
      - [x] 4.1.5 Создать `Job` через `JobService.create_job`, выставив `expires_at` и поставив задачу в очередь Postgres.
      - [x] 4.1.6 Настроить polling цикла в пределах `T_sync_response`, декодировать `result_inline_base64` и формировать ответ 200/504.
      - [x] 4.1.7 Очистить `result_inline_base64`, временные payload и `MediaObject` после завершения HTTP-ответа либо таймаута.
      - [x] 4.1.8 Обработать ошибки очереди и back-pressure (429/503), унифицировать обработку исключений ingest.
      - [x] 4.1.9 Добавить unit/contract тесты ingest (успех, неверный пароль, 415, 429, 504) и обновить фикстуры.
      - [x] 4.1.10 Обновить документацию запуска ingest (пример curl, переменные окружения, политика TTL).
    - [ ] 4.2 Реализовать очередь на PostgreSQL.
      - [ ] 4.2.1 Подготовить миграции и схему таблиц `jobs`/`processing_logs` с индексами по статусам и `expires_at`.
      - [ ] 4.2.2 Реализовать `PostgresJobQueue.enqueue` c расчётом дедлайна и сохранением ссылок на payload/result.
      - [ ] 4.2.3 Имплементировать `acquire_for_processing` на `SELECT … FOR UPDATE SKIP LOCKED` с фильтрацией просроченных задач.
      - [ ] 4.2.4 Добавить обновление статусов (`mark_finalized`/`fail`) и хранение `result_*`, `failure_reason`, `provider_job_reference`.
      - [ ] 4.2.5 Внедрить контроль параллелизма: считать активные задачи и возвращать 429/503 при превышении лимитов.
      - [ ] 4.2.6 Реализовать `release_expired` и очистку просроченных/отложенных записей вместе с привязанными `MediaObject`.
      - [ ] 4.2.7 Покрыть очередь unit/integration тестами (enqueue→acquire, SKIP LOCKED, back-pressure, cleanup TTL).
      - [ ] 4.2.8 Обновить конфигурацию и документацию по миграциям (DATABASE_URL, statement_timeout, обслуживание очереди).
    - [ ] 4.3 Разработать воркеры обработки задач.
      - [ ] 4.3.1 Реализовать запуск воркера (lifespan/background task) с учётом настроек параллелизма.
      - [ ] 4.3.2 Имплементировать `QueueWorker.run_once`: выбор Job, проверка дедлайна и graceful idle.
      - [ ] 4.3.3 Реализовать `dispatch_to_provider` (подбор адаптера, подготовка payload, сохранение `provider_job_reference`).
      - [ ] 4.3.4 Обеспечить соблюдение `job.expires_at`: отменять провайдера и помечать Job таймаутом при превышении окна.
      - [ ] 4.3.5 Сохранить результаты: декодировать ответ провайдера, записать файл через `MediaService`, обновить `Job.result_*`.
      - [ ] 4.3.6 Записать `ProcessingLog` и уведомить `StatsService` о финализации/ошибках.
      - [ ] 4.3.7 Обработать ошибки провайдеров, настроить ограниченные ретраи и очистку payload в пределах `T_sync_response`.
      - [ ] 4.3.8 Добавить unit/integration тесты воркера (успех, timeout, provider_error, cancel).
    - [ ] 4.4 Настроить хранение результатов и публичные ссылки.
      - [ ] 4.4.1 Реализовать сохранение итоговых файлов через `MediaService` с расчётом checksum и `result_expires_at = finalized_at + 72h`.
      - [ ] 4.4.2 Обновить `JobService.finalize_job` для записи `result_*`, очистки `result_inline_base64` и фиксации TTL.
      - [ ] 4.4.3 Имплементировать `GET /public/results/{job_id}`: выдачу файла до TTL и `410 Gone` после истечения.
      - [ ] 4.4.4 Настроить фонового очистителя результатов и удаление файлов из `MEDIA_ROOT/results` по `result_expires_at`.
      - [ ] 4.4.5 Добавить тесты публичных ссылок и очистки (200→410, отсутствие утечек файлов/метаданных).
      - [ ] 4.4.6 Обновить документацию по структуре `MEDIA_ROOT`, TTL и процедурам очистки.
    - [ ] 4.5 Разработать Admin API.
      - [ ] 4.5.1 Реализовать `/api/login` и выдачу JWT с claim `permissions` для статических администраторов.
      - [ ] 4.5.2 Настроить `require_bearer_authentication` и проверку прав (`settings:write`, `slots:write`, `stats:read`).
      - [ ] 4.5.3 Имплементировать `GET/PUT /api/settings`: чтение конфигурации, ротация ingest-пароля, пересчёт TTL.
      - [ ] 4.5.4 Реализовать CRUD слотов (`list/get/update`) с валидацией операций, ETag/If-Match и управлением `settings_json`.
      - [ ] 4.5.5 Реализовать регистрацию/удаление шаблонных медиа и привязку к слотам с проверкой использования.
      - [ ] 4.5.6 Собрать статистические эндпоинты `/api/stats/*` на базе `StatsService` и `ProcessingLog`.
      - [ ] 4.5.7 Сформировать выдачу `recent_results` (limit, сортировка, TTL) для UI и API ответов.
      - [ ] 4.5.8 Добавить контрактные/юнит тесты админских эндпоинтов (аутентификация, настройки, слоты, статистика).
    - [ ] 4.6 Добавить авторизацию и безопасность.
      - [ ] 4.6.1 Реализовать хранение админских credential и ingest-пароля в виде хэшей (bcrypt/scrypt) и подготовить миграции.
      - [ ] 4.6.2 Настроить сервис JWT (HS256, TTL токена, ключ из ENV) и безопасную генерацию токенов.
      - [ ] 4.6.3 Интегрировать проверку ролей на админских эндпоинтах и отказ `403` при недостатке прав.
      - [ ] 4.6.4 Реализовать аудит security-событий (логин, смена пароля, ошибки) без логирования секретов.
      - [ ] 4.6.5 Добавить тесты/документацию по security политикам (401, 403, ротация ingest-пароля, throttling 429).
    - [ ] 4.7 Внедрить логирование и метрики.
      - [ ] 4.7.1 Добавить структурированные логи ingest (создание Job, таймауты, ошибки валидации) без бинарных данных.
      - [ ] 4.7.2 Логировать ключевые события очереди/воркеров (polling, cancel, cleanup) и привязать корреляционные ID.
      - [ ] 4.7.3 Настроить метрики p95 ingest, активных Job, доли `failure_reason = 'timeout'`, использования `MEDIA_ROOT`.
      - [ ] 4.7.4 Добавить метрики ретраев провайдеров, ошибок и алертов, интегрировать с `StatsService`/monitoring hooks.
      - [ ] 4.7.5 Обновить ops-документацию и проверки наблюдаемости (скрипты/тесты для метрик и алертов).
    - [ ] 4.8 Синхронизировать артефакты и решения Фазы 4.
      - [ ] 4.8.1 Обновить `spec/contracts/VERSION.json` и при необходимости OpenAPI под новые реализации.
      - [ ] 4.8.2 Оформить ADR по очереди, воркеру, безопасности и наблюдаемости, обновить `.memory/DECISIONS.md`.
      - [ ] 4.8.3 Синхронизировать `.memory/PROGRESS.md`, `.memory/INDEX.yaml`, `.memory/ASKS.md` после внедрения изменений.
    - [ ] 4.9 Восстановить тестовое окружение и CI.
      - [ ] 4.9.1 Зафиксировать зависимости (FastAPI, Pydantic, httpx и др.) и обновить инструкции по установке.
      - [ ] 4.9.2 Добиться зелёных `mypy`, `pytest -m unit`, `pytest -m contract`, задокументировать артефакты прогонов.
  - *Выходные артефакты:* рабочее серверное приложение со всеми API и внутренними сервисами, обновлённая документация по запуску.

- [ ] **5. Фаза 5 — Интеграция провайдеров и UI**
  - *Цель:* подключить реальные провайдеры и завершить административный интерфейс.
  - *Задачи:*
    - [ ] 5.1 Интегрировать адаптер Gemini.
      - [ ] 5.1.1 Подключить `models.generateContent` и Files API.
      - [ ] 5.1.2 Настроить обработку квот, ретраев и преобразование ответов в доменную модель.
    - [ ] 5.2 Интегрировать адаптер Turbotext.
      - [ ] 5.2.1 Реализовать регистрацию `media_object` и polling `queueid`.
      - [ ] 5.2.2 Обеспечить соблюдение `T_sync_response` и обработку ошибок биллинга.
    - [ ] 5.3 Завершить административный UI.
      - [ ] 5.3.1 Реализовать динамические формы настроек слота и галерею `recent_results`.
      - [ ] 5.3.2 Добавить копирование ingest-ссылки и страницы статистики.
    - [ ] 5.4 Реализовать публичные страницы скачивания.
      - [ ] 5.4.1 Отобразить результаты с учётом TTL и статусов ссылок.
      - [ ] 5.4.2 Обработать истечение TTL с возвратом `410 Gone` и подсказками пользователю.
  - *Выходные артефакты:* подключенные провайдеры, функциональный UI, подтверждённые ручными сценариями.

- [ ] **6. Фаза 6 — Нефункциональные требования и эксплуатация**
  - *Цель:* обеспечить эксплуатационные характеристики, безопасность и управляемость.
  - *Задачи:*
    - [ ] 6.1 Ограничить параллелизм и rate limiting.
      - [ ] 6.1.1 Настроить лимиты по провайдерам и очереди.
      - [ ] 6.1.2 Ввести ограничители ingest/админ-API с учётом SLA.
    - [ ] 6.2 Настроить сбор и экспорт метрик.
      - [ ] 6.2.1 Собрать метрики ingest latency, таймаутов, polling, очисток.
      - [ ] 6.2.2 Настроить экспорт в Prometheus/логи и алерты по SLA.
    - [ ] 6.3 Усилить безопасность хранения секретов.
      - [ ] 6.3.1 Организовать защищённое хранение `app_settings` и `provider_secret`.
      - [ ] 6.3.2 Настроить TLS-конфигурацию и ротацию ключей.
    - [ ] 6.4 Автоматизировать фоновые очистки.
      - [ ] 6.4.1 Настроить процессы очистки payload/media_object/results.
      - [ ] 6.4.2 Обеспечить корректную обработку `410 Gone` для просроченных ссылок.
  - *Выходные артефакты:* включённые NFR-контроли, документация по эксплуатации и мониторингу.

- [ ] **7. Фаза 7 — End-to-End тестирование и релизная подготовка (E2E GREEN)**
  - *Цель:* подтвердить готовность платформы к релизу.
  - *Задачи:*
    - [ ] 7.1 Прогнать e2e сценарии.
      - [ ] 7.1.1 Проверить успешный ingest, таймаут 504 и сбой провайдера.
      - [ ] 7.1.2 Проверить истечение публичной ссылки и скачивание результатов через UI.
    - [ ] 7.2 Провести нагрузочное тестирование.
      - [ ] 7.2.1 Измерить p95, долю 504 и устойчивость очереди.
      - [ ] 7.2.2 Зафиксировать поведение ретраев и деградаций.
    - [ ] 7.3 Обновить регрессионные чек-листы.
      - [ ] 7.3.1 Согласовать обновления UI/API чек-листов с test-plan.
      - [ ] 7.3.2 Обновить сценарии в репозитории QA.
    - [ ] 7.4 Подготовить релизную документацию.
      - [ ] 7.4.1 Актуализировать README и инструкции по провайдерам.
      - [ ] 7.4.2 Описать эксплуатационные регламенты и процедуру релиза.
  - *Выходные артефакты:* отчёты по e2e и нагрузочным тестам, актуальная документация.

- [ ] **8. Фаза 8 — Оперативная поддержка и эволюция**
  - *Цель:* обеспечить непрерывную поддержку и развитие платформы после релиза.
  - *Задачи:*
    - [ ] 8.1 Настроить процесс Re-Sync при изменении брифа.
      - [ ] 8.1.1 Организовать мониторинг изменений брифа и связанных артефактов.
      - [ ] 8.1.2 Обновлять контракты и реализации через SDD-ворота по результатам мониторинга.
    - [ ] 8.2 Сформировать и приоритизировать backlog улучшений.
      - [ ] 8.2.1 Собрать предложения по новым провайдерам, операциям и аналитике.
      - [ ] 8.2.2 Оценить ценность и сложность, составить roadmap эволюции.
    - [ ] 8.3 Настроить эксплуатационные алерты и резервное копирование.
      - [ ] 8.3.1 Ввести алерты по SLA (`T_sync_response`, процент 504) и квотам провайдеров.
      - [ ] 8.3.2 Настроить резервное копирование шаблонов и результатов, регламенты восстановления.
  - *Выходные артефакты:* план эволюции, операционные процедуры, дашборды SLA.

## DOING
- *(пока пусто)*

## DONE
- [x] **3. Фаза 3 — Тестирование контрактов и инфраструктуры (CONTRACT TESTS GREEN)**
  - *Цель:* обеспечить автоматическую проверку API/очереди/TTL до реализации бизнес-логики.
  - *Задачи:*
    - [x] 3.1 Построить контрактные тесты API.
      - [x] 3.1.1 Покрыть ingest, админ-API и публичные ссылки позитивными сценариями.
      - [x] 3.1.2 Добавить негативные сценарии и проверки ошибок валидации.
    - [x] 3.2 Настроить интеграционные тесты очереди.
      - [x] 3.2.1 Смоделировать постановку `Job`, работу воркера и соблюдение `expires_at`.
      - [x] 3.2.2 Проверить ручную отмену и очистку просроченных задач.
    - [x] 3.3 Разработать моки провайдеров.
      - [x] 3.3.1 Реализовать режимы «успех», «таймаут», «ошибка» для Gemini.
      - [x] 3.3.2 Реализовать аналогичные режимы и ограничения для Turbotext.
    - [x] 3.4 Создать unit-тесты TTL и очистки медиа.
      - [x] 3.4.1 Покрыть расчёт `T_sync_response`, `T_public_link_ttl`, `T_result_retention`.
      - [x] 3.4.2 Проверить процедуры очистки медиа и генерацию `410 Gone`.
  - *Выходные артефакты:* зелёные `pytest -m contract`, `pytest -m unit` для TTL, тестовые заглушки провайдеров, отчёт tests/TEST_REPORT_PHASE3.md.
  - 2025-10-21: Повторно подтверждена готовность чек-листа, отчёт tests/TEST_REPORT_PHASE3.md обновлён свежими логами.

- [x] **2. Фаза 2 — Генерация стабов и scaffolding (STUBS GEN)**
  - *Цель:* подготовить минимально жизнеспособные каркасы API/доменных сервисов.
  - *Задачи:*
    - [x] 2.1 Обновить каркасы, сгенерированные из OpenAPI.
      - [x] 2.1.1 Сгенерировать или обновить контроллеры, DTO и клиентские типы.
      - [x] 2.1.2 Сопоставить с существующими стабами и удалить устаревшие элементы.
    - [x] 2.2 Провести аудит доменных сервисов и репозиториев.
      - [x] 2.2.1 Проверить каркасы `JobService`, `SlotService`, `SettingsService`, `MediaService`, `StatsService`, `QueueWorker`.
      - [x] 2.2.2 Составить backlog недостающих интерфейсов и зависимостей.
    - [x] 2.3 Подготовить инфраструктурные заглушки.
      - [x] 2.3.1 Настроить очередь на PostgreSQL с `SELECT … FOR UPDATE SKIP LOCKED`.
      - [x] 2.3.2 Настроить стораджи медиа (`MEDIA_ROOT`) и провайдерские адаптеры.
    - [x] 2.3.3 Актуализировать конфигурацию UI.
    - [x] 2.4 Обновить UI scaffolding без бизнес-логики.
      - [x] 2.4.1 Пересобрать страницы списка слотов и настройки слота.
      - [x] 2.4.2 Подготовить страницы статистики и просмотра результатов с заглушечными данными.
  - *Выходные артефакты:* репозитории/сервисы без бизнес-логики, актуальные заглушки UI и адаптеров, чек-лист готовности к тестам.

- [x] **1. Фаза 1 — Контракты и схемы (SPEC REVIEW)**
  - *Цель:* подтвердить полноту и корректность HTTP/JSON контрактов до генерации стабов.
  - *Задачи:*
    - [x] 1.1 Провести ревью OpenAPI.
      - [x] 1.1.1 Проверить ingest-эндпоинты, админ-API (`/api/slots`, `/api/settings`, `/api/stats/*`) и публичную выдачу `GET/public/results/{job_id}`.
      - [x] 1.1.2 Убедиться в корректности статусов 200/400/401/403/410/504 и описаний ошибок.
    - [x] 1.2 Верифицировать JSON Schema сущностей.
      - [x] 1.2.1 Сопоставить определения `Slot`, `Job`, `MediaObject`, `TemplateMedia`, `Result`, `Settings`, `AuthToken`, `Error`.
      - [x] 1.2.2 Проверить согласованность TTL (`T_sync_response`, `T_public_link_ttl`, `T_result_retention`) между схемами и текстовыми описаниями.
    - [x] 1.3 Сверить спецификации провайдеров с контрактами.
      - [x] 1.3.1 Сопоставить ограничения Gemini из `Docs/providers/gemini.md` с OpenAPI и доменной моделью.
      - [x] 1.3.2 Сравнить лимиты Turbotext (`Docs/providers/turbotext.md`) и требования очереди.
    - [x] 1.4 Подготовить архитектурные решения по TTL и очистке медиа.
      - [x] 1.4.1 Проверить наличие актуальных ADR по TTL, polling БД и очистке медиа.
      - [x] 1.4.2 При необходимости подготовить обновления ADR или зафиксировать подтверждение актуальности.
  - *Выходные артефакты:* протокол ревью контрактов, ADR по ключевым решениям или подтверждение актуальности.

- [x] **0. Фаза 0 — Аналитика и синхронизация SDD**
  - *Цель:* убедиться, что артефакты SDD и бриф согласованы перед началом реализации.
  - *Задачи:*
    - [x] 0.1 Сверить артефакты брифа и SDD.
      - [x] 0.1.1 Сопоставить `Docs/brief.md` с `spec/docs/blueprints/*` по сущностям, сценариям и ограничениям.
      - [x] 0.1.2 Сравнить `Docs/brief.md` с `spec/contracts/openapi.yaml` по эндпоинтам и статусам, отметить расхождения для цикла Re-Sync.
      - [x] 0.1.3 Обновить чек-лист контроля в `agents.md` с учётом выявленных расхождений.
    - [x] 0.2 Подтвердить актуальность ключевых SDD-артефактов.
      - [x] 0.2.1 Перепроверить vision/context/domain-model/test-plan согласно `Docs/sdd_roadmap.md`.
      - [x] 0.2.2 Зафиксировать требуемые ревью, список ответственных и сроки актуализации.
  - *Выходные артефакты:* протокол ревью SDD, обновлённый чек-лист контроля, перечень выявленных gap.
