---
id: tasks
updated: 2025-11-05
---

# Tasks (канбан)

> Политика: вместе с имплементационными пунктами обязательно веди задачи для размышлений и консультаций с тимлидом. Формулируй их с префиксом `CONSULT` или `REFLECT`, следуя разделу «Практика CONSULT/REFLECT» в `agents.md`, и обновляй статусы после обсуждения.

## TODO
- [x] **4. Фаза 4 — Реализация серверного приложения (IMPL)**
  - *Цель:* реализовать основную бизнес-логику ingest/очереди/воркеров/админ-API.
  - *Задачи:*
    - [x] 4.1 Завершить Ingest API.
      - [x] 4.1.1 Подключить `ingest_slot` к контейнеру сервисов и внедрить зависимости `JobService`/`SlotService`/`MediaService`/`SettingsService`.
      - [x] 4.1.2 Реализовать проверку ingest-пароля, выбор валидного слота и возврат 401/404 с журналированием попыток.
      - [x] 4.1.3 Валидировать multipart payload (MIME, размер, обязательные поля) и маппить ошибки в 400/413/415.
      - [x] 4.1.4 Сохранить входной файл в `MEDIA_ROOT/payloads`, зарегистрировать `MediaObject` c TTL = `min(job.expires_at, now + T_sync_response)`.
      - [x] 4.1.5 Создать `Job` через `JobService.create_job`, выставив `expires_at` и поставив задачу в очередь Postgres.
      - [x] 4.1.6 Настроить polling цикла в пределах `T_sync_response`, декодировать `result_inline_base64` и формировать ответ 200/504.
      - [x] 4.1.7 Очистить `result_inline_base64`, временные payload и `MediaObject` после завершения HTTP-ответа либо таймаута.
      - [x] 4.1.8 Обработать ошибки очереди и back-pressure (429/503), унифицировать обработку исключений ingest.
      - [x] 4.1.9 Добавить unit/contract тесты ingest (успех, неверный пароль, 415, 429, 504) и обновить фикстуры.
      - [x] 4.1.10 Обновить документацию запуска ingest (пример curl, переменные окружения, политика TTL).
    - [x] 4.2 Реализовать очередь на PostgreSQL.
      - [x] ДЛЯ РАЗМЫШЛЕНИЙ: текущая реализация `PostgresJobQueue` создаёт схему «на лету», поэтому без миграционного инструмента будет сложно контролировать schema drift между средами. _(Решение: переходим на SQLAlchemy + Alembic для управления схемой.)_
      - [x] Вопрос консультанту: утвердить стек миграций для очереди (Alembic против SQL-скриптов) и формат версионирования таблиц `jobs`/`processing_logs`. _(Выбраны SQLAlchemy (Core) + Alembic; версии фиксируются миграциями.)_
      - [x] 4.2.1 Подготовить миграции и схему таблиц `jobs`/`processing_logs` с индексами по статусам и `expires_at` через Alembic.
      - [x] 4.2.2 Реализовать `PostgresJobQueue.enqueue` c расчётом дедлайна и сохранением ссылок на payload/result.
      - [x] 4.2.3 Имплементировать `acquire_for_processing` на `SELECT … FOR UPDATE SKIP LOCKED` с фильтрацией просроченных задач.
      - [x] 4.2.4 Добавить обновление статусов (`mark_finalized`/`fail`) и хранение `result_*`, `failure_reason`, `provider_job_reference`.
      - [x] 4.2.5a Реализовать сбор количества активных задач и лимитов на уровне очереди/БД.
      - [x] 4.2.5b Пробросить ограничения параллелизма в Ingest API/JobService для возврата 429/503.
      - [x] 4.2.6 Реализовать `release_expired` и очистку просроченных/отложенных записей вместе с привязанными `MediaObject`.
      - [x] 4.2.7 Покрыть очередь unit/integration тестами (enqueue→acquire, SKIP LOCKED, back-pressure, cleanup TTL).
      - [x] 4.2.8 Обновить конфигурацию и документацию по миграциям (DATABASE_URL, statement_timeout, обслуживание очереди).
      - [x] 4.2.9 Подключить реальный драйвер PostgreSQL/пул соединений и транзакционный слой в очереди.
      - [x] 4.2.10 CONSULT: обсудить с тимлидом приоритет миграции `processing_logs`, без неё статистика 4.3.6/4.5.6 не заработает. _(Решение: миграция `processing_logs` остаётся в первой версии, чтобы `StatsService` и UI сразу получили историю обработки.)_
      - [x] 4.2.11 Задать пользователю вопросы о требованиях к лимитам очереди и форматам back-pressure перед реализацией. _(Решение: устанавливаем порог 12 активных задач как дефолт, фиксируем переменную `QUEUE_MAX_IN_FLIGHT_JOBS` и документируем 429 при превышении.)_
    - [x] 4.3 Разработать воркеры обработки задач.
      - [x] ДЛЯ РАЗМЫШЛЕНИЙ: `QueueWorker` вызывает провайдерские методы через `asyncio.run`, что может конфликтовать с lifespan FastAPI и не позволит использовать `httpx.AsyncClient` в Phase 5. _(Решение: переводим исполнение на чистый asyncio, запускаем четыре фоновые задачи внутри FastAPI и отказываемся от вложенных `asyncio.run`.)_
      - [x] Вопрос консультанту: подтвердить модель запуска воркеров (количество экземпляров, отдельный event loop, требования к graceful shutdown). _(Решение: один процесс FastAPI под uvicorn/asyncio, внутри — четыре фоновых воркера; при shutdown они перестают брать задачи, отменяют активные попытки и закрывают HTTP-клиенты.)_
      - [x] 4.3.1 Реализовать запуск пула из четырёх асинхронных воркеров как фоновых задач FastAPI (lifespan/background task), учитывая `QUEUE_MAX_IN_FLIGHT_JOBS` и регистрацию задач в одном event loop.
      - [x] 4.3.2 Имплементировать `QueueWorker.run_once`: выбор Job, проверка дедлайна и graceful idle.
      - [x] 4.3.3 Реализовать `dispatch_to_provider` (подбор адаптера, подготовка payload, сохранение `provider_job_reference`).
      - [x] 4.3.4 Обеспечить соблюдение `job.expires_at`: отменять провайдера и помечать Job таймаутом при превышении окна.
      - [x] 4.3.5 Сохранить результаты: декодировать ответ провайдера, записать файл через `MediaService`, обновить `Job.result_*`.
      - [x] 4.3.6 Записать `ProcessingLog` и уведомить `StatsService` о финализации/ошибках.
      - [x] 4.3.7 Обработать ошибки провайдеров, настроить ограниченные ретраи и очистку payload в пределах `T_sync_response`.
      - [x] 4.3.8 Добавить unit/integration тесты воркера (успех, timeout, provider_error, cancel).
      - [x] 4.3.9 Обновить DI и `create_app`, чтобы при старте приложения автоматически поднимались четыре фоновые задачи воркеров c Postgres-очередью и чтобы shutdown корректно останавливал пул.
      - [x] 4.3.10 CONSULT: согласовать с тимлидом стратегию исполнения `QueueWorker` (например, отдельный поток/процесс вместо текущего `asyncio.run`). _(Принято: остаёмся в одном процессе FastAPI, используем общий event loop asyncio без отдельных процессов/потоков.)_
      - [x] 4.3.11 Задать пользователю вопросы о целевом режиме исполнения воркеров (пул потоков/процессов, количество воркеров). _(Принято: фиксируем четыре воркера на dev/prod, ретраи — до пяти попыток с паузой 3 с и таймаутом 5 с каждая.)_
      - [x] 4.3.12 Переписать `QueueWorker` на чистую `asyncio`-модель без вложенных `asyncio.run`: добавить конфиг ретраев (5 попыток, пауза 3 с, таймаут 5 с), поддержку отмены активных задач и закрытие `httpx.AsyncClient` при shutdown.

    - [x] 4.4 Настроить хранение результатов и публичные ссылки.
    - [x] ДЛЯ РАЗМЫШЛЕНИЙ: подтверждено, что helper для материализации base64 и TTL очистка закрывают scope Фазы 4.4; обновление `refresh_recent_results` остаётся в плане Фазы 5 вместе с UI.
      - [x] Вопрос консультанту: подтвердить стратегию генерации превью (хранить base64 в БД или писать отдельные миниатюры на диск?). _(Решение: конвертируем превью в миниатюры под `MEDIA_ROOT/results` и ссылаемся на них.)_
      - [x] 4.4.1 Реализовать сохранение итоговых файлов через `MediaService` с расчётом checksum и `result_expires_at = finalized_at + 72h`.
      - [x] 4.4.2 Обновить `JobService.finalize_job` для записи `result_*`, очистки `result_inline_base64` и фиксации TTL = 72h.
      - [x] 4.4.3 Имплементировать `GET /public/results/{job_id}`: возвращать временную подписанную ссылку (302/307) на объектное хранилище до истечения TTL и `410 Gone` после.
      - [x] 4.4.4 Настроить фонового очистителя результатов (запуск каждые 15 минут) и удаление файлов из `MEDIA_ROOT/results` ровно по достижении `result_expires_at`.
      - [x] 4.4.5 Добавить тесты публичных ссылок и очистки (200→410, отсутствие утечек файлов/метаданных).
      - [x] 4.4.6 Обновить документацию по структуре `MEDIA_ROOT`, TTL и процедурам очистки (фиксированный TTL 72h, расписание очистителя).
      - [x] 4.4.7 REFLECT: проверить с тимлидом готовность `MEDIA_ROOT` и политику очистителя, чтобы не удалять payload до завершения ответа. _(Готовность: политика TTL/очистки соответствует ADR-0002, изменений не требуется; Риски: фактические реализации `MediaService`/`JobService` и фонового очистителя ещё не выполнены, возможна задержка удаления временных файлов.)_
      - [x] 4.4.8 Задать пользователю вопросы о требованиях к TTL публичных ссылок и форматам выдачи результатов. _(Решение: TTL фиксирован на 72h, формат — временная ссылка 302/307 на объектное хранилище.)_
      - [x] 4.4.9 Реализовать server-side helper для конвертации `result_inline_base64` в файл под `MEDIA_ROOT/results` и повторно использовать его в `QueueWorker._materialize_provider_result`.

    - [ ] 4.5 Развернуть административную платформу (домен, безопасность, API).
      - [x] 4.5.R1 REFLECT — зафиксировать недостающие компоненты (репозитории, сервисы, безопасность) и риски запуска Admin API. _(Анализ выполнен: сервисы/статистика остаются заглушками, репозитории отсутствуют, авторизация всегда отклоняет запросы; риски занесены в WORKLOG 2025-10-31.)_
        - [x] 4.5.R1a Проанализировать реализации в `src/app/services/`, `src/app/repositories/`, `src/app/security/` на предмет заглушек и отсутствующих компонентов. _(Settings/Slot/StatsService и зависимость авторизации требуют полной реализации; репозитории ещё не созданы.)_
        - [x] 4.5.R1b Сопоставить требования Admin API из `spec/contracts/openapi.yaml` и `.memory/USECASES.md` с текущим кодом, выделить пробелы. _(Текущие маршруты возвращают 501 и не соблюдают требования JWT/пагинации/статистики из контрактов.)_
        - [x] 4.5.R1c Зафиксировать риски (схема БД, безопасность, интеграция со статистикой) в `.memory/WORKLOG.md` и предложить план синхронизации с CONSULT-задачами. _(Риски авторизации/агрегаций описаны в WORKLOG; запланированы CONSULT 4.5.C1/4.5.C2.)_
      - [x] 4.5.C1 CONSULT — согласовать с тимлидом набор JWT-claim'ов, формат ответов (пагинация/фильтры) и минимальные статистики для UI. _(Решения тимлида: чтение списков покрывается `slots:write`; `meta` не расширяем; `recent_results` фиксированы без конфигурируемости; набор статистик оставляем текущим; избегаем дополнительного функционала.)_
        - [x] 4.5.C1a Свести требования к авторизации и CLAIM'ам из `spec/contracts/openapi.yaml`, `/brief.md` и текущих DTO. _(Консолидирован список статических администраторов, scope `settings:read/write`, `slots:write`, `stats:read`, claim `permissions` и `exp`.)_
        - [x] 4.5.C1b Подготовить варианты структур ответов (пагинация, фильтры, набор статистик) с аргументами. _(Сценарии `data+meta`, расширенная мета и агрегаты описаны для дальнейшего выбора.)_
        - [x] 4.5.C1c Сформулировать вопросы для тимлида, согласовать решения и обновить записи в `.memory/WORKLOG.md` и `.memory/TASKS.md`. _(Решения зафиксированы согласно ответам тимлида, записи синхронизированы.)_
      - [x] 4.5.1 Подготовить миграции и схему хранения для `admin_settings`, `slots`, `slot_templates`, агрегатов статистики, обеспечить индексацию по ключевым полям.
        - [x] 4.5.1a Спроектировать модель данных Admin API (сущности, связи, атрибуты).
        - [x] 4.5.1b Определить индексацию и ограничения для таблиц (`status`, `expires_at`, `slot_id` и др.).
        - [x] 4.5.1c Реализовать Alembic-миграции с `upgrade`/`downgrade` и smoke-тестом.
        - [x] 4.5.1d Обновить фикстуры/seed-данные и документацию схемы.
      - [ ] 4.5.2 Реализовать инфраструктурные репозитории (`SettingsRepository`, `SlotRepository`, `TemplateMediaRepository`, `StatsRepository`) на SQLAlchemy и покрыть unit-тестами.
        - [x] 4.5.2a Уточнить интерфейсы и возвращаемые модели репозиториев.
        - [x] 4.5.2b Реализовать репозитории с учётом транзакций, фильтров и обработки ошибок.
        - [x] 4.5.2c Написать unit-тесты на CRUD, пагинацию и ошибки репозиториев.
      - [x] 4.5.3 Реализовать `SettingsService`: чтение/обновление конфигурации, ротация ingest-пароля, пересчёт TTL и аудит изменений.
        - [x] 4.5.3a Спроектировать публичные методы сервиса и их контракт.
        - [x] 4.5.3b Имплементировать бизнес-логику (транзакции, шифрование, аудит).
        - [x] 4.5.3c Покрыть сервис тестами и обновить документацию по политике настройки.

      - [x] 4.5.4 Реализовать `SlotService`: CRUD слотов, валидация операций и `settings_json`, привязка шаблонных медиа, поддержка ETag/If-Match. _(Review 2025-11-04: контракт `SettingsService.get_settings()` стал единственным публичным методом чтения; `SlotManagementService` и воркеры обновлены, кеш TTL сохраняется.)_
        - [x] 4.5.4a Определить правила валидации, ограничения провайдеров и архивирования.
        - [x] 4.5.4b Реализовать CRUD-операции со связями и проверками целостности.
        - [x] 4.5.4c Внедрить ETag/If-Match и обработку конфликтов обновлений.
        - [x] 4.5.4d Покрыть сервис тестами (CRUD, валидации, ETag, архивирование).
        - [x] 4.5.5 Реализовать `StatsService`: агрегация по `processing_logs`, расчёт дашбордов, `recent_results`, кеширование и API для метрик. _(Review 2025-11-05: разделены TTL глобальных/слотовых метрик, добавлен кеш `recent_results` с ретенцией 72 ч; блокеры закрыты.)_
          - [x] 4.5.5a Спроектировать агрегаты и модель статистики (KPI, окна, TTL кеша). _(Утверждено 2025-10-31: slot stats ≤31 дней, default range = последние 14 дней с `group_by=day`; global ≤90 дней, default `group_by=week`; кеш слотов 5 мин, глобального среза 1 мин.)_
          - [x] 4.5.5b Реализовать методы агрегации и кеширования с инвалидацией.
          - [x] 4.5.5c Интегрировать события от очереди/воркеров для обновления статистики.
          - [x] 4.5.5d Протестировать расчёт метрик, кеш и поведение на крайних сценариях.
      - [x] 4.5.6 Подключить новые сервисы и репозитории в DI-контейнер, интегрировать `QueueWorker`/`JobService` с публикацией событий для `StatsService`.
        - [x] 4.5.6.R1 REFLECT — провести аудит заглушек StatsService/StatsRepository/JobService/QueueWorker, выделить точки интеграции и риски (транзакции, дедупликация событий, кеши). _(WORKLOG 2025-11-04: карта генерации логов, фиксация рисков по дедупликации, транзакциям и кешам.)_
        - [x] 4.5.6.C1 CONSULT — согласовать с тимлидом формат `ProcessingLog`, требования к консистентности статистики и политику кеш-инвалидации StatsService. _(Тимлид подтвердил предложенные ответы 2025-11-04; решения зафиксированы в WORKLOG.)_
        - [x] 4.5.6a Обновить DI-контейнер/провайдеры FastAPI новыми зависимостями.
          - [x] 4.5.6a1 Зарегистрировать реализации `StatsRepository`/`StatsService` в `ServiceRegistry`, обеспечить получение конфигурации Postgres и параметров кешей.
          - [x] 4.5.6a2 Расширить `create_app` и связанные фабрики (`ApiFacade`, state FastAPI) передачей StatsService/StatsRepository и unit of work для админских эндпоинтов.
        - [x] 4.5.6b Настроить публикацию событий между воркерами/JobService и StatsService.
          - [x] 4.5.6b1 Дополнить `JobService` (create/finalize/fail) записью `ProcessingLog` и вызовом `StatsService.record_processing_event` с нужными атрибутами.
          - [x] 4.5.6b2 Обновить `QueueWorker` для генерации `ProcessingLog` по исходам (success/timeout/error/cancel), передачи слота/провайдера и очистки после публикации.
          - [x] 4.5.6b3 Подготовить вспомогательные методы и обработку ошибок/ретраев при недоступности StatsService (логирование, метрики, деградация).
        - [x] 4.5.6c Обеспечить постоянную запись `ProcessingLog` и инвалидирование кеша в дефолтной конфигурации.
          - [x] 4.5.6c1 Переключить DI по умолчанию на `PostgresJobQueue`/`CachedStatsService`, исключив `_InMemoryJobQueue` и `DefaultStatsService` вне тестов.
          - [x] 4.5.6c2 Добавить проверку и тесты, что обработанные задания фиксируются в БД и вызывают `StatsService.record_processing_event`.
        - [x] 4.5.6d Добавить smoke-тест и актуализировать конфигурацию окружений.
          - [x] 4.5.6d1 Написать интеграционный тест FastAPI+worker, проверяющий, что события доходят до `StatsService`/`StatsRepository` и кеши инвалидируются.
          - [x] 4.5.6d2 Обновить конфигурацию окружений (`configs/*.json`, `.env.example`, README) новыми переменными StatsService/очереди и описать порядок запуска.
        - [x] 4.5.6e Синхронизировать контракт `ProcessingLog` между спецификациями и реализацией.
          - [x] 4.5.6e1 Добавить JSON Schema `ProcessingLog` в `spec/contracts/schemas/`, обновить spec/docs/admin/stats.md и domain-модель.
          - [x] 4.5.6e2 Обновить тесты/валидаторы, чтобы `ProcessingLog` и агрегаты соответствовали новому контракту.
      - [x] 4.5.C2 CONSULT — уточнить у тимлида ожидаемый горизонт статистики (по слотам, скользящие окна) и структуру `recent_results`. _(Решения зафиксированы 2025-10-31: slot stats по умолчанию 14 дней с `group_by=day`, global stats 8 недель с `group_by=week`; кеш 5 мин для слотов и 1 мин для глобального среза; `recent_results` = до 10 успешных задач за 72 ч без дополнительных фильтров.)_
        - [x] 4.5.C2a Подготовить варианты агрегатов и структуры `recent_results`. _(Варианты горизонтов slot/global + лимит 10 результатов оформлены, см. WORKLOG 2025-10-31.)_
        - [x] 4.5.C2b Сформулировать вопросы по фильтрам, лимитам и SLA обновления. _(Пакет вопросов готов и отправлен пользователю.)_
        - [x] 4.5.C2c Зафиксировать решения, скорректировать задачи 4.5.5/4.5.12 и обновить артефакты. _(Задачи обновлены 2025-10-31: 4.5.5a учитывает подтверждённые диапазоны и кеш, 4.5.12a закрепляет `recent_results` = 10 успешных записей за 72 ч.)_
      - [ ] 4.5.7 Реализовать `/api/login` с выдачей JWT (`permissions`, `exp`, `sub`), конфигурацией секретов и ограничениями TTL.
        - [ ] 4.5.7a Спроектировать контракт `/api/login` (payload, ответ, claim'ы, TTL).
        - [ ] 4.5.7b Реализовать эндпоинт FastAPI с проверкой credential и генерацией JWT.
          - [ ] 4.5.7b1 Подготовить конфигурацию секретов/TTL: добавить `jwt_access_ttl_seconds` в `AppConfig`, обновить `configs/app.*.json`, определить источник хэшей администраторов (`secrets/runtime_credentials.json`).
          - [ ] 4.5.7b2 Реализовать сервис аутентификации (`security/passwords.py`, `security/service.py`): загрузка хэшей, проверка логина/пароля, логирование и счётчик попыток.
          - [ ] 4.5.7b3 Собрать `POST /api/login` в `src/app/api/routes/auth.py`: внедрить зависимость конфигурации/сервиса, формировать JWT (`permissions`, `sub`, `exp`) и ответы 200/401/429.
        - [ ] 4.5.7c Покрыть авторизацию тестами (успех, ошибки, throttling).
          - [ ] 4.5.7c1 Написать unit/contract тесты успешного логина: проверка структуры JWT, TTL и claim'ов.
          - [ ] 4.5.7c2 Добавить тесты неуспешных сценариев (неизвестный пользователь, неверный пароль) и единообразных ошибок 401.
          - [ ] 4.5.7c3 Реализовать тесты троттлинга `/api/login` (превышение лимитов, 429, сброс счётчиков).
      - [ ] 4.5.8 Настроить `require_bearer_authentication`, проверку прав (`settings:write`, `slots:write`, `stats:read`), обработку 401/403 и троттлинг логина.
        - [ ] 4.5.8a Внедрить dependency/FastAPI security для Bearer-токена и обработку 401.
        - [ ] 4.5.8b Реализовать матрицу прав и обработку 403 в эндпоинтах.
        - [ ] 4.5.8c Настроить троттлинг `/api/login` и покрыть его тестами.
      - [ ] 4.5.9 Имплементировать `GET/PUT /api/settings` с валидацией payload, ротацией ingest-пароля и триггером пересчёта TTL.
        - [ ] 4.5.9a Подготовить Pydantic-схемы запросов/ответов и валидации.
        - [ ] 4.5.9b Реализовать эндпоинты с интеграцией SettingsService и обработкой ошибок.
          - [ ] 4.5.9b1 Добавить dependency FastAPI для получения `SettingsService` из `ServiceRegistry` и подготовить мапперы доменной модели в схемы ответа.
          - [ ] 4.5.9b2 Реализовать обработчик `GET /api/settings`: авторизация, получение snapshot настроек, сериализация в контрактную схему, обработка ошибок хранилища.
          - [ ] 4.5.9b3 Реализовать обновление `PUT /api/settings` для `sync_response_timeout_sec`: валидация payload, вызов `SettingsService.update_settings`, возврат пересчитанных TTL.
          - [ ] 4.5.9b4 Реализовать ветку обновления/ротации DSLR-пароля через `SettingsService.rotate_ingest_password` с возвратом статуса и аудит-логированием ошибок.
          - [ ] 4.5.9b5 Сопоставить исключения (`PermissionError`, `ValueError`, инфраструктурные ошибки) с ответами 400/401/403/422/500 и единообразными JSON-ошибками.
        - [ ] 4.5.9c Написать тесты на обновление, ротацию пароля и пересчёт TTL.
          - [ ] 4.5.9c1 Покрыть `GET /api/settings` unit/contract тестами на успешный сценарий и отсутствие прав.
          - [ ] 4.5.9c2 Покрыть `PUT /api/settings` тестами на обновление `sync_response_timeout_sec`, пересчёт TTL и обработку валидационных ошибок.
          - [ ] 4.5.9c3 Написать тесты ротации DSLR-пароля: успешный возврат секрета, запрет без прав и корректное логирование аудита.
      - [ ] 4.5.10 Реализовать CRUD слотов (`list/get/create/update/archive`) с поддержкой пагинации, фильтрации, ETag/If-Match и журналом изменений.
        - [ ] 4.5.10a Реализовать list/get со схемами фильтров, сортировок и пагинации.
          - [ ] 4.5.10a1 Сформировать Pydantic-схемы запросов/ответов (query, meta) и согласовать формат пагинации с контрактом.
          - [ ] 4.5.10a2 Расширить `SlotRepository` выборками с фильтрами, сортировками и расчётом общего количества записей.
          - [ ] 4.5.10a3 Обновить `SlotService` для проброса фильтров/пагинации и нормализации DTO.
          - [ ] 4.5.10a4 Имплементировать эндпоинты FastAPI `GET /api/slots`/`GET /api/slots/{slot_id}` с маппингом ошибок и разрешений.
        - [ ] 4.5.10b Имплементировать create/update/archive с проверками целостности и конфликтов.
          - [ ] 4.5.10b1 Подготовить схемы запросов/ответов для create/update/archive и правила валидации входных данных.
          - [ ] 4.5.10b2 Реализовать методы `SlotService`/`SlotRepository` для создания, обновления и архивирования с проверками зависимостей.
          - [ ] 4.5.10b3 Подключить FastAPI-эндпоинты `POST/PUT/DELETE /api/slots` к сервису, обрабатывая конфликтные состояния и ошибки валидации.
        - [ ] 4.5.10c Настроить журнал изменений и ETag/If-Match в ответах.
          - [ ] 4.5.10c1 Добавить поддержку версионирования/`etag` в `SlotRepository` (ревизии, optimistic locking, расчёт хэша).
          - [ ] 4.5.10c2 Интегрировать проверку `If-Match` и генерацию `ETag` в FastAPI-эндпоинтах обновления/архивирования.
          - [ ] 4.5.10c3 Реализовать запись журнала изменений слотов (модель, репозиторий, сервисные вызовы).
          - [ ] 4.5.10c4 Подготовить выдачу журнала изменений в ответах или связанном endpoint согласно контракту.
        - [ ] 4.5.10d Написать тесты на пагинацию, фильтры, ETag и архивирование.
          - [ ] 4.5.10d1 Покрыть `GET /api/slots`/`GET /api/slots/{slot_id}` тестами пагинации, сортировки, фильтров и ошибок доступа.
          - [ ] 4.5.10d2 Написать тесты на create/update/archive с валидациями и конфликтами зависимостей.
          - [ ] 4.5.10d3 Добавить тесты на поведение `ETag`/`If-Match` (корректный апдейт, конфликт версий, отсутствие заголовков).
          - [ ] 4.5.10d4 Протестировать журнал изменений (создание записей, последовательность, фильтрация по слотам/пользователям).
      - [ ] 4.5.11 Имплементировать управление шаблонными медиа (upload/list/delete, привязка к слотам, проверка использования перед удалением).
        - [ ] 4.5.11a Определить схемы upload/list/delete и формат привязки к слотам.
        - [ ] 4.5.11b Реализовать эндпоинты с интеграцией TemplateMediaRepository/MediaService.
        - [ ] 4.5.11c Добавить проверки использования медиа и покрыть API тестами.
      - [ ] 4.5.12 Собрать `/api/stats/global`, `/api/stats/{slot_id}`, `/api/stats/{slot_id}/recent_results` с параметрами диапазона дат и лимитов.
        - [ ] 4.5.12a Уточнить контракт эндпоинтов (фильтры, лимиты, формат `recent_results`). _(Утверждено 2025-10-31: возвращаем до 10 успешных Job (схема `Result`) за последние 72 ч, сортировка по `completed_at` убыванию, дополнительные фильтры/расширения не добавляем.)_
      - [ ] 4.5.12b Реализовать эндпоинты с подключением StatsService и обработкой ошибок.
        - [ ] 4.5.12b1 Реализовать `GET /api/stats/global`: внедрить зависимости, обработать параметры диапазона и ошибки StatsService.
        - [ ] 4.5.12b2 Реализовать `GET /api/stats/{slot_id}`: подключить Slot-проверки, маппинг исключений и обработку пустых данных.
        - [ ] 4.5.12b3 Реализовать `GET /api/stats/{slot_id}/recent_results`: учесть лимит 10 элементов и TTL 72 ч, добавить сериализацию результата.
        - [ ] 4.5.12b4 Согласовать общую обработку ошибок и зависимостей (DI, авторизация) для статистических эндпоинтов.
      - [ ] 4.5.12c Написать тесты на диапазоны, пустые результаты и производительность.
        - [ ] 4.5.12c1 Покрыть `GET /api/stats/global` тестами диапазонов, прав доступа и пустых выборок.
        - [ ] 4.5.12c2 Написать тесты `GET /api/stats/{slot_id}` на корректность фильтров, ошибки `404/403` и поведение при отсутствии данных.
        - [ ] 4.5.12c3 Реализовать тесты `GET /api/stats/{slot_id}/recent_results` (лимит 10, сортировка по `completed_at`, пустые выборки).
        - [ ] 4.5.12c4 Добавить проверку производительности/кеширования StatsService под нагрузкой запросов статистики.
        - [x] 4.5.12d Свести `SlotStatsMetric` и `GlobalStatsMetric` к примерно общей схеме `StatsMetricBase`, чтобы контракты статистики использовали единый формат периодов.
      - [ ] 4.5.13 Добавить контрактные/юнит тесты Admin API (auth, настройки, слоты, шаблоны, статистика, права) и интеграционные сценарии.
      - [ ] 4.5.14 Обновить документацию (flow JWT, матрица прав, runbook администрирования, примеры запросов) и OpenAPI при необходимости.
        - [ ] 4.5.14a Обновить OpenAPI/спецификации под финальные контракты и JWT flow.
        - [ ] 4.5.14b Дополнить runbook администрирования и примеры запросов.
        - [ ] 4.5.14c Проверить согласованность документации с spec/docs/README.md и внести правки.
      - [x] 4.5.Q1 Задать пользователю вопросы об ожиданиях по административному UX, частоте обновления статистики и форматах экспорта. _(Ответы зафиксированы 2025-10-31: автообновление таблиц каждые 60 с с подписью времени, экспорт CSV, визуальные элементы ограничены существующими таблицами/метриками.)_
        - [x] 4.5.Q1a Составить перечень тем (обновление статистики, экспорт данных, UX-ожидания). _(Темы собраны: автообновление, уведомления об устаревании, CSV/PNG экспорт.)_
        - [x] 4.5.Q1b Сформулировать вопросы и провести обсуждение с пользователем. _(Вопросы сформулированы и направлены в текущем обращении.)_
        - [x] 4.5.Q1c Зафиксировать ответы и обновить связанные задачи/артефакты. _(Обновлены записи CONSULT 4.5.C2/4.5.Q1, уточнены пункты 4.5.5a и 4.5.12a, UX-задачи следуют KISS-подходу: автообновление 60 с, отметка времени, только CSV-экспорт.)_
    - [ ] 4.6 Добавить авторизацию и безопасность.
      - [ ] ДЛЯ РАЗМЫШЛЕНИЙ: сейчас нет реализаций для хранения хэшей и выдачи JWT (`security` директория содержит только заглушки).
      - [ ] Вопрос консультанту: подтвердить требования к политике ротации секретов и необходимость 2FA/ограничений IP на MVP.
      - [ ] 4.6.1 Реализовать хранение админских credential и ingest-пароля в виде хэшей (bcrypt/scrypt) и подготовить миграции.
      - [ ] 4.6.2 Настроить сервис JWT (HS256, TTL токена, ключ из ENV) и безопасную генерацию токенов.
      - [ ] 4.6.3 Интегрировать проверку ролей на админских эндпоинтах и отказ `403` при недостатке прав.
      - [ ] 4.6.4 Реализовать аудит security-событий (логин, смена пароля, ошибки) без логирования секретов.
      - [ ] 4.6.5 Добавить тесты/документацию по security политикам (401, 403, ротация ingest-пароля, throttling 429).
      - [ ] 4.6.6 CONSULT: вынести на обсуждение с тимлидом выбор алгоритма хэширования (`bcrypt` vs `pbkdf2`) и параметры усиления.
      - [ ] 4.6.7 Задать пользователю вопросы о требованиях к безопасности (ротация ключей, политика TTL токена).
    - [ ] 4.7 Внедрить логирование и метрики.
      - [ ] ДЛЯ РАЗМЫШЛЕНИЙ: пока нет интеграции с `StatsService`, поэтому метрики некуда писать; нужно решить, используем ли Prometheus клиент или агрегируем в БД.
      - [ ] Вопрос консультанту: выбрать целевые инструменты мониторинга (Prometheus/OTEL) и форматы логов для дальнейшей интеграции.
      - [ ] 4.7.1 Добавить структурированные логи ingest (создание Job, таймауты, ошибки валидации) без бинарных данных.
      - [ ] 4.7.2 Логировать ключевые события очереди/воркеров (polling, cancel, cleanup) и привязать корреляционные ID.
      - [ ] 4.7.3 Настроить метрики p95 ingest, активных Job, доли `failure_reason = 'timeout'`, использования `MEDIA_ROOT`.
      - [ ] 4.7.4 Добавить метрики ретраев провайдеров, ошибок и алертов, интегрировать с `StatsService`/monitoring hooks.
      - [ ] 4.7.5 Обновить ops-документацию и проверки наблюдаемости (скрипты/тесты для метрик и алертов).
      - [ ] 4.7.6 CONSULT: определить вместе с тимлидом стек метрик (Prometheus/Pushgateway/StatsService) до начала интеграции.
      - [ ] 4.7.7 Задать пользователю вопросы о приоритетных метриках и форматах логирования.
    - [ ] 4.8 Синхронизировать артефакты и решения Фазы 4.
      - [ ] 4.8.1 Обновить `spec/contracts/VERSION.json` и при необходимости OpenAPI под новые реализации.
      - [ ] 4.8.2 Оформить ADR по очереди, воркеру, безопасности и наблюдаемости, обновить `.memory/DECISIONS.md`.
      - [ ] 4.8.3 Синхронизировать `.memory/PROGRESS.md`, `.memory/INDEX.yaml`, `.memory/ASKS.md` после внедрения изменений.
      - [ ] 4.8.4 REFLECT: наметить с тимлидом окно для обновления OpenAPI после внедрения Admin API и публичных ссылок.
      - [ ] 4.8.5 Задать пользователю вопросы о предпочтительном формате отчётности и приоритете ADR.
    - [ ] 4.9 Восстановить тестовое окружение и CI.
      - [ ] 4.9.1 Зафиксировать зависимости (FastAPI, Pydantic, httpx и др.) и обновить инструкции по установке.
      - [ ] 4.9.2 Добиться зелёных `mypy`, `pytest -m unit`, `pytest -m contract`, задокументировать артефакты прогонов.
      - [ ] 4.9.3 CONSULT: обсудить с тимлидом формат docker-compose/инструкций для локального Postgres под новые интеграционные тесты.
      - [ ] 4.9.4 Задать пользователю вопросы о CI-инфраструктуре и необходимых окружениях (локально, staging, cloud).
  - *Выходные артефакты:* рабочее серверное приложение со всеми API и внутренними сервисами, обновлённая документация по запуску.

- [ ] **5. Фаза 5 — Интеграция провайдеров и UI**
  - *Цель:* подключить реальные провайдеры и завершить административный интерфейс.
  - *Задачи:*
    - [ ] 5.1 Интегрировать адаптер Gemini. — *(Сложность: высокая; ветвления: требует согласования асинхронной архитектуры воркеров и политики хранения файлов.)*
      - [ ] ДЛЯ РАЗМЫШЛЕНИЙ: текущий воркер синхронный и не поддерживает долгоживущие HTTP-сессии; после переработки в 4.3.9 нужно убедиться, что адаптер сможет переиспользовать `httpx.AsyncClient` и корректно обрабатывать тайм-ауты.
      - [ ] Вопрос консультанту: подтвердить набор операций Gemini для MVP (только `generateContent` или также edit-with-prompt/multi-image fusion) и требования к качеству/латентности.
      - [ ] 5.1.1 Реализовать `GeminiProviderAdapter.prepare_payload`, маппя `slot.settings_json` и контекст `Job` в структуру `contents`/`inline_data`/`file_data` по `spec/docs/providers/gemini.md`. — *(Сложность: средняя; ветвления: необходимо согласовать единый формат контента между провайдерами, иначе придётся разветвлять модель `ProviderPayload`.)*
      - [ ] 5.1.2 Настроить `httpx.AsyncClient` (или официальную SDK) в `submit_job`, брать API-ключ из `AppConfig.provider_keys['gemini']`, прокидывать `x-goog-api-key`, логировать correlation-id и latency. — *(Сложность: высокая; ветвления: выбор жизненного цикла клиента (`per worker`/`per request`) влияет на архитектуру воркера и DI, может потребоваться отдельный event loop.)*
      - [ ] 5.1.3 Реализовать helper для Files API: загрузка больших payload в `files.upload`, кеширование `file_uri` и ревокация по истечении TTL (интегрировать с `MediaService`). — *(Сложность: высокая; ветвления: придётся решить, храним ли мы `file_uri` в БД/MediaService или в кеше, и как синхронизировать очистку с TTL payload.)*
      - [ ] 5.1.4 Имплементировать `poll_status`/`cancel` с обработкой статусов `succeeded`/`processing`/ошибок, ретраями на 429/5xx и маппингом ошибок в `JobFailureReason`. — *(Сложность: высокая; ветвления: стратегия ретраев и дедлайнов может потребовать общую политику для всех провайдеров и расширение `JobService`.)*
      - [ ] 5.1.5 Расширить `QueueWorker._materialize_provider_result` и новый helper из 4.4.7, чтобы результат Gemini сохранялся в `MEDIA_ROOT/results`, вычислялся checksum, выставлялись `result_file_path`/`result_mime_type` и очищался `result_inline_base64` после выдачи ingest. — *(Сложность: высокая; ветвления: потребуется унифицировать материализацию результатов между провайдерами и решить, кто отвечает за очистку `inline_base64`.)*
      - [ ] 5.1.6 Добавить unit/integration тесты адаптера (моки Gemini), покрыть success/pending/timeout/error, обновить `tests/integration/test_queue_worker_dispatch.py` и фикстуры. — *(Сложность: средняя; ветвления: нужно определить общий тестовый контракт для провайдеров, иначе тесты будут дублироваться.)*
      - [ ] 5.1.7 Обновить документацию (`spec/docs/providers/gemini.md`, runbook ingest) по ключам, квотам, процедурам отладки и лимитам Files API. — *(Сложность: низкая; ветвления: важно синхронизировать с будущими ADR, чтобы избежать расхождения по SLA.)*
      - [ ] REFLECT: выбрать стратегию переиспользования `httpx.AsyncClient` (singleton per worker vs per провайдер vs per запрос) и схему передачи таймаутов до начала 5.1.2.
      - [ ] CONSULT: утвердить с тимлидом границы ответственности за хранение/ревокацию `file_uri` между `MediaService`, `GeminiProviderAdapter` и воркером перед стартом 5.1.3.
    - [ ] 5.2 Интегрировать адаптер Turbotext. — *(Сложность: высокая; ветвления: влияет на модель биллинга, хранение публичных ссылок и дедлайны очереди.)*
      - [ ] ДЛЯ РАЗМЫШЛЕНИЙ: API Turbotext использует биллинг и polling `queueid`; нужно гарантировать освобождение `media_object`, если провайдер не забрал файл до TTL.
      - [ ] Вопрос консультанту: уточнить лимиты по стоимости/количеству одновременных задач и приоритет сценариев (style transfer vs текстовые операции Turbotext).
      - [ ] 5.2.1 Реализовать `TurbotextProviderAdapter.prepare_payload`, формируя HTTPS-ссылки на `media_object` и параметры операций из `slot.settings_json`. — *(Сложность: средняя; ветвления: потребуется унифицированный механизм генерации временных публичных ссылок, чтобы не расходились политики с 5.4.)*
      - [ ] 5.2.2 Имплементировать `submit_job`/`poll_status`/`cancel` по REST `api_ai`, сохранять `queueid`, обрабатывать статусы `reconnect`/`success`/`error`, учитывать `T_sync_response`. — *(Сложность: высокая; ветвления: обработка биллинга и статусов может потребовать расширения модели Job и единой системы тарификации.)*
      - [ ] 5.2.3 Добавить защиту от превышения дедлайна: синхронизация с `QueueWorker` для досрочной отмены задач, очистка payload и фиксация `failure_reason`. — *(Сложность: средняя; ветвления: придётся согласовать ответственность за отмену между воркером и адаптером, чтобы избежать двойной очистки.)*
      - [ ] 5.2.4 Покрыть интеграционными тестами адаптер (успех, billing error, timeout), обновить `tests/mocks/turbotext` и e2e сценарии. — *(Сложность: средняя; ветвления: тестовая инфраструктура должна поддерживать разные схемы провайдеров, иначе придётся дублировать фикстуры.)*
      - [ ] 5.2.5 Обновить документацию (`spec/docs/providers/turbotext.md`) и operational runbook по настройке ключей, биллинга и SLA. — *(Сложность: низкая; ветвления: важно синхронизировать с финансовыми ограничениями и политиками из 6.*.)*
      - [ ] REFLECT: продумать стратегию управления затратами и ретраями Turbotext (порог отмены, fallback) перед реализацией 5.2.2.
      - [ ] CONSULT: уточнить у тимлида требования к безопасности публичных ссылок для Turbotext (одноразовые vs повторное использование) до начала 5.2.1.
    - [ ] 5.3 Завершить административный UI. — *(Сложность: высокая; ветвления: определяет стек фронтенда, модель авторизации и потоков данных с Admin API.)*
      - [ ] ДЛЯ РАЗМЫШЛЕНИЙ: `src/app/ui/views.py` и шаблоны используют `mock_data`; потребуется фасад над Admin API и управление JWT для серверной/клиентской части.
      - [ ] Вопрос консультанту: согласовать UX (автосохранение форм, отображение ошибок 422, предпросмотр шаблонных медиа, нужные ли графики на дашборде).
      - [ ] 5.3.1 Реализовать клиентский фасад (`src/app/ui/facade.py`) для вызовов `/api/login`, `/api/settings`, `/api/slots/*`, `/api/stats/*`, хранить JWT в cookies/сессии. — *(Сложность: высокая; ветвления: выбор способа хранения JWT (cookie httpOnly vs session server-side) затрагивает безопасность и инфраструктуру UI.)*
      - [ ] 5.3.2 Переписать шаблоны `slots/index.html` и `slots/detail.html` на HTMX/JS-запросы к Admin API, удалить `mock_data` и обеспечить загрузку провайдерских настроек. — *(Сложность: высокая; ветвления: потребуется решить, использовать ли HTMX или полноценный SPA-фреймворк, что влияет на архитектуру фронтенда.)*
      - [ ] 5.3.3 Добавить формы редактирования слота (provider/operation/settings_json) с отображением ошибок из 422 ответов и подтверждением изменений. — *(Сложность: средняя; ветвления: нужно согласовать универсальную схему валидации JSON-настроек и шаблоны ошибок для всех провайдеров.)*
      - [ ] 5.3.4 Реализовать галерею `recent_results`, используя `GET /api/slots/{slot_id}`, подсвечивать элементы с истёкшим TTL и предоставлять кнопки скачивания. — *(Сложность: средняя; ветвления: отображение TTL и кеширование превью потребует единой модели данных с бэкендом.)*
      - [ ] 5.3.5 Наполнить `/ui/stats` реальными данными из `/api/stats/*`, добавить агрегированные карточки и графики (Chart.js или SVG), обработать пустые состояния. — *(Сложность: высокая; ветвления: нужно выбрать библиотеку визуализации и формат агрегатов `StatsService`, иначе фронт и бэк будут расходиться.)*
      - [ ] 5.3.6 Добавить smoke/e2e-тесты UI (pytest -m e2e или Playwright) для сценариев логина, редактирования слота и просмотра результатов. — *(Сложность: высокая; ветвления: выбор инструмента тестирования и тестовых данных влияет на структуру CI и окружений.)*
      - [ ] 5.3.7 Обновить документацию (`spec/docs/frontend-examples`, README) с описанием потоков авторизации, обновления слотов и просмотра статистики. — *(Сложность: средняя; ветвления: документация должна зафиксировать выбранную архитектуру UI, иначе появятся расхождения с реализацией.)*
      - [ ] REFLECT: определить модель хранения и обновления JWT (cookie, session storage, server-side session) и последствия для CSRF перед стартом 5.3.1.
      - [ ] CONSULT: согласовать с тимлидом выбор фронтенд-стека (HTMX vs JS-фреймворк) и подход к графикам до начала 5.3.2/5.3.5.
    - [ ] 5.4 Реализовать публичные страницы скачивания. — *(Сложность: средняя; ветвления: требует выбора стратегии CDN/кеша и согласования поведения при истечении TTL.)*
      - [ ] ДЛЯ РАЗМЫШЛЕНИЙ: `src/app/api/routes/public.py` пока возвращает заглушки; нужно учесть TTL, выдачу `Content-Disposition` и удаление файлов после скачивания.
      - [ ] Вопрос консультанту: уточнить UX подсказок при `410 Gone` (нужна ли страница помощи или редирект на админский UI) и требования к брендингу публичной страницы.
      - [ ] 5.4.1 Реализовать `GET /public/media/{media_id}` и `GET /public/results/{job_id}` с потоковой выдачей файлов из `MEDIA_ROOT`, проверкой `result_expires_at` и логированием обращений. — *(Сложность: средняя; ветвления: нужно выбрать механизм стриминга (aiofiles vs sendfile) и учесть влияние на инфраструктуру CDN.)*
      - [ ] 5.4.2 Добавить шаблоны/эндпоинты UI для публичного скачивания (HTMX/Vanilla JS), показывать состояние «срок истёк» и инструкцию по повторному ingest. — *(Сложность: средняя; ветвления: потребуется решить, обслуживает ли публичный UI ту же сессию, что и админ, и как локализуются подсказки.)*
      - [ ] 5.4.3 Написать unit и contract тесты (200/404/410, повторные скачивания, истечение TTL) с использованием временных файлов и мока очереди. — *(Сложность: средняя; ветвления: тесты должны синхронизироваться с очистителями из 4.4/6.4, иначе появятся расхождения во временах TTL.)*
      - [ ] 5.4.4 Обновить public runbook/README с примерами URL, политикой TTL, рекомендациями по CDN/кешированию и шагами очистки. — *(Сложность: низкая; ветвления: документация должна зафиксировать выбранную стратегию CDN/кеша, чтобы не расходиться с DevOps.)*
      - [ ] REFLECT: оценить необходимость отдельного домена/CDN для публичной выдачи и влияние на безопасность ссылок перед реализацией 5.4.1.
      - [ ] CONSULT: уточнить у тимлида UX поведения при `410 Gone` (статическая страница vs редирект) до начала 5.4.2.
  - *Выходные артефакты:* подключенные провайдеры, функциональный UI и публичные страницы, подтверждённые unit/contract/e2e сценариями и обновлённой документацией.

- [ ] **6. Фаза 6 — Нефункциональные требования и эксплуатация**
  - *Цель:* обеспечить эксплуатационные характеристики, безопасность и управляемость.
  - *Задачи:*
    - [ ] 6.1 Ограничить параллелизм и rate limiting.
      - [ ] 6.1.R1 REFLECT — выбрать архитектуру ограничителей параллелизма.
        - Проанализировать текущие реализации очереди и воркеров в `src/app/services/job_service.py`, `src/app/workers/queue_worker.py`.
        - Сравнить варианты ограничителей (БД, Redis/token bucket, middleware FastAPI) и оценить влияние на SLA ingest/админ-API.
        - Зафиксировать выводы и предложенную архитектуру в `.memory/WORKLOG.md`.
      - [ ] 6.1.C1 CONSULT — утвердить бюджеты параллелизма и политику rate limiting.
        - Подготовить вопросы тимлиду о целевых лимитах очереди, burst-режимах и деградациях.
        - Представить варианты из рефлексии, согласовать ответственных компонентов и SLA.
        - Обновить план задач 6.1.* и конфигурацию после консультации.
      - [ ] 6.1.1 Настроить лимиты по провайдерам и очереди.
      - [ ] 6.1.2 Ввести ограничители ingest/админ-API с учётом SLA.
    - [ ] 6.2 Настроить сбор и экспорт метрик.
      - [ ] 6.2.R1 REFLECT — определить таксономию метрик и точки сбора.
        - Проанализировать критичные пути ingest, очереди и очистителей, выявить обязательные метрики и лейблы.
        - Сформировать документ с перечнем метрик и зафиксировать выводы в `.memory/WORKLOG.md`.
      - [ ] 6.2.C1 CONSULT — выбрать стек экспорта метрик и формат алертов.
        - Согласовать с тимлидом и DevOps подход (Prometheus/OpenTelemetry, push/pull), требования к алертам и дашбордам.
        - Обновить подпункты 6.2.* и связанные артефакты после консультации.
      - [ ] 6.2.1 Собрать метрики ingest latency, таймаутов, polling, очисток.
      - [ ] 6.2.2 Настроить экспорт в Prometheus/логи и алерты по SLA.
    - [ ] 6.3 Усилить безопасность хранения секретов.
      - [ ] 6.3.R1 REFLECT — сравнить стратегии хранения секретов.
        - Изучить текущие модули безопасности и конфигурации, оценить варианты (ENV, Vault, KMS) и требования к ротации.
        - Подготовить матрицу рисков и сохранить результаты анализа в `.memory/WORKLOG.md`.
      - [ ] 6.3.C1 CONSULT — утвердить выбор секрет-хранилища и параметры TLS.
        - Сформулировать вопросы тимлиду о целевых средах, доступных сервисах шифрования и графике ротации ключей.
        - Представить рекомендации из рефлексии, согласовать ответственность и требования к TLS.
        - Актуализировать задачи 6.3.* по итогам консультации.
      - [ ] 6.3.1 Организовать защищённое хранение `app_settings` и `provider_secret`.
      - [ ] 6.3.2 Настроить TLS-конфигурацию и ротацию ключей.
    - [ ] 6.4 Автоматизировать фоновые очистки.
      - [ ] 6.4.R1 REFLECT — выбрать подход к планированию фоновых очисток.
        - Проанализировать текущие фоновые задачи и сервисы `MediaService`, оценить варианты планировщиков (встроенный, cron, очередь).
        - Зафиксировать влияние на отказоустойчивость и мониторинг в `.memory/WORKLOG.md`.
      - [ ] 6.4.C1 CONSULT — согласовать источник истины для TTL и расписание очисток.
        - Подготовить вопросы тимлиду по приоритетам очистки, допустимым задержкам и необходимости уведомлений.
        - Обсудить централизованное хранение TTL и обновить подпункты 6.4.* по итогам консультации.
      - [ ] 6.4.1 Настроить процессы очистки payload/media_object/results.
      - [ ] 6.4.2 Обеспечить корректную обработку `410 Gone` для просроченных ссылок.
  - *Выходные артефакты:* включённые NFR-контроли, документация по эксплуатации и мониторингу.

- [ ] **7. Фаза 7 — End-to-End тестирование и релизная подготовка (E2E GREEN)**
  - *Цель:* подтвердить готовность платформы к релизу.
  - *Задачи:*
    - [ ] 7.1 Прогнать e2e сценарии.
      - [ ] 7.1.1 Проверить успешный ingest, таймаут 504 и сбой провайдера.
      - [ ] 7.1.2 Проверить истечение публичной ссылки и скачивание результатов через UI.
    - [ ] 7.2 Провести нагрузочное тестирование.
      - [ ] 7.2.1 Измерить p95, долю 504 и устойчивость очереди.
      - [ ] 7.2.2 Зафиксировать поведение ретраев и деградаций.
    - [ ] 7.3 Обновить регрессионные чек-листы.
      - [ ] 7.3.1 Согласовать обновления UI/API чек-листов с test-plan.
      - [ ] 7.3.2 Обновить сценарии в репозитории QA.
    - [ ] 7.4 Подготовить релизную документацию.
      - [ ] 7.4.1 Актуализировать README и инструкции по провайдерам.
      - [ ] 7.4.2 Описать эксплуатационные регламенты и процедуру релиза.
  - *Выходные артефакты:* отчёты по e2e и нагрузочным тестам, актуальная документация.

- [ ] **8. Фаза 8 — Оперативная поддержка и эволюция**
  - *Цель:* обеспечить непрерывную поддержку и развитие платформы после релиза.
  - *Задачи:*
    - [ ] 8.1 Настроить процесс Re-Sync при изменении брифа.
      - [ ] 8.1.1 Организовать мониторинг изменений брифа и связанных артефактов.
      - [ ] 8.1.2 Обновлять контракты и реализации через SDD-ворота по результатам мониторинга.
    - [ ] 8.2 Сформировать и приоритизировать backlog улучшений.
      - [ ] 8.2.1 Собрать предложения по новым провайдерам, операциям и аналитике.
      - [ ] 8.2.2 Оценить ценность и сложность, составить roadmap эволюции.
    - [ ] 8.3 Настроить эксплуатационные алерты и резервное копирование.
      - [ ] 8.3.1 Ввести алерты по SLA (`T_sync_response`, процент 504) и квотам провайдеров.
      - [ ] 8.3.2 Настроить резервное копирование шаблонов и результатов, регламенты восстановления.
  - *Выходные артефакты:* план эволюции, операционные процедуры, дашборды SLA.

## DOING
- *(пока пусто)*

## DONE
- [x] **3. Фаза 3 — Тестирование контрактов и инфраструктуры (CONTRACT TESTS GREEN)**
  - *Цель:* обеспечить автоматическую проверку API/очереди/TTL до реализации бизнес-логики.
  - *Задачи:*
    - [x] 3.1 Построить контрактные тесты API.
      - [x] 3.1.1 Покрыть ingest, админ-API и публичные ссылки позитивными сценариями.
      - [x] 3.1.2 Добавить негативные сценарии и проверки ошибок валидации.
    - [x] 3.2 Настроить интеграционные тесты очереди.
      - [x] 3.2.1 Смоделировать постановку `Job`, работу воркера и соблюдение `expires_at`.
      - [x] 3.2.2 Проверить ручную отмену и очистку просроченных задач.
    - [x] 3.3 Разработать моки провайдеров.
      - [x] 3.3.1 Реализовать режимы «успех», «таймаут», «ошибка» для Gemini.
      - [x] 3.3.2 Реализовать аналогичные режимы и ограничения для Turbotext.
    - [x] 3.4 Создать unit-тесты TTL и очистки медиа.
      - [x] 3.4.1 Покрыть расчёт `T_sync_response`, `T_public_link_ttl`, `T_result_retention`.
      - [x] 3.4.2 Проверить процедуры очистки медиа и генерацию `410 Gone`.
  - *Выходные артефакты:* зелёные `pytest -m contract`, `pytest -m unit` для TTL, тестовые заглушки провайдеров, отчёт tests/TEST_REPORT_PHASE3.md.
  - 2025-10-21: Повторно подтверждена готовность чек-листа, отчёт tests/TEST_REPORT_PHASE3.md обновлён свежими логами.

- [x] **2. Фаза 2 — Генерация стабов и scaffolding (STUBS GEN)**
  - *Цель:* подготовить минимально жизнеспособные каркасы API/доменных сервисов.
  - *Задачи:*
    - [x] 2.1 Обновить каркасы, сгенерированные из OpenAPI.
      - [x] 2.1.1 Сгенерировать или обновить контроллеры, DTO и клиентские типы.
      - [x] 2.1.2 Сопоставить с существующими стабами и удалить устаревшие элементы.
    - [x] 2.2 Провести аудит доменных сервисов и репозиториев.
      - [x] 2.2.1 Проверить каркасы `JobService`, `SlotService`, `SettingsService`, `MediaService`, `StatsService`, `QueueWorker`.
      - [x] 2.2.2 Составить backlog недостающих интерфейсов и зависимостей.
    - [x] 2.3 Подготовить инфраструктурные заглушки.
      - [x] 2.3.1 Настроить очередь на PostgreSQL с `SELECT … FOR UPDATE SKIP LOCKED`.
      - [x] 2.3.2 Настроить стораджи медиа (`MEDIA_ROOT`) и провайдерские адаптеры.
    - [x] 2.3.3 Актуализировать конфигурацию UI.
    - [x] 2.4 Обновить UI scaffolding без бизнес-логики.
      - [x] 2.4.1 Пересобрать страницы списка слотов и настройки слота.
      - [x] 2.4.2 Подготовить страницы статистики и просмотра результатов с заглушечными данными.
  - *Выходные артефакты:* репозитории/сервисы без бизнес-логики, актуальные заглушки UI и адаптеров, чек-лист готовности к тестам.

- [x] **1. Фаза 1 — Контракты и схемы (SPEC REVIEW)**
  - *Цель:* подтвердить полноту и корректность HTTP/JSON контрактов до генерации стабов.
  - *Задачи:*
    - [x] 1.1 Провести ревью OpenAPI.
      - [x] 1.1.1 Проверить ingest-эндпоинты, админ-API (`/api/slots`, `/api/settings`, `/api/stats/*`) и публичную выдачу `GET/public/results/{job_id}`.
      - [x] 1.1.2 Убедиться в корректности статусов 200/400/401/403/410/504 и описаний ошибок.
    - [x] 1.2 Верифицировать JSON Schema сущностей.
      - [x] 1.2.1 Сопоставить определения `Slot`, `Job`, `MediaObject`, `TemplateMedia`, `Result`, `Settings`, `AuthToken`, `Error`.
      - [x] 1.2.2 Проверить согласованность TTL (`T_sync_response`, `T_public_link_ttl`, `T_result_retention`) между схемами и текстовыми описаниями.
    - [x] 1.3 Сверить спецификации провайдеров с контрактами.
      - [x] 1.3.1 Сопоставить ограничения Gemini из `spec/docs/providers/gemini.md` с OpenAPI и доменной моделью.
      - [x] 1.3.2 Сравнить лимиты Turbotext (`spec/docs/providers/turbotext.md`) и требования очереди.
    - [x] 1.4 Подготовить архитектурные решения по TTL и очистке медиа.
      - [x] 1.4.1 Проверить наличие актуальных ADR по TTL, polling БД и очистке медиа.
      - [x] 1.4.2 При необходимости подготовить обновления ADR или зафиксировать подтверждение актуальности.
  - *Выходные артефакты:* протокол ревью контрактов, ADR по ключевым решениям или подтверждение актуальности.

- [x] **0. Фаза 0 — Аналитика и синхронизация SDD**
  - *Цель:* убедиться, что артефакты SDD и бриф согласованы перед началом реализации.
  - *Задачи:*
    - [x] 0.1 Сверить артефакты брифа и SDD.
      - [x] 0.1.1 Сопоставить `/brief.md` с `spec/docs/blueprints/*` по сущностям, сценариям и ограничениям.
      - [x] 0.1.2 Сравнить `/brief.md` с `spec/contracts/openapi.yaml` по эндпоинтам и статусам, отметить расхождения для цикла Re-Sync.
      - [x] 0.1.3 Обновить чек-лист контроля в `agents.md` с учётом выявленных расхождений.
    - [x] 0.2 Подтвердить актуальность ключевых SDD-артефактов.
      - [x] 0.2.1 Перепроверить vision/context/domain-model/test-plan согласно `spec/docs/sdd_roadmap.md`.
      - [x] 0.2.2 Зафиксировать требуемые ревью, список ответственных и сроки актуализации.
  - *Выходные артефакты:* протокол ревью SDD, обновлённый чек-лист контроля, перечень выявленных gap.
