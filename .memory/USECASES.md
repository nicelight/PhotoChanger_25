---
id: usecases
updated: 2025-10-31
---

# Ключевые сценарии

## UC0. Вход администратора и ротация ingest-пароля
- **Акторы:** Администратор, Auth API, Settings API.
- **Основной поток:**
  1. `POST /api/login` с валидными учётными данными (`serg`/`igor`).
  2. Возврат JWT c разрешениями `settings:write`.
  3. `PUT /api/settings` с новым ingest-паролем → сохраняем хэш, обновляем метаданные.
  4. `GET /api/settings` отображает дату/автора без раскрытия секрета.
- **Критерии успеха:** JWT валиден 24 ч, audit запись фиксируется, пароль вступает в силу сразу.
- **Ошибки:** `401` (неверный логин/пароль), `403` (нет `settings:write`), `429` (частые попытки).

## UC1. Настройка слота администраторами
- **Акторы:** Администратор, Slot Management UI/API.
- **Предусловия:** Авторизован JWT с правами `slots:write`.
- **Основной поток:** просмотр списка слотов `slot-001`…`slot-015`, выбор слота, загрузка доступных операций, заполнение формы (провайдер, операция, параметры, `template_media`), `PUT /api/slots/{slot_id}` с валидацией схемы, возврат обновлённой конфигурации и списка публичных ссылок.
- **Критерии успеха:** Конфигурация сохраняется в БД, UI пересобирает ingest-ссылку, журнал изменений пополняется.
- **Ошибки:** `422` при невалидных параметрах, `404` при неизвестном слоте, `409` при конфликте версий.

## UC2. Ingest с успешной обработкой
- **Акторы:** DSLR Remote Pro, Ingest API, Provider Driver, Media Store, PostgreSQL.
- **Основной поток:** `POST /api/ingest/{slot_id}` (multipart), валидация и запись `job_history(status=pending)`, сохранение temp файла, `asyncio.wait_for(driver.process, timeout=T_sync_response)`, получение результата, сохранение `media/results/{job_id}`, обновление статуса `done`, ответ `200` с `/public/results/{job_id}` и inline превью (опционально).
- **Критерии успеха:** Ответ ≤ `T_sync_response`, результат доступен 72 ч, логи содержат `job_id` и тайминги.
- **Ошибки:** `401` (неверный пароль), `413/415` (размер/MIME), `404` (слот выключен), `502` (ошибка провайдера).

## UC3. Ingest с таймаутом 504
- **Акторы:** DSLR Remote Pro, Ingest API, Provider Driver.
- **Основной поток:** как UC2, но `driver.process` не успевает → `asyncio.TimeoutError`, статус `timeout`, temp-файл удалён, ответ `504`.
- **Критерии успеха:** Очистка temp и публичных ссылок выполняется, оператор может перезапустить процесс; статистика фиксирует событие.
- **Ошибки:** повторные таймауты → алерты ops.

## UC4. Истечение временной ссылки `media_object`
- **Акторы:** Провайдеры, Public API, Media Store.
- **Основной поток:** при регистрации файла провайдера создаётся `media_object` с TTL = `T_sync_response`, провайдер скачивает файл по выданной ссылке, после истечения TTL cron удаляет запись и файл, дальнейшие запросы → `410 Gone`.
- **Критерии успеха:** Ни одна просроченная ссылка не отвечает `200`, очистка фиксируется в логах.
- **Ошибки:** провайдер обращается после TTL → корректный `410`.

## UC5. Управление шаблонными медиа и галереей результатов
- **Акторы:** Администратор, Admin API, Media Store, Public API.
- **Основной поток:** `POST /api/template-media/register` (валидация MIME/размер), привязка ID к слоту, `GET /api/slots/{slot_id}` возвращает `recent_results` (10 шт.), UI отображает превью и ссылки `GET /public/results/{job_id}`.
- **Критерии успеха:** Превью обновляются после успешной обработки, удаление слота снимает привязки, просроченные результаты убираются из списка.
- **Ошибки:** `422` (некорректные медиа), `404` (нет файла/слота), `410` (просроченный результат).

## UC6. Наблюдаемость и Ops
- **Акторы:** Ops-инженер, Monitoring, Cron.
- **Основной поток:** Ops проверяет `/metrics` (p95 ingest, доля 504, объём `media/`), health-check `/healthz`, получает алерты при росте 504 или заполнении диска. Cron `scripts/cleanup_media.py` запускается каждые 15 мин и удаляет просроченные файлы.
- **Критерии успеха:** Метрики доступны, алерты корректно срабатывают, cron не падает, в логах фиксируются операции очистки.
- **Ошибки:** отсутствие метрик → инцидент P1, падение cron → ручной перезапуск и разбор.
