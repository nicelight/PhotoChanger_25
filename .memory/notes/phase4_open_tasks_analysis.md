# Анализ незавершённых задач фазы 4 (2025-10-27)

## Краткие ответы на вопросы
- **Декомпозиция.** Дополнительное дробление требуется только для подпункта 4.2.5: контроль параллелизма стоит разделить на измерение загрузки очереди и реакцию ingest API (возврат 429/503), чтобы не смешивать инфраструктурный и HTTP-слой.
- **Дополнительные таски.** Предлагаю добавить: (1) 4.2.9 — подключение реального драйвера PostgreSQL и транзакционного слоя, (2) 4.3.9 — переинициализация DI/`create_app` для использования новых реализаций очереди/сервисов, (3) 4.5.9 — реализация `StatsService` и хранилища для агрегаций статистики.
- **Замечания.** Основные риски связаны с тем, что текущие стабы очереди, воркера и сервисов не взаимодействуют с БД и не записывают обработку: без этих доработок выполнение подпунктов 4.2–4.7 блокируется.

## 4.2 Реализовать очередь на PostgreSQL
### Декомпозиция
- 4.2.5 охватывает две разные ответственности: сбор метрик загрузки очереди/воркеров и реакцию ingest API на превышение лимитов. Стоит выделить отдельный подпункт для HTTP-уровня (например, «4.2.5b Проброс ограничений в Ingest API/JobService»), оставив «4.2.5a» для счётчиков активных задач в базе.

### Дополнительные таски
- **4.2.9 Подключить драйвер PostgreSQL.** В текущем `PostgresJobQueue` отсутствует фактическая работа с БД (все методы, кроме `enqueue`, заглушены), поэтому нужно оформить выделенный пункт на внедрение `psycopg`/SQLAlchemy, управление пулами соединений и транзакциями.【F:src/app/infrastructure/queue/postgres.py†L1-L60】

### Замечания
- До реализации 4.2.* `DefaultJobService.acquire_next_job` и `mark_finalized` остаются `NotImplemented`, поэтому интеграционные тесты воркера не смогут выполниться без параллельной доработки сервиса.【F:src/app/services/default.py†L114-L195】
- Миграция `processing_logs` критична для задач 4.3.6 и 4.5.6: без неё невозможно записывать ProcessingLog и строить статистику.

## 4.3 Разработать воркеры обработки задач
### Декомпозиция
- Существующих подпунктов достаточно, поскольку они уже делят запуск, обработку, провайдера, TTL и тесты.

### Дополнительные таски
- **4.3.9 Обновить DI и `create_app`.** После реализации очереди и воркера нужно переподключить зависимости так, чтобы API и фоновые задачи использовали новые реализации, а не in-memory стабы, которые сейчас регистрируются в `ServiceRegistry` при старте приложения.【F:src/app/core/app.py†L31-L79】

### Замечания
- Текущий `QueueWorker` синхронно вызывает `asyncio.run` для провайдеров; при переходе к реальному асинхронному провайдеру стоит убедиться, что воркер выполняется в отдельном потоке/процессе и не блокирует event loop HTTP-сервера.【F:src/app/workers/queue_worker.py†L91-L205】
- Методы `JobService.append_processing_logs` и `refresh_recent_results` пока пустые, поэтому при финализации придётся синхронно закрывать задачи 4.3.6 и 4.4.2.【F:src/app/services/default.py†L191-L195】

## 4.4 Настроить хранение результатов и публичные ссылки
### Декомпозиция
- Подпункты уже разбивают задачи по сохранению файлов, обновлению JobService, публичному API, очистителю, тестам и документации — дополнительная декомпозиция не требуется.

### Дополнительные таски
- Не требуются: существующие подпункты покрывают потребности.

### Замечания
- `DefaultMediaService` оперирует локальной файловой системой; при внедрении 4.4.1–4.4.4 нужно убедиться, что структура директорий `MEDIA_ROOT` создана и что очиститель не удаляет payload до завершения отдачи результата.【F:src/app/services/default.py†L68-L112】
- Реализация 4.4.2 зависит от завершения методов `JobService.finalize_job` и `clear_inline_preview`.

## 4.5 Разработать Admin API
### Декомпозиция
- Подпункты детализируют ключевые эндпоинты и тесты; дополнительное дробление можно делать уже в рамках реализации (например, внутри 4.5.4 по операциям), но на уровне плана это не обязательно.

### Дополнительные таски
- **4.5.9 Реализовать `StatsService` и хранилище статистики.** Сейчас сервис полностью абстрактный; без его реализации эндпоинты `/api/stats/*` и метрики из 4.7.* останутся пустыми. Предлагаю вынести отдельный подпункт для внедрения репозитория и агрегаций на базе `processing_logs`.【F:src/app/services/stats_service.py†L1-L20】

### Замечания
- Требуется синхронизация с задачами 4.6.* по хранению хэшей и выдаче JWT: `/api/login` должен использовать тот же механизм паролей/ролей, что и `SettingsService`/ingest.
- CRUD шаблонных медиа (4.5.5) зависит от `MediaService` и будущих миграций для хранения шаблонов.

## 4.6 Добавить авторизацию и безопасность
### Декомпозиция
- Список подпунктов покрывает ключевые аспекты (хранение хэшей, JWT, роли, аудит, тесты); дополнительное дробление не требуется.

### Дополнительные таски
- Не выявлены.

### Замечания
- Стоит заранее зафиксировать, какие алгоритмы/параметры хэширования поддерживаются (например, `bcrypt` vs `pbkdf2`), чтобы синхронизировать с настройками, используемыми в `DefaultSettingsService` и будущих миграциях.【F:src/app/services/default.py†L36-L49】

## 4.7 Внедрить логирование и метрики
### Декомпозиция
- Подпункты уже разделяют логи ingest, очередь/воркеры, метрики ingest/очисток и документацию. Дополнительная декомпозиция не требуется.

### Дополнительные таски
- Дополнительных пунктов не требуется, но реализация 4.5.9 критична для сбора статистики.

### Замечания
- Нужно определиться с конкретным стеком метрик (Prometheus-интеграция, push в StatsService). Это следует описать в 4.7.5, чтобы не возникло расхождений с NFR из roadmap.

## 4.8 Синхронизировать артефакты и решения
### Декомпозиция
- Текущие подпункты (контракты, ADR, синхронизация мемори) достаточно атомарны.

### Дополнительные таски
- Не требуются.

### Замечания
- 4.8.1 потребует пересмотра OpenAPI после внедрения Admin API и публичных ссылок, поэтому стоит планировать время на обновление версий контрактов.

## 4.9 Восстановить тестовое окружение и CI
### Декомпозиция
- Подпункты 4.9.1 и 4.9.2 уже охватывают фиксацию зависимостей и прогон тестов.

### Дополнительные таски
- Не требуются.

### Замечания
- После появления реальной очереди/БД понадобится подготовить docker-compose/инструкции для локального Postgres, чтобы разработчики могли прогонять тесты contract/integration без ручной настройки.
