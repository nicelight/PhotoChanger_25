# Политика управления глобальными настройками

## Контракт сервиса
Сервис `SettingsService` предоставляет синхронный контракт для администраторов:

- `get_settings()` возвращает агрегированный снимок настроек. Значение кешируется в памяти и перечитывается из репозитория только по явному `force_refresh`.
- `update_settings(payload, updated_by)` применяет изменения конфигурации и обновляет связанные TTL.
- `rotate_ingest_password(rotated_at, updated_by, new_password=None)` пересчитывает хэш DSLR-пароля. При отсутствии пароля создаётся новый через `SecurityService.generate_password()`; метод возвращает кортеж из обновлённых настроек и чистого пароля для администратора.

## Проверка прав
Для чувствительных операций (`update_settings`, `rotate_ingest_password`) выполняется явная авторизация. Сервис принимает функцию `authorize(actor)` и выбрасывает `PermissionError`, если пользователь не имеет доступа. Чтение настроек доступно всегда.

## Обновление TTL
При изменении `sync_response_timeout_sec` сервис автоматически приводит к новому значению:

- `Settings.ingest.ingest_ttl_sec`
- `Settings.media_cache.public_link_ttl_sec`

Тем самым выдерживаются контрактные зависимости TTL из доменной модели.

## Аудит
Все операции записи фиксируются через `AuditLogger`:

- `settings.update` — при успешном обновлении конфигурации.
- `settings.rotate_ingest_password` — при смене пароля, с меткой времени ротации.

Аудит работает независимо от типа репозитория (встроенный `DefaultSettingsService` сохраняет события в памяти).

## Сброс кешей
После любой операции записи кеш настроек и хэша пароля очищается. Дополнительно может быть передан колбэк `cache_invalidator`, который уведомляет внешние слои (например, REST-кеш или воркеров) о необходимости перечитать настройки.

## Хэширование и валидация пароля
`SecurityService` инкапсулирует PBKDF2-хэширование и генерацию случайных паролей. Хэш хранится в `SettingsRepository`, а проверка пароля выполняется через `verify_ingest_password` без раскрытия исходного значения.
