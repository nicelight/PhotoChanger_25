# Статистика админ-панели

## Модели агрегаций

`src/app/schemas/stats.py` определяет единый набор структур для работы с
агрегированной статистикой:

- `StatsWindow` — перечисление поддерживаемых окон агрегации (`day`, `week`).
- `StatsCounters` — нормализованный набор счётчиков (успешные задачи, таймауты,
  ошибки провайдера, отмены, ошибки воркера, количество ingest-запросов).
  Вспомогательные методы позволяют безопасно приводить словари репозитория к
  модели и суммировать значения.
- `StatsMetric` — точка временного ряда с границами периода и счётчиками.
- `StatsSummary` — сводка, которую напрямую потребляет API. Поле `total_runs`
  считается на основе успешных/неуспешных запусков, дополнительное свойство
  `failure_count` упрощает отображение доли неудач.
- `StatsAggregation` — контейнер для результатов за конкретное окно, включает
  список метрик и готовую сводку.

Эти структуры используют `slots=True`, чтобы исключить случайное добавление
полей и уменьшить накладные расходы при сериализации.

## CachedStatsService

`src/app/services/stats.py` реализует `CachedStatsService`, который опирается на
интерфейс `StatsRepository` и кэш с TTL:

- Поддерживаются окна `day` и `week`, выбираемые через параметр `window`.
- При запросе глобальной или слотовой статистики сервис формирует ключ вида
  `(slot_id, window, since)` и проверяет кэш. Время жизни задаётся параметром
  `ttl` (по умолчанию 60 секунд). TTL `0` отключает кэширование.
- Методы `collect_global_stats` и `collect_slot_stats` возвращают экземпляры
  `StatsAggregation`. Сводка вычисляется на основании метрик, полученных из
  репозитория.
- При вызове `record_processing_event` сервис пытается передать лог в
  `StatsRepository.store_processing_log` (если метод реализован) и инвалидирует
  все записи кэша для соответствующего слота, а также глобальные агрегаты.

Внутри сервис использует настраиваемый `clock`, что упрощает тестирование TTL.
Негативные значения TTL запрещены — выбрасывается `ValueError`.

## Интеграция с воркерами и JobService

Очередь воркеров (`QueueWorker`) уже публикует события через метод
`StatsService.record_processing_event`. Благодаря новой реализации сервис
автоматически инвалидирует кэш и, при наличии репозитория, сохраняет лог для
дальнейшей агрегации. `JobService.append_processing_logs` продолжает писать
данные в очередь, а `StatsService` подписывается на те же события для обновления
статистики.

## Тесты

`tests/unit/services/test_stats_service.py` покрывает основные сценарии:

- построение сводки из результатов репозитория,
- попадание/промахи кэша в зависимости от TTL,
- инвалидация кэша при поступлении новых логов, включая глобальные и
  слотовые ключи,
- делегирование сохранения логов в `StatsRepository`.

Тесты используют заглушку репозитория и настраиваемые временные метки, что
позволяет моделировать различные окна и сценарии без обращения к БД.
