# План генерации кода PhotoChanger с помощью LLM

## Этап 0. Подготовка контекста для LLM
- Собрать входные материалы: Docs/brief.md, spec/contracts/openapi.yaml, JSON Schema в spec/contracts/schemas, описания провайдеров в spec/contracts/providers, черновики ADR и текущий код в src/app.
- Зафиксировать целевые артефакты и Definition of Done из agents.md, уточнить ограничения по безопасности, логированию и хранению медиа.
- Составить шаблонные промпты для генерации модулей (API, домен, очередь, UI), включая перечисление сущностей, эндпоинтов, требований к TTL и SLA.
- Описать формат выхода, который должен выдавать LLM (структура файлов, сигнатуры классов, комментарии с пометками технологии).

## Этап 1. Генерация стабов и инфраструктуры
- Проверить существующие заглушки в src/app; сформировать список недостающих файлов по каждому пакету.
- Подготовить серию промптов для LLM на генерацию недостающих стабов контроллеров, сервисов, провайдерских адаптеров и инфраструктурных компонентов очереди согласно OpenAPI и схемам.
- Автоматизировать проверку синтаксиса и импортов после генерации (ruff/flake8, mypy) для оперативного отката невалидного кода.
- Обновить индекс стабов и убедиться, что каждый контрактный маршрут и доменная модель имеют соответствующую заглушку.

## Этап 2. Контрактные и модульные тесты
- Сформировать промпты для генерации контрактных тестов API на основе схем и описаний статусов.
- Попросить LLM подготовить моки провайдеров (Gemini, Turbotext) с режимами успеха, таймаута, ошибки и ограничениями по MIME.
- Сгенерировать unit-тесты для критичных доменных функций (расчёт TTL, валидация параметров слота, правила очистки хранилища).
- Настроить запуск тестов в CI-скрипте и зафиксировать базовый отчёт, чтобы последующие фичи держались на зелёных тестах.

## Этап 3. Реализация серверной логики
- Разбить реализацию на независимые батчи: ingest и очередь, управление слотами, статистика и результаты, авторизация.
- Для каждого батча подготовить промпт с описанием входов, выходов, последовательностей и обязательных проверок, ссылаться на сгенерированные стабы и тесты.
- Сгенерировать код, интегрировать его вручную, устранить конфликты, дополнить отсутствующие элементы (например, DI, настройки логгера).
- После каждой итерации запускать контрактные и unit-тесты, фиксировать итоги в CHANGELOG или описании PR.

## Этап 4. Интеграция провайдеров и внешних сервисов
- Подготовить расширенные промпты для генерации адаптеров Gemini и Turbotext, включая обработку таймаутов, квот и повторных попыток.
- Сгенерировать клиентские обёртки и конфигурацию секретов, добавить параметризацию для разных окружений.
- Создать сценарии интеграционных тестов с моками, убедиться, что интерфейсы адаптеров соблюдают ожидаемые исключения и коды возврата.
- Задокументировать конфигурацию провайдеров и процесс обновления токенов в Docs/providers.

## Этап 5. UI и админ-панель
- Проверить существующие наработки в Docs/frontend-examples и определить недостающие страницы.
- Сгенерировать каркасы страниц списка слотов, формы слота, галереи результатов и статистики, не внедряя бизнес-логику до готовности API.
- Настроить взаимодействие UI с API через заранее описанные контракты, добавить состояния загрузки, ошибок и истечения TTL.
- Собрать инструкции по локальной сборке UI и интегрировать их в README.

## Этап 6. Нефункциональные требования и эксплуатация
- Сгенерировать модули метрик, логирования, rate limiting и очистки хранилищ согласно NFR из брифа.
- Автоматизировать проверку безопасности: конфигурация TLS, маскирование секретов, политика хранения временных файлов.
- Настроить оповещения и health-check эндпоинты, подготовить инструкции по мониторингу для эксплуатации.
- Сформировать финальный чек-лист перед релизом: p95 по ingest, доля 504, успешность очистки, консистентность данных.

## Этап 7. Поддержка и развитие
- Описать процесс Re-Sync при обновлении брифа: мониторинг изменений, обновление контрактов, регенерация стабов и тестов.
- Запланировать фичи второго этапа: новые провайдеры, расширенный UI, автоматическая очистка и архивирование результатов.
- Подготовить шаблон PR и шаблоны задач, чтобы последующие доработки также выполнялись через LLM в соответствии с SDD-воротами.
