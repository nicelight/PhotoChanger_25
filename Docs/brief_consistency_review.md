# Проверка брифа PhotoChanger на консистентность

## Итог
Бриф в целом последовательно описывает целевую архитектуру, доменные сущности и ожидаемые API. Большинство ограничений и потоков данных расписаны достаточно подробно, чтобы стартовать подготовку спецификаций. Тем не менее выявлены отдельные зоны, где формулировки стоит уточнить до начала SDD-цикла.

## Наблюдения
- Архитектура "асинхронного моста", статический пул из 15 ingest-слотов и правила TTL для исходных/результирующих файлов описаны единообразно, увязываются с моделью очереди и временным хранилищем.【F:Docs/brief.md†L17-L89】【F:Docs/brief.md†L480-L565】
- Набор внутренних API (аутентификация, слоты, статистика, медиа-хранилище, настройки) и внешний ingest-эндпоинт заданы детально: указываются права доступа, форматы запросов/ответов, коды ошибок и ограничения по MIME/размеру.【F:Docs/brief.md†L95-L408】【F:Docs/brief.md†L960-L1313】
- Конфигурационная модель провайдеров и операций (providers.json + settings_json) формирует чёткую основу для генерации JSON Schema и OpenAPI.【F:Docs/brief.md†L608-L899】

## Потенциальные вопросы и риски
1. **Очистка результатов раньше TTL.** В начале документа фиксируется правило "обработанные фотографии удаляются спустя 3 дня" (TTL результата). Позже описанный `POST /api/media/cache/purge` удаляет файлы `Result`, даже если `expires_at` ещё не наступил. Нужно явно оговорить, является ли purge административным override, нарушающим 3-дневную гарантию, и как это отражать в UI/спеке ошибок.【F:Docs/brief.md†L17-L20】【F:Docs/brief.md†L560-L607】
2. **Доступ воркеров к медиа-API.** Для `POST /api/media/register`/`extend` требуется JWT с правом `slots:write`, однако воркеры вызывают эти методы автоматически перед постановкой задач. Нужен уточнённый механизм авторизации сервиса (service token, технический пользователь) либо разрешение на вызов без пользовательского JWT.【F:Docs/brief.md†L95-L199】【F:Docs/brief.md†L512-L565】
3. **Лимиты MIME и форматов.** `MEDIA_ALLOWED_MIME` ограничен JPEG/PNG/WEBP, но ingest-сценарий и Gemini допускают HEIC/HEIF. В тексте упомянуто, что для провайдеров с публичными ссылками список сужается, однако стоит проверить, не требуется ли аналогичное ограничение для шаблонных медиа (при `requires_public_media=true`). Иначе UI/валидация могут расходиться для HEIC/HEIF-шаблонов.【F:Docs/brief.md†L95-L199】【F:Docs/brief.md†L640-L720】
4. **Управление ретраями.** Раздел механики упоминает экспоненциальные ретраи до N попыток, но сценарий `failed_timeout` формулирует "ретраи запрещены". Вероятно, имеется в виду запрет на повторный ingest после фиксации таймаута, но стоит уточнить wording, чтобы избежать двусмысленности при описании FSM `Job` и политик ретраев в спеках.【F:Docs/brief.md†L31-L57】
5. **Возврат бинарного тела в ingest.** Ответ `POST /ingest/{slotId}` описан как бинарное изображение без явного JSON-обёртки. Для OpenAPI и тестов нужно подтвердить, что ошибки всегда JSON, а успешные ответы — `image/*`, и уточнить, требуется ли описывать разновидности контента (jpeg/png/webp) или достаточно обобщённого `image/*`. Это повлияет на контракт-тесты и клиентские генераторы.【F:Docs/brief.md†L1183-L1313】

## Вывод
Бриф почти готов к старту разработки спецификаций. Перед началом SDD стоит получить ответы на указанные вопросы, чтобы избежать расхождений в гарантиях хранения, авторизации сервисов и описании контента для ingest. После уточнений можно переходить к подготовке OpenAPI и JSON Schema.
