# Провайдер Turbotext (фото-API)

> Источник: [Официальная документация Turbotext Photo AI](https://www.turbotext.ru/photo_ai/docs/info) (раздел «Фото - методы»).

## Аутентификация и базовый протокол

- **Хост**: `https://www.turbotext.ru`.
- **Тип запросов**: `POST` с `Content-Type: application/x-www-form-urlencoded`.
- **Авторизация**: заголовок `Authorization: Bearer {APIKEY}` обязателен для всех вызовов.
- **Шаг 1 — создание очереди**: передать `do=create_queue` и параметры операции. Успешный ответ `{"success":true,"queueid":<ID>}`.
- **Шаг 2 — опрос результата**: запрос с `do=get_result` и `queueid`. Пока генерация не готова, сервис возвращает `{"action":"reconnect"}`; после завершения — JSON с `success=true`, блоком `data` и ссылкой `uploaded_image` на готовый файл.
- **Webhook**: если добавить `webhook=https://…` при создании очереди, вместо ожидания ответа возвращается `{"success":true,"asyncid":<ID>}`. После обработки Turbotext делает `POST` на указанный URL с тем же JSON, что и при ручном опросе (`do=get_result`).
- **Хранение файлов**: входные изображения должны быть доступны по публичным HTTPS/HTTP URL (например, через временное медиа-хранилище платформы). Готовый результат скачивается по ссылке из поля `uploaded_image`.

## Операции

### Обработка фото (`/api_ai/generate_image2image`)

| Параметр | Тип | Обязательность | Описание |
| --- | --- | --- | --- |
| `url` | string (URL) | required | Ссылка на исходное изображение (форматы: JPG/PNG/WEBP). |
| `content` | string | required | Текстовый промпт, описывающий желаемые изменения. |
| `strength` | integer | optional (`0–80`, default `40`) | Степень изменения исходной картинки. |
| `seed` | integer | optional (`1–10^10`, default random) | Фиксирует детерминированность результата. |
| `scale` | float | optional (`0.1–20`, default `7.5`) | Guidance scale. |
| `negative_prompt` | string | optional | Что нужно исключить (до ~80 слов). |
| `original_language` | string | optional (default `ru`) | Язык исходного промпта. |
| `user_id` | integer | optional (default `1`) | Служебный идентификатор аккаунта Turbotext. |

**Ответ**: после `do=get_result` Turbotext возвращает `data.image` (массив путей, например `"image/generate_image2image_id12_0.png"`), промпт и параметры генерации, а также `uploaded_image` с прямой ссылкой на результат.

### Метод «Микс-фото» (`/api_ai/mix_images`)

| Параметр | Тип | Обязательность | Описание |
| --- | --- | --- | --- |
| `url_image_target` | string (URL) | required | Фото, в которое переносится стиль/сочетается изображение. |
| `url` | string (URL) | required | Фото-источник стиля. |
| `content` | string | optional | Дополнительное текстовое описание эффекта. |

**Ответ**: блок `data` содержит сведения о ширине/высоте, `prompt`, `strength`, `pattern_prompt`; итоговая ссылка — в `uploaded_image`.

### Замена лица (`/api_ai/deepfake_photo`)

| Параметр | Тип | Обязательность | Описание |
| --- | --- | --- | --- |
| `url` | string (URL) | required | Фото человека, которому требуется заменить лицо. |
| `url_image_target` | string (URL) | required | Фото с лицом, которое нужно перенести. |
| `face_restore` | boolean (`True/False`) | optional | Включает дообработку лица после подстановки. |

**Ответ**: `data.image` содержит массив ссылок на результат (обычно одно изображение) с признаками `width`, `height`, `face_restore`; публичная ссылка на файл возвращается в `uploaded_image`.

## Особенности интеграции

- Все методы работают через очередь: платформа должна хранить `queueid` (или `asyncid`) и сопоставлять его с задачей в своей очереди.
- Поле `action="reconnect"` при опросе означает, что нужно повторить `do=get_result` через интервал (например, 2–3 секунды).
- При использовании вебхуков сервис не повторно отправляет данные: потребуется самостоятельно обрабатывать повторные вызовы и подтверждать получение (возвращать HTTP 200).
- Turbotext считает каждую операцию «Фото попыткой», поэтому биллинг и квоты должны учитывать количество обращений к API.
- Входные ссылки должны указывать на изображения с MIME из `MEDIA_ALLOWED_MIME` (JPEG/PNG/WEBP). Остальные форматы (например, HEIC/HEIF)
  необходимо отклонять до обращения к API Turbotext, иначе сервис вернёт ошибку формата.

## Ссылки

1. [Основы работы с API Turbotext — Фото методы](https://www.turbotext.ru/photo_ai/docs/info)
