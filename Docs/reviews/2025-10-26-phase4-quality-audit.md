# Аудит качества Фазы 4 — 2025-10-26

## Исполнительное резюме
- **Проверенный охват:** задачи 4.1–4.7 из `.memory/TASKS.md` сопоставлены с миссией PhotoChanger, чертежами и политиками качества. Конечная точка ingest обеспечивает требуемое синхронное поведение, однако уровни очереди, воркера, админ-панели, безопасности и наблюдаемости остаются заготовками без промышленной реализации.【F:.memory/TASKS.md†L8-L69】【F:spec/docs/blueprints/domain-model.md†L15-L88】【F:src/app/api/routes/ingest.py†L244-L618】
- **Вердикт готовности:** Фаза 4 **не готова** к приёмке. Критические пробелы существуют в обработке очереди PostgreSQL, финализации задач, хранении результатов, админской аутентификации и мониторинге. Это нарушает инварианты SDD по дедлайнам, TTL и операционному контролю.【F:spec/docs/blueprints/domain-model.md†L54-L88】【F:src/app/infrastructure/queue/postgres.py†L28-L60】【F:src/app/services/default.py†L164-L195】【F:src/app/api/routes/public.py†L1-L33】【F:src/app/api/routes/settings.py†L26-L72】【F:src/app/api/routes/dependencies.py†L1-L9】【F:src/app/services/stats_service.py†L1-L24】
- **Статус тестирования:** Статический анализ Ruff проходит, но MyPy и pytest не стартуют из‑за отсутствующих зависимостей (FastAPI, Pydantic, httpx), что противоречит прогресс-логу о «зелёных» пайплайнах Фазы 4. Необходима установка зависимостей или подготовка тестовых образов перед сертификацией.【F:.memory/PROGRESS.md†L8-L26】【489546†L1-L11】【bb8c39†L1-L11】【7d1fc7†L1-L32】【8f7039†L1-L17】【2cbeb1†L1-L11】

## Глобальные проверки согласованности
- **SemVer / контракты:** `spec/contracts/VERSION.json` всё ещё содержит `0.1.2` от 2025-10-16, отражающий только изменения Фазы 3. Поведение Фазы 4 не версионировано, поэтому выпуск новых функций нарушит SemVer без обновления версии.【F:spec/contracts/VERSION.json†L1-L28】
- **ADR:** `.memory/DECISIONS.md` перечисляет лишь ADR-0001/0002; решения по очереди, воркеру и безопасности отсутствуют, несмотря на архитектурные сдвиги, подразумеваемые задачами Фазы 4.【F:.memory/DECISIONS.md†L1-L41】
- **Заявления о прогрессе:** `.memory/PROGRESS.md` сообщает о завершении и тестировании ingest, воркера и синхронного пайплайна 22–25 октября 2025, но код остаётся заглушечным (см. выводы по задачам ниже), что указывает на рассинхрон документации и реализации.【F:.memory/PROGRESS.md†L8-L26】
- **Доска задач:** `.memory/TASKS.md` помечает подзадачи 4.1 как завершённые, а 4.2–4.7 — незавершёнными, что соответствует реальному состоянию (ingest реализован, остальные компоненты — нет).【F:.memory/TASKS.md†L8-L69】
- **Контроль фаз:** проверено, что фазы 5–8 сфокусированы на интеграции провайдеров, UI и эксплуатационных НФТ, не содержащих серверных задач 4.2–4.7; следовательно, перечисленные пробелы нельзя переносить на последующие этапы и их необходимо закрыть в рамках Фазы 4.【F:.memory/TASKS.md†L71-L134】
- **Гигиена секретов:** Явные креды не обнаружены; дефолтный hash ingest зашит по чертежу и остаётся константой-заглушкой.【F:src/app/core/app.py†L32-L69】

## Выводы по задачам
### 4.1 — Завершение Ingest API
- **Соответствие контракту:** `/ingest/{slotId}` проверяет пароль, существование слота, допустимые MIME-типы, лимиты на размер payload и насыщение очереди, сопоставляя ответы 200/400/401/404/413/415/429/503/504 со структурированными логами.【F:src/app/api/routes/ingest.py†L244-L562】
- **Окно ожидания:** Обработчик опрашивает `JobService.get_job` до истечения `T_sync_response` и возвращает 504 с `failure_reason = timeout`, что удовлетворяет синхронным требованиям SDD.【F:src/app/api/routes/ingest.py†L330-L418】【F:spec/docs/blueprints/domain-model.md†L54-L88】
- **Очистка:** Инлайновые превью очищаются, временные payload удаляются после ответа, что согласуется с TTL-инвариантами.【F:src/app/api/routes/ingest.py†L330-L618】
- **Блокирующие пробелы:** Конвейер ingest опирается на заглушки `PostgresJobQueue` и `DefaultJobService.finalize_job`; после выхода из обработчика выполнение остановится.【F:src/app/infrastructure/queue/postgres.py†L28-L60】【F:src/app/services/default.py†L167-L195】
- **Тестирование:** Contract/unit-тесты ingest падают на импорте FastAPI; установка FastAPI/Pydantic/httpx (или включение их в тестовый образ) обязательна перед приёмкой.【489546†L1-L11】【bb8c39†L1-L11】

### 4.2 — Реализация очереди PostgreSQL
- **Слой репозитория:** `PostgresJobQueue.acquire_for_processing`, `mark_finalized` и `release_expired` бросают `NotImplementedError`, поэтому SKIP LOCKED, очистка по TTL и back-pressure отсутствуют.【F:src/app/infrastructure/queue/postgres.py†L28-L60】
- **Схема и миграции:** Нет миграций для `jobs` / `processing_logs`; таблицы и индексы из чертежа не реализованы.【F:spec/docs/blueprints/domain-model.md†L5-L50】
- **Метрики / back-pressure:** Код не публикует метрики глубины очереди или сигналы конкуренции; ingest полагается лишь на заглушки исключений.【F:src/app/services/default.py†L121-L175】

### 4.3 — Исполнение воркера и диспетчеринг провайдеров
- **Жизненный цикл диспетчеризации:** `QueueWorker` регистрирует фабрики провайдеров и заявляет цепочку prepare → submit → poll → cancel со скелетом логирования.【F:src/app/workers/queue_worker.py†L60-L357】
- **Отсутствие персистентности:** `DefaultJobService.finalize_job`, `append_processing_logs` и `acquire_next_job` не реализованы, поэтому успешные и аварийные пути не сохраняют состояние, ломая гарантии TTL и ленты результатов.【F:src/app/services/default.py†L164-L195】
- **Метрики:** `StatsService.record_processing_event` поднимает `NotImplementedError`, поэтому воркер не эмитирует данные наблюдаемости.【F:src/app/services/stats_service.py†L1-L24】

### 4.4 — Хранение результатов и публичные ссылки
- **Персистентность результата:** В `DefaultJobService.finalize_job` нет логики вычисления чек-суммы, установки `result_expires_at` или записи путей к файлам, что нарушает требования TTL.【F:src/app/services/default.py†L167-L195】【F:spec/docs/blueprints/domain-model.md†L20-L88】
- **Публичные конечные точки:** `/public/results/{job_id}` и маршруты скачивания медиа возвращают `endpoint_not_implemented`; потоки 200/410 и фоновые очистки отсутствуют.【F:src/app/api/routes/public.py†L1-L33】
- **Очистка:** Нет фоновой задачи для удаления просроченных результатов или отзывов медиа сверх best-effort очистки ingest.【F:src/app/services/media_service.py†L1-L35】【F:src/app/services/default.py†L75-L112】

### 4.5 — Админский API
- **Аутентификация:** `/api/login`, `/api/settings`, `/api/slots`, `/api/stats` возвращают заглушки, не выдают JWT, не выполняют проверку прав, ETag или валидацию схем.【F:src/app/api/routes/auth.py†L1-L22】【F:src/app/api/routes/settings.py†L26-L72】【F:src/app/api/routes/slots.py†L27-L107】【F:src/app/api/routes/stats.py†L22-L111】
- **Ограждение зависимостей:** `require_bearer_authentication` всегда возвращает `False`, полностью блокируя авторизованный доступ.【F:src/app/api/routes/dependencies.py†L1-L9】
- **Тесты:** Админ-специфичных unit/contract-тестов сверх заготовок Фазы 3 нет.

### 4.6 — Усиление авторизации и безопасности
- **Работа с кредами:** Проверка пароля ingest использует PBKDF2, но админ-хранилище, конфигурация JWT и троттлинг не реализованы, что нарушает объём Фазы 4.【F:src/app/services/default.py†L36-L95】【F:src/app/api/routes/auth.py†L1-L22】
- **Журналы безопасности:** Логи аутентификации и ролей отсутствуют; покрытие есть только в ingest.【F:src/app/api/routes/ingest.py†L244-L618】
- **Документация:** Новые инструкции по ротации паролей и троттлингу не добавлены.

### 4.7 — Логирование и наблюдаемость
- **Структурные логи:** Структурированные логи есть только в ingest; очереди/воркер/админ интерфейсы не покрыты, что противоречит целям наблюдаемости.【F:src/app/api/routes/ingest.py†L244-L618】【F:src/app/workers/queue_worker.py†L180-L357】
- **Метрики:** `StatsService` не реализован, поэтому задержки, таймауты и использование хранилища не отслеживаются.【F:src/app/services/stats_service.py†L1-L24】
- **Документация:** Руководства по эксплуатации и мониторингу в `Docs/operations` не обновлены под Фазу 4.

## Документация и операционные артефакты
- README и операционные гайды не описывают миграции PostgreSQL, фоновые воркеры или экспортеры метрик; новое поведение ingest документировано только в комментариях коду.【F:src/app/infrastructure/queue/postgres.py†L28-L60】【F:src/app/services/default.py†L121-L195】
- `.memory/PROGRESS.md` заявляет успешные lint/type/test прогоны для ingest, но окружение лишено FastAPI/Pydantic/httpx, что показывает, что отчёты не актуализированы после изменения зависимостей.【F:.memory/PROGRESS.md†L23-L26】【489546†L1-L11】【7d1fc7†L1-L32】

## Журнал тестов и верификации
- ✅ `ruff check .`【63d9fd†L1-L2】
- ✅ `ruff format --check .`【717360†L1-L2】
- ❌ `mypy src/` — отсутствующие FastAPI/Pydantic/httpx останавливают анализ.【7d1fc7†L1-L32】
- ❌ `pytest -q tests/contract/test_ingest.py` — сбой импорта FastAPI блокирует контрактные тесты.【489546†L1-L11】
- ❌ `pytest -q -m unit -k ingest` — та же ошибка зависимостей FastAPI.【bb8c39†L1-L11】
- ❌ `pytest -q -m unit` — отсутствие FastAPI останавливает весь набор.【8f7039†L1-L17】
- ❌ `pytest -q -m contract` — отсутствие FastAPI останавливает набор.【2cbeb1†L1-L11】

## Риски и рекомендации
| Приоритет | Риск | Влияние | Рекомендация |
| --- | --- | --- | --- |
| Критический | Операции очереди не реализованы | Задачи нельзя извлечь, финализировать или очистить; нарушаются дедлайны и возникает риск утечки данных. | Реализовать методы `PostgresJobQueue` со SKIP LOCKED, очисткой по TTL и метриками конкуренции согласно чертежу, добавить миграции и тесты.【F:src/app/infrastructure/queue/postgres.py†L28-L60】【F:spec/docs/blueprints/domain-model.md†L54-L88】 |
| Критический | Отсутствует финализация воркера | Результаты провайдеров и ошибки не сохраняются, ломая гарантии ingest 200/504 и ленты галереи. | Завершить `DefaultJobService.finalize_job`, `append_processing_logs` и `acquire_next_job`; обеспечить расчёт checksum/TTL и интеграцию со `StatsService`.【F:src/app/services/default.py†L121-L195】【F:src/app/services/stats_service.py†L1-L24】 |
| Высокий | Заглушки админ/безопасности | Админский API непригоден; нет аутентификации и управления конфигурацией. | Реализовать `/api/login`, bearer auth, логику settings/slots/stats и соответствующие тесты; добавить документацию по JWT и ротации ключей.【F:src/app/api/routes/auth.py†L1-L22】【F:src/app/api/routes/settings.py†L26-L72】【F:src/app/api/routes/dependencies.py†L1-L9】 |
| Высокий | Неполная выдача результатов | Публичные результаты нельзя получить или просрочить корректно, что нарушает SLA. | Реализовать хранение результатов (checksum, TTL) и потоки 200/410 для `/public/results/{job_id}` с фоновыми очистками и тестами.【F:src/app/services/default.py†L167-L195】【F:src/app/api/routes/public.py†L1-L33】 |
| Высокий | Отсутствие наблюдаемости | Мониторинг SLA и back-pressure невозможен. | Реализовать `StatsService`, добавить метрики и логи в очереди/воркеры/админ-флоу, документировать настройку мониторинга.【F:src/app/services/stats_service.py†L1-L24】【F:src/app/workers/queue_worker.py†L60-L357】 |
| Средний | Сбой тестового конвейера | Автоматическая регрессия не работает; низкая уверенность. | Вернуть зависимости FastAPI/Pydantic/httpx (или предоставить лёгкие заглушки) и повторно запустить pytest/mypy, обновив `.memory/PROGRESS.md` после успеха.【7d1fc7†L1-L32】【489546†L1-L11】 |
| Средний | Лаг документации | Ops-команда лишена инструкций по миграциям и очистке. | Обновить README/Docs под Фазу 4 (схема PostgreSQL, воркер, экспортеры метрик). |

## Гигиена репозитория
- Записи в мемори-банке по задачам и прогрессу требуется скорректировать после реализации, чтобы будущие аудиты опирались на корректную историю.【F:.memory/TASKS.md†L8-L69】【F:.memory/PROGRESS.md†L8-L26】
- Лишних артефактов и секретов не обнаружено; хэши зависимостей следует хранить вне репозитория.【F:src/app/core/app.py†L32-L69】

## Расширенные промпты по устранению проблем
1. **Очередь PostgreSQL и миграции**  
   «Проанализируй `spec/docs/blueprints/domain-model.md` и реализуй в `src/app/infrastructure/queue/postgres.py` методы `enqueue_job`, `acquire_for_processing`, `mark_finalized`, `mark_failed`, `release_expired` с использованием транзакций и `FOR UPDATE SKIP LOCKED`. Создай миграции для таблиц `jobs` и `processing_logs` с индексами по `status`, `available_at`, `job_id`. Подготовь unit- и integration-тесты, моделирующие конкурирующие воркеры, дедлайны и очистку просроченных записей.»
2. **Финализация воркера и журналирование обработки**  
   «Раскрой логику `DefaultJobService` так, чтобы воркер мог забирать задания, фиксировать этапы обработки и завершать их. Реализуй `acquire_next_job`, `append_processing_logs`, `finalize_job` с учётом контрольных сумм, TTL (`result_expires_at`), удаления временных payload и записи путей к медиа. Обеспечь идемпотентность и покрытие тестами сценариев успеха, таймаута и отмены.»
3. **Админский API и безопасность**  
   «Внедри полноценный поток аутентификации: PBKDF2-хранение админских паролей, выдачу JWT с корректными сроками действия и обновлением секретов. Реализуй маршруты `/api/login`, `/api/settings`, `/api/slots`, `/api/stats/*`, `/api/recent_results` с проверкой ролей, ETag и схемами ответов. Добавь rate limiting и негативные тесты (401/403/429). Обнови документацию по управлению ключами.»
4. **Публичная выдача результатов и очистка**  
   «Допиши `MediaService` и публичные маршруты так, чтобы `/public/results/{job_id}` возвращал 200 при наличии свежего результата, 410 — при истечении TTL, и 404 — если job не существует. Реализуй фоновый планировщик, удаляющий просроченные медиа и записи. Проведи тесты на хранение чек-сумм, TTL и идемпотентную очистку.»
5. **Наблюдаемость и метрики**
   «Реализуй `StatsService` для сбора latency, активных задач, таймаутов и повторов провайдеров. Добавь структурированные логи в очередь, воркер и админские обработчики, исключая бинарные payload. Интегрируй метрики с существующей инфраструктурой мониторинга и обнови Ops-документацию по подключению дашбордов.»
6. **Тестовый конвейер и зависимости**  
   «Обнови окружение разработки и CI: зафиксируй версии FastAPI, Pydantic, httpx и прочих зависимостей, восстанови виртуальное окружение. Настрой запуск `mypy`, `pytest -m unit`, `pytest -m contract`, ingest-интеграций и зафиксируй успешные логи в `.memory/PROGRESS.md`. Убедись, что тесты охватывают новые сценарии очереди, воркера, админа и публичного доступа.»
7. **Документация и ADR**  
   «Подготовь обновления в README, Docs/operations и ADR: задокументируй миграции, фоновые сервисы, мониторинг и процедуры ротации секретов. Обнови `.memory/DECISIONS.md` и добавь новые ADR для решений по очереди, воркеру, безопасности и наблюдаемости. Синхронизируй `.memory/TASKS.md`, `.memory/PROGRESS.md`, `.memory/INDEX.yaml` после внесения изменений.»
