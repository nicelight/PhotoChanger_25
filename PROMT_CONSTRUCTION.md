# Анализ Issues PhotoChanger

## 1. Входящий ingest и таймауты
- **Необходимость фикса:** требуется.
- **Важность:** 5/5.
- **Обоснование:** Жёсткий дедлайн `T_sync_response` ≤ 50 с зафиксирован в брифе; без централизованной отмены API нарушит требование об обязательном 504 и очистке данных после таймаута, что ведёт к несогласованности статусов `Job` и утечке ресурсов. Требуется единый контракт дедлайнов при переключении между `asyncio.Queue` и PostgreSQL, чтобы гарантировать соответствие окну ожидания и TTL временных файлов; валидатор должен допускать неизвестные поля от DSLR Remote Pro, иначе ingest будет падать при обновлении клиента.
- **Рекомендуемые действия:** внедрить механизм отмены воркеров при истечении `T_sync_response`, синхронизировать дедлайны и back-pressure между режимами очереди, обновить валидатор входящих данных для игнорирования незнакомых ключей.
- **Промпт Codex Cloud:**
  ```
  Контекст: проект PhotoChanger, см. /Docs/brief.md. Требуется реализовать централизованную отмену ingest-задач по наступлении T_sync_response и унифицированный дедлайн для asyncio.Queue и PostgreSQL режима, а также скорректировать валидатор DSLR Remote Pro для игнорирования неизвестных полей.
  Задачи:
  1. Обнови контракты (contracts/openapi.yaml, schemas) при необходимости отражая правила 504 и отмены.
  2. Добавь в очередь и воркер механизм отмены/очистки, гарантируя, что по таймауту Job получает статус failed_timeout и временные файлы удаляются.
  3. Синхронизируй настройки дедлайнов и TTL для обоих режимов очереди.
  4. Измени ingest-валидатор, чтобы он принимал неизвестные поля в payload от DSLR Remote Pro.
  5. Покрой изменения тестами: таймаут приводит к 504 и отмене; валидация допускает новые поля.
  Выполни по SDD-процессу: сперва контракты, затем стабы, тесты и реализация.
  ```

## 2. Политика хранения медиа
- **Необходимость фикса:** требуется.
- **Важность:** 4/5.
- **Обоснование:** Бриф предъявляет строгие требования к TTL временных `media_object`, `Result` и шаблонов; отсутствие мониторинга и корректной очистки угрожает потерей результатов или утечкой шаблонов. Некорректный GC (`media.cache.purge`) может удалить свежие `Result` и нарушить SLA хранения 72 часа.
- **Рекомендуемые действия:** внедрить мониторинг TTL/очередей, разграничить операции удаления в соответствии с типами медиа, реализовать атомарный сборщик мусора, который чистит только просроченные временные ссылки.
- **Промпт Codex Cloud:**
  ```
  Контекст: требования по медиа из /Docs/brief.md (TTL media_object ≤ 60 c, Result = 72 ч). Нужно обеспечить контроль хранения и корректный GC.
  Задачи:
  1. Специфицируй и реализуй метрики/алерты по расходу TTL, размеру очередей и использованию MEDIA_ROOT.
  2. Раздели операции удаления для media_object, Result и template_media согласно матрице ответственности.
  3. Реализуй атомарный GC для /api/media/cache/purge: удаляем только просроченные media_object, не затрагивая свежие Result.
  4. Добавь тесты на корректность TTL и поведение GC.
  Следуй SDD: сначала обновление контрактов/схем, затем реализация через стабы и тесты.
  ```

## 3. Интеграции провайдеров
- **Необходимость фикса:** требуется.
- **Важность:** 5/5.
- **Обоснование:** Различные провайдеры используют уникальные требования по MIME и протоколам; без слот-специфичной валидации ingest нарушит требования и приведёт к отказам. Некорректное управление Turbotext polling/webhook вызовет дедлайны. Ошибки в `provider_overrides.field_map` опасны из-за дорогих отказов у внешних провайдеров.
- **Рекомендуемые действия:** внедрить провайдер-специфичную валидацию MIME, управление режимами Turbotext и генерацию тестируемых адаптеров/маппингов.
- **Промпт Codex Cloud:**
  ```
  Контекст: см. /Docs/brief.md и /Docs/providers для описания Gemini/Turbotext. Нужно синхронизировать интеграции.
  Задачи:
  1. Расширь схемы/контракты ingest так, чтобы валидатор MIME зависел от выбранного слота и провайдера.
  2. Реализуй корректное управление Turbotext: поддержка polling и webhook, атомарное обновление queueid/asyncid, отмена опроса при переключении режима.
  3. Пересмотри provider_overrides.field_map: внедри генерацию адаптеров из конфигурации или строгие контракт-тесты, предотвращающие неверное сопоставление полей.
  4. Напиши интеграционные тесты на разные провайдеры.
  Работай по SDD: контракты → стабы → тесты → реализация.
  ```

## 4. Управление слотами
- **Необходимость фикса:** требуется.
- **Важность:** 4/5.
- **Обоснование:** Бриф указывает на фиксированный набор слотов и сложную схему `settings_json`; без конкурентной защиты и валидации данные слота могут быть повреждены, что сломает ingest. Транзакционная пересборка `slot_template_binding` предотвращает зависания.
- **Рекомендуемые действия:** добавить блокировки/If-Match, единую валидацию схемы, транзакционные обновления привязок.
- **Промпт Codex Cloud:**
  ```
  Контекст: см. /Docs/brief.md (слоты slot-001…slot-015, сложная схема settings_json).
  Задачи:
  1. Уточни и зафиксируй в контрактах механизмы конкурентного обновления слотов (If-Match/updated_at).
  2. Реализуй backend-валидацию settings_json согласно JSON Schema, синхронизируй фронт.
  3. Обнови операции сохранения слотов так, чтобы slot_template_binding пересоздавались транзакционно и идемпотентно.
  4. Добавь тесты на гонки, валидацию и корректность пересоздания связей.
  Соблюдай SDD-процесс.
  ```

## 5. Очередь задач и ретраи
- **Необходимость фикса:** требуется.
- **Важность:** 5/5.
- **Обоснование:** Неправильное взаимодействие лимитов и ретраев приведёт к лавинообразным 504, что противоречит целям по таймингам и квотам. Требуется фиксировать финальный статус в пределах `T_sync_response` и атомарно работать с внешними идентификаторами для завершения задач.
- **Рекомендуемые действия:** синхронизировать конфигурацию ретраев и параллелизма, гарантировать финализацию статусов в окне таймаута и атомарность обновления внешних идентификаторов.
- **Промпт Codex Cloud:**
  ```
  Контекст: очередь и ретраи описаны в /Docs/brief.md. Нужно обеспечить корректную работу ограничений.
  Задачи:
  1. Специфицируй взаимодействие max_parallel_jobs, ретраев и дедлайнов; обнови конфиги и контракты при необходимости.
  2. Реализуй механизм, который прекращает ретраи и очистку после фиксации финального статуса внутри T_sync_response.
  3. Обеспечь атомарное обновление external_queue_id/external_async_id.
  4. Напиши тесты на конфигурацию параллелизма, таймауты и атомарность идентификаторов.
  Выполни изменения в рамках SDD.
  ```

## 6. Глобальные настройки и секреты
- **Необходимость фикса:** требуется.
- **Важность:** 4/5.
- **Обоснование:** Бриф обязывает к безопасному хранению секретов (Argon2id + AES-256-GCM) и строгой валидации настроек; ошибки в ротации пароля или логировании нарушают безопасность и могут сорвать ingest из-за некорректных TTL.
- **Рекомендуемые действия:** внедрить безопасный процесс ротации, запрет логирования, валидацию диапазонов и автоматическую инвалидцию старых паролей.
- **Промпт Codex Cloud:**
  ```
  Контекст: см. /Docs/brief.md (секреты, настройки). Нужно обеспечить безопасность app_settings/provider_secret и корректную ротацию.
  Задачи:
  1. Зафиксируй в схемах константы `processed_media_ttl_hours = 72` и `public_link_ttl_sec = 60` как read-only настройки.
  2. Убедись, что секреты шифруются Argon2id + AES-256-GCM, логирование plaintext исключено.
  3. Реализуй процесс ротации ingest-пароля с мгновенной инвалидизацией старого хеша.
  4. Добавь тесты на диапазоны и ротацию.
  Работай по SDD.
  ```

## 7. Аутентификация и авторизация
- **Необходимость фикса:** требуется.
- **Важность:** 3/5.
- **Обоснование:** Бриф устанавливает статический набор пользователей и JWT с permissions; нарушение приводит к 403 и риску несанкционированного доступа. Нужно исключить регистрацию новых пользователей, синхронизировать список прав и защитить ingest-пароль в логах.
- **Рекомендуемые действия:** обеспечить безопасное хранение хэшей, добавить тест на соответствие permissions и запретить логирование чувствительных данных.
- **Промпт Codex Cloud:**
  ```
  Контекст: аутентификация описана в /Docs/brief.md. Требуется привести guard/permissions в соответствие.
  Задачи:
  1. Проверь механизмы хранения статических пользователей (serg, igor) и исключи возможность регистрации через API.
  2. Синхронизируй список JWT permissions с guard: добавь unit-тест, который проверяет соответствие миграций и кода.
  3. Убедись, что ingest-пароль не логируется и исходные изображения удаляются по T_ingest_ttl.
  4. Покрой проверки тестами.
  Следуй SDD.
  ```

## 8. Логи, метрики и мониторинг
- **Необходимость фикса:** требуется.
- **Важность:** 4/5.
- **Обоснование:** Для соблюдения SLA, описанных в брифе, необходимы ProcessingLog, метрики таймаутов, ретраев, заполнения MEDIA_ROOT. Без мониторинга невозможно обеспечить устойчивость и корректно реагировать на переполнение.
- **Рекомендуемые действия:** внедрить сбор логов/метрик, алерты по 504 и состоянию диска, корректные ответы 503 при переполнении.
- **Промпт Codex Cloud:**
  ```
  Контекст: требования по логам и мониторингу изложены в /Docs/brief.md и agents.md.
  Задачи:
  1. Специфицируй ProcessingLog и ключевые метрики (таймауты, ретраи, доля 504, использование MEDIA_ROOT).
  2. Реализуй сбор и экспорт метрик, настройку алертов и обработку переполнения MEDIA_ROOT (возвращать 503 вместо крэша).
  3. Напиши тесты/проверки на генерацию логов и корректные статусы при переполнении.
  Следуй SDD-процессу.
  ```

## 9. Фронтенд и UX
- **Необходимость фикса:** требуется.
- **Важность:** 3/5.
- **Обоснование:** UI на HTMX должен учитывать permissions; несоответствие форм данным провайдера нарушит рабочие флоу и приведёт к неправильной конфигурации слотов. Синхронизация с `providers.json` обязательна для корректного UX.
- **Рекомендуемые действия:** реализовать фильтрацию элементов по правам и синхронное обновление форм с конфигурацией провайдеров.
- **Промпт Codex Cloud:**
  ```
  Контекст: фронтенд HTMX описан в /Docs/brief.md. Нужно обеспечить соответствие UI правам и данным провайдеров.
  Задачи:
  1. Добавь проверку permissions (slots:read/write, settings:*) на фронтенде, скрывая недоступные элементы.
  2. Организуй синхронизацию providers.json с формами (автогенерация или единый источник).
  3. Протестируй UI сценарии с разными наборами прав.
  Работай по SDD (обнови контракт UI/API при необходимости).
  ```

## 10. Definition of Done (SDD)
- **Необходимость фикса:** требуется.
- **Важность:** 5/5.
- **Обоснование:** agents.md и бриф требуют строгого SDD-процесса; несоблюдение приводит к расхождению API и отсутствию тестов. Без фикса процессных нарушений команда не сможет реализовывать остальные задачи безопасно.
- **Рекомендуемые действия:** внедрить контроль прохождения стадий SPEC→STUBS→TESTS→IMPL и проверку наличия контрактов и тестов перед merge.
- **Промпт Codex Cloud:**
  ```
  Контекст: соблюдение SDD описано в agents.md. Нужно автоматизировать контроль Definition of Done.
  Задачи:
  1. Опиши и задокументируй проверку SDD: какие артефакты обязательны на каждой стадии.
  2. Реализуй автоматические проверки (скрипты CI или pre-commit), подтверждающие наличие обновлённых контрактов, стаба и тестов перед merge.
  3. Добавь отчётность о прохождении SDD в PR-шаблон.
  Следуй принципам SDD при внедрении