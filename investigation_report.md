# Отчет о проблемах с обработкой тестового изображения

## 1. Ошибка применения переопределений (Основная причина)

**Описание:**
В методе `IngestService.run_test_job` происходит применение переопределений (overrides), полученных от веб-интерфейса. Веб-интерфейс отправляет список `template_media` в формате, содержащем только `media_kind` и `media_object_id`, но без поля `role`.
В коде метода `_apply_test_overrides` (строка 355 в `src/app/ingest/ingest_service.py`) этот неполный список полностью перезаписывает настройки слота `job.slot_settings["template_media"]`.
Однако провайдеры (Gemini, Turbotext) и резолвер шаблонов (`resolve_template_media`) ожидают, что элементы в `template_media` обязательно содержат поле `role`, чтобы сопоставить изображение с нужным параметром промпта.
В результате возникает ошибка `TemplateMediaResolutionError: Template media entry requires 'role' field`.

**Метод фикса:**
Необходимо изменить логику в `src/app/ingest/ingest_service.py` в методе `_apply_test_overrides`. Вместо полной замены списка `job.slot_settings["template_media"]`, следует либо:
1. Только обновлять словарь `job.slot_template_media`, не трогая `job.slot_settings["template_media"]`. При этом нужно убедиться, что резолверы используют `job.slot_template_media` для получения актуальных ID объектов.
2. Либо производить слияние (merge) списков: обновлять `media_object_id` в существующем списке `job.slot_settings["template_media"]` на основе совпадения `media_kind`, сохраняя поле `role`.

## 2. Дополнительный контекст: Зачем нужно поле `role`?

В ходе анализа возник вопрос о целесообразности поля `role`, так как API Gemini (в отличие от Turbotext) его не требует.

*   **Для провайдера Gemini:** Поле `role` действительно **не используется** при формировании финального запроса к API Google. Все изображения просто передаются списком в массиве `contents`.
*   **Для архитектуры проекта:** Поле `role` является обязательным идентификатором внутри подсистемы `TemplateMediaResolver`. Оно позволяет однозначно сопоставить загруженный файл с конфигурацией слота (например, отличить "фон" от "стиля").
*   **Причина сбоя:** Ошибка `TemplateMediaResolutionError` генерируется именно внутренним резолвером (`src/app/providers/template_media_resolver.py`), который отказывается обрабатывать файлы без указанной роли, защищая целостность конфигурации перед передачей данных провайдеру.

## 3. Отсутствие учетных данных провайдеров

**Описание:**
Для работы провайдеров требуются API ключи, задаваемые через переменные окружения:
- `GEMINI_API_KEY` для Gemini
- `TURBOTEXT_API_KEY` для Turbotext
Если они не заданы на сервере, возникнет `ProviderExecutionError`.

**Метод фикса:**
Проверить наличие и корректность указанных переменных окружения в файле `.env` или конфигурации деплоя.

## 4. Таймаут обработки

**Описание:**
Если провайдер обрабатывает изображение дольше, чем установлено в настройке `sync_response_seconds` (по умолчанию 48 секунд), произойдет ошибка `ProviderTimeoutError`.

**Метод фикса:**
Увеличить значение переменной окружения `T_SYNC_RESPONSE_SECONDS` или оптимизировать параметры запроса к провайдеру (например, уменьшить размер изображения).
