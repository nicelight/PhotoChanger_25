# 0001 — Упрощение модели Job и Result для MVP

## Контекст

Базовый бриф PhotoChanger предусматривает полноценный асинхронный мост с
подробными финальными статусами задач (`completed`, `failed_timeout`,
`failed_provider`, `cancelled`) и отдельную таблицу `Result` с TTL на 72 часа.
Для MVP, сфокусированного на синхронной выдаче результата в том же `POST`
запросе, такая детализация приводит к лишним веткам логики, дублированию
метрик и необходимости фонового garbage collection для результатов.

Одновременно сервис сам управляет аутентификацией: `/api/login` выдаёт JWT
для статических администраторов (`serg`, `igor`), а ротация ingest-пароля
выполняется через `PUT /api/settings` без перезапуска. Сокращение количества
сущностей упрощает аудит и снижает число точек, в которых требуется учитывать
права и секреты при обслуживании Job.

## Решение

* **Статусы Job** сокращаются до двух промежуточных состояний — `pending` и
  `processing`. Финальное состояние определяется флагом `is_finalized` и
  необязательным `failure_reason` (`timeout`, `provider_error`, `cancelled`).
  Успешная задача помечается `is_finalized = true` и `failure_reason = null`.
* **Результат** инлайнится в запись Job: вместо отдельной сущности `Result`
  храним структуру `result` с метаданными итогового изображения и
  относительным путём к файлу (`result_file_path`). Для синхронного ответа
  сохраняется временное поле `result_inline_base64`, которое воркер заполняет
  на время ожидания и очищает сразу после отправки HTTP 200/504. Запись
  `result` присутствует только если задача завершилась успешно.

## Последствия

* Убирается дублирование переходов в разные финальные статусы и связанная с
  ними отчётность: достаточно одной ветки очистки после `is_finalized = true`.
* Фоновая очистка результатов больше не требуется — хранится лишь последний
  ответ для оперативного повторного получения; временная base64-строка
  живёт только до финализации.
* Метрики времени и количества ошибок строятся по полю `failure_reason`, а не
  по множеству отдельных статусов.
* Ротация ingest-пароля через `/api/settings` и обновление статических
  учётных данных не затрагивают схему Job: секреты остаются в конфигурации,
  а запись Job не содержит чувствительной информации.
* В будущем, при необходимости расширения долгого хранения результатов, можно
  вернуть отдельную сущность `Result`, не ломая модель задач: `result` в Job
  станет ссылкой на полноценную запись.

## Статус

Accepted (2024-07-09)
