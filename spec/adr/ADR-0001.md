---
adr: ADR-0001
title: Монолит FastAPI + cron без очередей
date: 2025-10-08
status: accepted
supersedes: []
superseded_by: null
---

# Контекст
PhotoChanger выходит на пилот с требованием выдавать результат AI-обработки в течение окна `T_sync_response` (10–60 с) и обслуживать до 15 статичных слотов. Команда ограничена, отдельного DevOps нет, а сложные пайплайны с очередями увеличат стоимость поддержки. Нужна архитектура, которую можно развернуть на одном сервере, обеспечить простую отладку и прозрачное логирование.

# Решение
Собрать приложение как один процесс FastAPI c модулями `ingest`, `media`, `slots`, `settings`, `stats`, использовать PostgreSQL и файловую систему `MEDIA_ROOT` для хранения данных, держать провайдеров (Gemini, Turbotext) как асинхронные драйверы внутри процесса и запускать очистку медиа через cron-скрипт `scripts/cleanup_media.py`. Очереди и воркеры откладываем, чтобы сохранить KISS и сократить время вывода MVP.

# Альтернативы
- **Очередь сообщений + воркер** (Kafka/Rabbit + отдельный worker): даёт масштабируемость и ретраи, но требует дополнительной инфраструктуры и усложняет отладку таймаутов; добавленный latency ухудшит SLA.
- **Serverless ingest + provider functions** (Cloud Functions/Lambda): снижает заботы об инфраструктуре, но затрудняет контроль ttl файлов, усложняет хранение на диске и добавляет холодные старты.

# Последствия
- Простая поддержка и деплой: один процесс + cron, всё можно поднять docker-compose.
- Ограничение на длительность задач ≤ `T_sync_response`, масштабирование по горизонтали придётся решать позже (version 3).
- Cron становится обязательным компонентом, а сбои очистки приводят к росту диска — нужны метрики/алерты.

# Связанные артефакты
- PR: #123 (placeholder — обновить в момент реального merge)
- Контракты: `spec/contracts/VERSION.json@0.1.0`
- Документация: `docs/ARCHITECTURE.md`, `spec/docs/context.md`
