---
adr: ADR-0002
date: 2025-10-16
status: accepted
supersedes: []
superseded_by: null
---

# TTL и очистка медиа

## Контекст
- Ингест и очередь задач опираются на настраиваемое значение `T_sync_response` (45–60 с), за которое платформа обязана завершить синхронный HTTP-запрос (`200` или `504`).
- Публичные ссылки на временные файлы (`media_object`) и Files API провайдеров Gemini/Turbotext должны оставаться доступными в течение всего окна ожидания.
- Платформа хранит обработанные результаты в `MEDIA_ROOT/results` 72 часа (`T_result_retention`), а промежуточные base64 (`result_inline_base64`) должны удаляться сразу после ответа API.
- В SDD отсутствовало явное решение, кто отвечает за очистку и контроль TTL (ingest, воркеры, фоновые процессы).

## Решение
1. **Единый дедлайн задачи** — `Job.expires_at = created_at + T_sync_response` фиксируется при создании и используется ingest, воркерами и публичным API.
2. **Очистка временных медиа** — воркеры по завершении задачи (успех/ошибка/таймаут) удаляют временные файлы из `media_object` и Files API провайдеров. Фоновый очиститель запускается с периодом не более 60 секунд после наступления `artifact_expires_at`, чтобы удалить записи `media_object` и локальные файлы старше `T_sync_response`.
3. **Очистка результатов** — планировщик удаляет итоговые файлы и записи `Job.result_*`, у которых `result_expires_at = created_at + T_result_retention` истёк. Публичное API при запросе `GET /public/results/{job_id}` возвращает `410 Gone`, если TTL истёк.
4. **Контроль polling** — воркеры проверяют `Job.expires_at` перед каждой попыткой polling провайдера. При наступлении дедлайна запросы немедленно прерываются, а задача переводится в состояние `timeout`.
5. **Конфигурация TTL** — изменение `T_sync_response` через `/api/settings` автоматически пересчитывает TTL в конфигурации media-cache (включая `T_public_link_ttl`).

## Альтернативы
- **Продление TTL воркерами** — отклонено: нарушает требования провайдеров и усложняет контроль дедлайнов.
- **Единый cron на БД** — отклонено: перенос логики очистки в БД усложняет масштабирование и требует прав на файловую систему.

## Последствия
- Требуется реализовать фоновые задачи очистки временных и итоговых файлов, мониторинг их выполнения и метрики просроченных записей.
- Unit/contract тесты должны покрыть сценарии таймаута (`504`), очистки `media_object` и возврата `410 Gone`.
- Изменение `T_sync_response` влияет на воркеры, ingest и публичные ссылки — необходимо обеспечить атомарное применение настроек.

## Связанные артефакты
- Контракты: `spec/contracts/openapi.yaml`, `spec/contracts/schemas/Job.json`, `spec/contracts/schemas/MediaCacheSettings.json`
- Документация: `Docs/providers/gemini.md`, `Docs/providers/turbotext.md`, `Docs/reviews/2025-10-16-provider-contract-review.md`
- Задачи: `.memory/TASKS.md` (Фаза 1, пункты 1.3–1.4)
