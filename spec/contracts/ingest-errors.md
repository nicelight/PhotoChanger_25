# Ingest API — Ошибки и таймауты

Документ фиксирует соответствие HTTP-статусов и значения поля `failure_reason` из JSON-ответа ошибки (`spec/contracts/schemas/ingest-error.schema.json`). Успешные ответы (`200 OK`) возвращают бинарные данные и не подпадают под данную таблицу.

| HTTP статус | `failure_reason`         | Описание / условия выдачи                                                                 | Дополнительно |
|-------------|--------------------------|--------------------------------------------------------------------------------------------|---------------|
| `400 Bad Request` | `invalid_request`       | Нарушен формат `multipart/form-data`: отсутствует `password`/`fileToUpload`, повреждён boundary, checksum не совпадает с полем `hash`, неподдерживаемый тип дополнительного поля и т.п. | — |
| `401 Unauthorized` | `invalid_password`      | Передан неверный глобальный ingest-пароль.                                                 | — |
| `404 Not Found` | `slot_not_found`        | Слот с указанным `slot_id` не существует или отключён администратором.                     | — |
| `413 Payload Too Large` | `payload_too_large` | Размер файла превысил лимит, настроенный для слота, либо глобальный предельный размер 20 МБ. | Поле `details` может содержать фактический размер и лимит. |
| `415 Unsupported Media Type` | `unsupported_media_type` | MIME не входит в поддерживаемый перечень (JPEG/PNG/WebP), проверяется по заголовку `Content-Type` части multipart. | — |
| `429 Too Many Requests` | `rate_limited`         | Достигнут лимит параллельных задач (глобальный или per-slot семафор).                      | Поле `retry_after` (секунды) заполняется при наличии прогнозируемого окна повторной попытки. |
| `502 Bad Gateway` / `503 Service Unavailable` | `provider_error`       | Провайдер вернул ошибку/был временно недоступен, либо произошёл сбой при обмене данными.    | — |
| `504 Gateway Timeout` | `provider_timeout`     | Драйвер провайдера не успел завершить обработку в пределах `T_sync_response`.              | Поле `status` = `timeout`. |
| `500 Internal Server Error` | `internal_error`       | Непредвиденная ошибка сервера (исключение в коде, сбой инфраструктуры).                    | — |

Дополнительные значения:
- `slot_disabled` — возвращается как `failure_reason` при обращении к отключённому слоту, но HTTP-статус остаётся `404` (чтобы не раскрывать внутренние детали конфигурации).
- При `429` допускается отсутствие `retry_after`, если предсказать окно повторной попытки невозможно.
- Несовпадение контрольной суммы (`hash`) фиксируется только как предупреждение в логах; запрос не отклоняется и продолжает обработку.
- Для Gemini ответ `finishReason=NO_IMAGE` трактуется как отказ от выдачи изображения: выполняется до 5 попыток с паузой 3 с; при исчерпании попыток возвращается `504` с `failure_reason=provider_timeout`.

Все ошибки имеют структуру:

```json
{
  "status": "error",
  "failure_reason": "invalid_request",
  "details": "Provided multipart form is invalid"
}
```

- `status` принимает значения `error` либо `timeout` (только для 504).
- `details` — опциональное текстовое пояснение (без бинарного содержимого).
- `retry_after` — опционально для 429, целое число секунд.
- При проверке размеров и MIME сервер использует заголовки каждой части multipart (`Content-Type`) и потоково подсчитывает размер загруженного файла, чтобы остановить обработку до передачи провайдеру.
