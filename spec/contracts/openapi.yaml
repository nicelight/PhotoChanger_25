openapi: 3.1.0
info:
  title: PhotoChanger API
  version: 0.7.0-draft
  description: >
    Draft specification for the PhotoChanger platform. Описывает синхронный ingest (`POST /api/ingest/{slot_id}`),
    публичную выдачу результатов, админские API (слоты, настройки, статистика) и авторизацию админов через JWT
    (`POST /api/login`). Админские маршруты защищены Bearer-токеном, выданным `POST /api/login`; токены действуют 168 ч.
servers:
  - url: https://api.photochanger.local
    description: Draft base URL (update per environment)
paths:
  /api/ingest/{slot_id}:
    post:
      summary: Submit an image for synchronous processing in the specified slot.
      description: >
        Processes the supplied image via the configured provider. The server waits up to
        `T_sync_response` (10–60 seconds, default 48 s). Successful jobs return the processed
        binary body immediately; results remain accessible via `/public/results/{job_id}` for
        72 hours (`T_result_retention`). Timeouts (504) indicate that the provider exceeded the
        synchronous window and the request can be retried.
      operationId: ingest_submit
      tags:
        - ingest
      parameters:
        - name: slot_id
          in: path
          required: true
          description: Static identifier of the ingest slot (`slot-001` … `slot-015`).
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: "./schemas/ingest-request.schema.json"
            examples:
              dslrSample:
                summary: DSLR Remote Pro upload
                value:
                  password: "123456"
                  fileToUpload: "(binary image bytes)"
                  time: "1758217512"
                  user_id: "Acer"
                  id: "CY04N068111304S2L_00000001."
                  profile: "C:\\Users\\Acer\\Documents\\PhotoboothImages\\setup_Serg.xml"
                  status: "C:\\Users\\Acer\\Documents\\PhotoboothImages\\screenSerg\\preview.jpg"
                  hash: "7b6c683e1d3fd29c8701791c54e3c12a236f5a5b"
                  name: "DESKTOP-K968T3F"
                  model: "Windows"
                  version: "3.30.2"
      responses:
        '200':
          description: Processed image returned synchronously (≤ `T_sync_response`).
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
            image/png:
              schema:
                type: string
                format: binary
            image/webp:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/IngestBadRequest'
        '401':
          $ref: '#/components/responses/IngestInvalidPassword'
        '404':
          $ref: '#/components/responses/IngestSlotNotFound'
        '413':
          $ref: '#/components/responses/IngestPayloadTooLarge'
        '415':
          $ref: '#/components/responses/IngestUnsupportedMedia'
        '429':
          $ref: '#/components/responses/IngestRateLimited'
        '500':
          $ref: '#/components/responses/IngestInternalError'
        '502':
          $ref: '#/components/responses/IngestProviderError'
        '503':
          $ref: '#/components/responses/IngestProviderUnavailable'
        '504':
          $ref: '#/components/responses/IngestProviderTimeout'
  /public/results/{job_id}:
    get:
      summary: Download a processed result by job identifier.
      description: >
        Returns the processed media file associated with `job_id`. Files are available for
        72 hours (`T_result_retention`) after the ingest job succeeds, after which the link
        responds with `410 Gone`.
      tags:
        - public-results
      parameters:
        - name: job_id
          in: path
          required: true
          description: Identifier returned in the ingest response (`/api/ingest/{slot_id}`).
          schema:
            type: string
      responses:
        '200':
          description: Processed media file ready for download.
          headers:
            Content-Disposition:
              description: Suggests filename for downloading the media asset.
              schema:
                type: string
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
            image/png:
              schema:
                type: string
                format: binary
            image/webp:
              schema:
                type: string
                format: binary
        '404':
          description: Result not found or not yet available.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicResultError'
              examples:
                resultNotFound:
                  summary: Job not found or still processing
                  value:
                    status: error
                    failure_reason: result_not_found
        '410':
          description: Result expired and is no longer available for download.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicResultError'
              examples:
                resultExpired:
                  summary: Result removed after TTL
                  value:
                    status: error
                    failure_reason: result_expired
  /api/login:
    post:
      summary: Authenticate admin and issue JWT.
      description: >
        Validates static admin credentials stored in `secrets/runtime_credentials.json` and issues a bearer token.
        Tokens are signed with HS256 (`JWT_SIGNING_KEY`) и действуют 168 часов. После 10 неудачных попыток логин
        блокируется на 15 минут, чтобы защититься от перебора паролей.
      tags:
        - auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            examples:
              adminLogin:
                value:
                  username: serg
                  password: ********
      responses:
        '200':
          description: JWT issued successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
              examples:
                success:
                  value:
                    access_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    token_type: bearer
                    expires_in: 604800
        '401':
          $ref: '#/components/responses/AuthUnauthorized'
        '429':
          $ref: '#/components/responses/AuthThrottled'
  /api/slots:
    get:
      security:
        - AdminBearer: []
      summary: List configured slots.
      description: >
        Returns all 15 static slots with minimal metadata for the admin UI.
      tags:
        - slots
      responses:
        '200':
          description: List of slot summaries.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SlotSummary'
        '401':
          $ref: '#/components/responses/AuthUnauthorized'
        '403':
          $ref: '#/components/responses/AuthForbidden'
    post:
      summary: Placeholder (slots are static).
      description: >
        Slots are static; POST is reserved for future use and currently returns 405.
      tags:
        - slots
      responses:
        '405':
          description: Not implemented.
  /api/slots/{slot_id}:
    get:
      security:
        - AdminBearer: []
      summary: Retrieve slot configuration.
      tags:
        - slots
      parameters:
        - name: slot_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Slot configuration with template media and recent results.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SlotDetails'
        '404':
          description: Slot not found.
        '401':
          $ref: '#/components/responses/AuthUnauthorized'
        '403':
          $ref: '#/components/responses/AuthForbidden'
    put:
      security:
        - AdminBearer: []
      summary: Update slot configuration.
      description: >
        Allows admins to change provider, operation, settings, limits and template media bindings.
      tags:
        - slots
      parameters:
        - name: slot_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SlotUpdateRequest'
      responses:
        '200':
          description: Updated slot configuration.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SlotDetails'
        '400':
          description: Validation error (invalid template media, provider settings, or limits).
        '404':
          description: Slot not found.
        '401':
          $ref: '#/components/responses/AuthUnauthorized'
        '403':
          $ref: '#/components/responses/AuthForbidden'
  /api/slots/{slot_id}/cleanup:
    post:
      security:
        - AdminBearer: []
      summary: Trigger cleanup of expired results for a specific slot.
      description: >
        Schedules background cleanup of expired `media/results/{slot_id}/` artifacts. Does not delete fresh results.
      tags:
        - slots
      parameters:
        - name: slot_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '202':
          description: Cleanup accepted for processing.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: accepted
        '404':
          description: Slot not found.
        '401':
          $ref: '#/components/responses/AuthUnauthorized'
        '403':
          $ref: '#/components/responses/AuthForbidden'
  /api/slots/{slot_id}/test-run:
    post:
      security:
        - AdminBearer: []
      summary: Execute a synchronous test run for the slot configuration.
      description: >
        Allows administrators to upload a test image and run the slot configuration directly from the UI.
        The payload mirrors the ingest workflow (size/MIME limits, provider drivers, TTL) but is marked as
        `source=ui_test` in job history so that production traffic remains distinguishable. Results remain
        available through `/public/results/{job_id}` for the standard retention period.
      tags:
        - slots
      parameters:
        - name: slot_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                slot_payload:
                  type: string
                  description: >
                    JSON object with optional overrides for the slot being tested. Supported keys:
                    `provider` (string), `operation` (string), `settings` (object, e.g. prompt overrides),
                    `template_media` (array of `{ media_kind, media_object_id, role }`). When omitted, the saved slot
                    configuration is used as-is.
                test_image:
                  type: string
                  format: binary
                  description: Test JPEG/PNG/WebP file that will be processed by the configured provider.
              required:
                - test_image
      responses:
        '200':
          description: Test run completed and result stored in job history.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SlotTestRunResponse'
        '400':
          $ref: '#/components/responses/IngestBadRequest'
        '404':
          $ref: '#/components/responses/IngestSlotNotFound'
        '413':
          $ref: '#/components/responses/IngestPayloadTooLarge'
        '415':
          $ref: '#/components/responses/IngestUnsupportedMedia'
        '502':
          $ref: '#/components/responses/IngestProviderError'
        '504':
          $ref: '#/components/responses/IngestProviderTimeout'
        '401':
          $ref: '#/components/responses/AuthUnauthorized'
        '403':
          $ref: '#/components/responses/AuthForbidden'
  /api/settings:
    get:
      security:
        - AdminBearer: []
      summary: Fetch global ingest/settings configuration.
      tags:
        - settings
      responses:
        '200':
          description: Current settings snapshot without exposing secrets.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SettingsResponse'
        '401':
          $ref: '#/components/responses/AuthUnauthorized'
        '403':
          $ref: '#/components/responses/AuthForbidden'
    put:
      security:
        - AdminBearer: []
      summary: Update global ingest/settings configuration.
      tags:
        - settings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SettingsUpdateRequest'
      responses:
        '200':
          description: Updated settings snapshot.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SettingsResponse'
        '400':
          description: Validation error (e.g., invalid timeout or password length).
        '401':
          $ref: '#/components/responses/AuthUnauthorized'
        '403':
          $ref: '#/components/responses/AuthForbidden'
        '422':
          description: Payload missing required fields or violates constraints.
  /api/stats/overview:
    get:
      security:
        - AdminBearer: []
      summary: Return admin statistics snapshot.
      description: >
        Provides lightweight aggregates for the whole system and each slot. Designed for admin
        dashboards without expensive queries.
      tags:
        - stats
      parameters:
        - name: window_minutes
          in: query
          required: false
          description: Size of the rolling window for per-slot/system counters (default 60 minutes).
          schema:
            type: integer
            minimum: 5
            maximum: 240
            default: 60
      responses:
        '200':
          description: Snapshot with system-level and per-slot metrics.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsOverview'
        '401':
          $ref: '#/components/responses/AuthUnauthorized'
        '403':
          $ref: '#/components/responses/AuthForbidden'
  /api/stats/slots:
    get:
      security:
        - AdminBearer: []
      summary: Return per-slot SLA metrics (active slots only).
      description: >
        Provides per-slot counters tailored for graphing: successful jobs, timeout share and other
        lightweight KPIs. Only active slots appear in the response to keep dashboards focused on
        operational workloads.
      tags:
        - stats
      parameters:
        - name: window_minutes
          in: query
          required: false
          description: Size of the rolling window for per-slot counters (default 60 minutes).
          schema:
            type: integer
            minimum: 5
            maximum: 240
            default: 60
      responses:
        '200':
          description: Per-slot metrics with derived KPIs.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsSlotListResponse'
        '401':
          $ref: '#/components/responses/AuthUnauthorized'
        '403':
          $ref: '#/components/responses/AuthForbidden'
components:
  schemas:
    IngestError:
      $ref: "./schemas/ingest-error.schema.json"
    PublicResultError:
      type: object
      required:
        - status
        - failure_reason
      properties:
        status:
          type: string
          enum:
            - error
        failure_reason:
          type: string
          enum:
            - result_not_found
            - result_expired
    StatsOverview:
      type: object
      required:
        - window_minutes
        - system
        - slots
      properties:
        window_minutes:
          type: integer
          description: Размер окна, за которое собраны агрегаты.
          example: 60
        system:
          $ref: '#/components/schemas/StatsSystemSummary'
        slots:
          type: array
          items:
            $ref: '#/components/schemas/StatsSlotSummary'
    StatsSystemSummary:
      type: object
      required:
        - jobs_total
        - jobs_last_window
        - timeouts_last_window
        - provider_errors_last_window
        - storage_usage_mb
      properties:
        jobs_total:
          type: integer
          example: 15234
        jobs_last_window:
          type: integer
          example: 248
        timeouts_last_window:
          type: integer
          example: 3
        provider_errors_last_window:
          type: integer
          example: 1
        storage_usage_mb:
          type: number
          format: float
          example: 912.4
    StatsSlotSummary:
      type: object
      required:
        - slot_id
        - display_name
        - is_active
        - jobs_last_window
        - timeouts_last_window
        - provider_errors_last_window
        - success_last_window
        - last_success_at
      properties:
        slot_id:
          type: string
          example: slot-001
        display_name:
          type: string
          example: Slot 1 (Gemini)
        is_active:
          type: boolean
          example: true
        jobs_last_window:
          type: integer
          example: 22
        timeouts_last_window:
          type: integer
          example: 1
        provider_errors_last_window:
          type: integer
          example: 0
        success_last_window:
          type: integer
          example: 20
        last_success_at:
          type: string
          format: date-time
        last_error_reason:
          type: string
          nullable: true
    StatsSlotBreakdown:
      allOf:
        - $ref: '#/components/schemas/StatsSlotSummary'
        - type: object
          required:
            - success_rate
            - timeout_rate
          properties:
            success_rate:
              type: number
              format: float
              description: Share of successful jobs within the selected window (0-1).
              example: 0.93
            timeout_rate:
              type: number
              format: float
              description: Share of timeout jobs within the selected window (0-1).
              example: 0.05
    StatsSlotListResponse:
      type: object
      required:
        - window_minutes
        - slots
      properties:
        window_minutes:
          type: integer
          example: 60
        slots:
          type: array
          description: Active slots only.
          items:
            $ref: '#/components/schemas/StatsSlotBreakdown'
    SlotSummary:
      type: object
      required:
        - slot_id
        - display_name
        - provider
        - operation
        - is_active
        - version
        - updated_at
      properties:
        slot_id:
          type: string
          example: slot-001
        display_name:
          type: string
          example: Slot 1 (Gemini)
        provider:
          type: string
          example: gemini
        operation:
          type: string
          example: image_edit
        is_active:
          type: boolean
          example: true
        version:
          type: integer
          example: 4
        updated_at:
          type: string
          format: date-time
    SlotDetails:
      allOf:
        - $ref: '#/components/schemas/SlotSummary'
        - type: object
          required:
            - size_limit_mb
            - sync_response_seconds
            - settings
            - template_media
            - recent_results
          properties:
            size_limit_mb:
              type: integer
              example: 20
            sync_response_seconds:
              type: integer
              example: 48
            settings:
              type: object
              description: Provider-specific JSON (see provider schema docs).
              example:
                provider: gemini
                prompt: "Studio portrait"
            template_media:
              type: array
              items:
                $ref: '#/components/schemas/SlotTemplateMediaBinding'
            recent_results:
              type: array
              items:
                $ref: '#/components/schemas/SlotRecentResult'
    SlotTemplateMediaBinding:
      type: object
      required:
        - media_kind
        - media_object_id
        - role
      properties:
        media_kind:
          type: string
          example: background
        media_object_id:
          type: string
          example: 8b6f0fa6b5b0459fb887c249f2eb5b21
        role:
          type: string
          example: template
        preview_url:
          type: string
          format: uri
          nullable: true
    SlotRecentResult:
      type: object
      required:
        - job_id
        - status
        - finished_at
        - public_url
        - expires_at
      properties:
        job_id:
          type: string
        status:
          type: string
          enum:
            - done
            - failed
            - timeout
        finished_at:
          type: string
          format: date-time
        public_url:
          type: string
          format: uri
        expires_at:
          type: string
          format: date-time
    SlotUpdateRequest:
      type: object
      required:
        - display_name
        - provider
        - operation
        - is_active
        - size_limit_mb
        - sync_response_seconds
        - settings
        - template_media
      properties:
        display_name:
          type: string
        provider:
          type: string
          description: Provider identifier (`gemini`, `turbotext`, ...).
        operation:
          type: string
        is_active:
          type: boolean
        size_limit_mb:
          type: integer
          minimum: 1
          maximum: 20
        sync_response_seconds:
          type: integer
          minimum: 10
          maximum: 60
        settings:
          type: object
          description: Provider-specific JSON.
        template_media:
          type: array
          items:
            $ref: '#/components/schemas/SlotTemplateMediaBinding'
    SlotTestRunResponse:
      type: object
      required:
        - status
        - job_id
        - public_result_url
        - completed_in_seconds
      properties:
        status:
          type: string
          example: done
        job_id:
          type: string
          description: Identifier of the job stored in job_history.
        public_result_url:
          type: string
          format: uri
          description: Relative or absolute URL that serves the processed result (`/public/results/{job_id}`).
        completed_in_seconds:
          type: number
          format: float
          description: Total time the test run spent in validation + processing.
    SettingsResponse:
      type: object
      required:
        - sync_response_seconds
        - result_ttl_hours
        - ingest_password_rotated_at
        - provider_keys
      properties:
        sync_response_seconds:
          type: integer
          example: 48
        result_ttl_hours:
          type: integer
          example: 72
        ingest_password_rotated_at:
          type: string
          format: date-time
          nullable: true
        ingest_password_rotated_by:
          type: string
          nullable: true
        provider_keys:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ProviderKeyStatus'
    SettingsUpdateRequest:
      type: object
      properties:
        sync_response_seconds:
          type: integer
          minimum: 10
          maximum: 60
        result_ttl_hours:
          type: integer
          minimum: 24
          maximum: 168
        ingest_password:
          type: string
          minLength: 8
          maxLength: 64
        provider_keys:
          type: object
          additionalProperties:
            type: string
            description: Plain provider API key (stored securely server-side).
      additionalProperties: false
    ProviderKeyStatus:
      type: object
      required:
        - configured
      properties:
        configured:
          type: boolean
        updated_at:
          type: string
          format: date-time
          nullable: true
    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          description: Static admin login (`serg`, `igor`).
        password:
          type: string
          format: password
          description: Plain password that will be hashed server-side.
    LoginResponse:
      type: object
      required:
        - access_token
        - token_type
        - expires_in
      properties:
        access_token:
          type: string
          description: Bearer token signed with HS256 (`JWT_SIGNING_KEY`).
        token_type:
          type: string
          enum:
            - bearer
        expires_in:
          type: integer
          example: 604800
          description: Token lifetime in seconds (168 h).
    AuthError:
      type: object
      required:
        - status
        - failure_reason
      properties:
        status:
          type: string
          enum:
            - error
        failure_reason:
          type: string
          enum:
            - invalid_credentials
            - throttled
            - missing_token
            - invalid_token
            - token_expired
            - insufficient_scope
          description: Machine-readable error that pinpoints the auth failure.
        details:
          type: string
          nullable: true
          description: Optional short explanation.
  securitySchemes:
    AdminBearer:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT issued by POST /api/login. Tokens remain valid for 168 hours.
  responses:
    IngestErrorResponse:
      description: Canonical JSON error body.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/IngestError'
          examples:
            invalidPassword:
              summary: Incorrect ingest password
              value:
                status: error
                failure_reason: invalid_password
                details: Provided ingest password does not match.
            providerTimeout:
              summary: Provider did not finish in time
              value:
                status: timeout
                failure_reason: provider_timeout
    IngestBadRequest:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Invalid multipart payload (`failure_reason=invalid_request`).
    IngestInvalidPassword:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Incorrect ingest password (`failure_reason=invalid_password`).
    IngestSlotNotFound:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Slot not found or disabled (`failure_reason=slot_not_found` or `slot_disabled`).
    IngestPayloadTooLarge:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: File exceeds the configured slot limit or the global 20 MB safety cap (`failure_reason=payload_too_large`).
    IngestUnsupportedMedia:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Unsupported MIME type (validated against the multipart part `Content-Type`; allowed values: image/jpeg, image/png, image/webp) (`failure_reason=unsupported_media_type`).
    IngestRateLimited:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Concurrency limit reached (`failure_reason=rate_limited`).
      headers:
        Retry-After:
          description: Recommended delay in seconds before retrying.
          schema:
            type: integer
            minimum: 1
    IngestInternalError:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Unexpected server error (`failure_reason=internal_error`).
    IngestProviderError:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Provider returned an error (`failure_reason=provider_error`).
    IngestProviderUnavailable:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Provider temporarily unavailable (`failure_reason=provider_error`).
    IngestProviderTimeout:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Provider timeout (`failure_reason=provider_timeout`, `status=timeout`).
    AuthErrorResponse:
      description: Authentication or authorization failure.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthError'
          examples:
            missingToken:
              summary: Missing Authorization header
              value:
                status: error
                failure_reason: missing_token
            invalidCredentials:
              summary: Wrong username or password
              value:
                status: error
                failure_reason: invalid_credentials
            throttled:
              summary: Too many attempts
              value:
                status: error
                failure_reason: throttled
    AuthUnauthorized:
      allOf:
        - $ref: '#/components/responses/AuthErrorResponse'
      description: Authentication failed (missing/invalid token or credentials).
    AuthForbidden:
      allOf:
        - $ref: '#/components/responses/AuthErrorResponse'
      description: Token does not include the required scope.
    AuthThrottled:
      allOf:
        - $ref: '#/components/responses/AuthErrorResponse'
      description: Login attempts are temporarily blocked (failure_reason=`throttled`).
