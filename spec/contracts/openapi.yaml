openapi: 3.1.0
info:
  title: PhotoChanger API
  version: 0.1.0-draft
  description: >
    Draft specification for the PhotoChanger ingest endpoint. Covers synchronous
    processing via POST /api/ingest/{slot_id}. Successful responses return binary
    image payloads; error responses follow the JSON structure described in the
    referenced schemas.
servers:
  - url: https://api.photochanger.local
    description: Draft base URL (update per environment)
paths:
  /api/ingest/{slot_id}:
    post:
      summary: Submit an image for synchronous processing in the specified slot.
      description: >
        Processes the supplied image via the configured provider. The server waits up to
        `T_sync_response` (10–60 seconds, default 48 s). Successful jobs return the processed
        binary body immediately; results remain accessible via `/public/results/{job_id}` for
        72 hours (`T_result_retention`). Timeouts (504) indicate that the provider exceeded the
        synchronous window and the request can be retried.
      operationId: ingest_submit
      tags:
        - ingest
      parameters:
        - name: slot_id
          in: path
          required: true
          description: Static identifier of the ingest slot (`slot-001` … `slot-015`).
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: "./schemas/ingest-request.schema.json"
            examples:
              dslrSample:
                summary: DSLR Remote Pro upload
                value:
                  password: "123456"
                  fileToUpload: "(binary image bytes)"
                  time: "1758217512"
                  user_id: "Acer"
                  id: "CY04N068111304S2L_00000001."
                  profile: "C:\\Users\\Acer\\Documents\\PhotoboothImages\\setup_Serg.xml"
                  status: "C:\\Users\\Acer\\Documents\\PhotoboothImages\\screenSerg\\preview.jpg"
                  hash: "7b6c683e1d3fd29c8701791c54e3c12a236f5a5b"
                  name: "DESKTOP-K968T3F"
                  model: "Windows"
                  version: "3.30.2"
      responses:
        '200':
          description: Processed image returned synchronously (≤ `T_sync_response`).
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
            image/png:
              schema:
                type: string
                format: binary
            image/webp:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/IngestBadRequest'
        '401':
          $ref: '#/components/responses/IngestInvalidPassword'
        '404':
          $ref: '#/components/responses/IngestSlotNotFound'
        '413':
          $ref: '#/components/responses/IngestPayloadTooLarge'
        '415':
          $ref: '#/components/responses/IngestUnsupportedMedia'
        '429':
          $ref: '#/components/responses/IngestRateLimited'
        '500':
          $ref: '#/components/responses/IngestInternalError'
        '502':
          $ref: '#/components/responses/IngestProviderError'
        '503':
          $ref: '#/components/responses/IngestProviderUnavailable'
        '504':
          $ref: '#/components/responses/IngestProviderTimeout'
components:
  schemas:
    IngestError:
      $ref: "./schemas/ingest-error.schema.json"
  responses:
    IngestErrorResponse:
      description: Canonical JSON error body.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/IngestError'
          examples:
            invalidPassword:
              summary: Incorrect ingest password
              value:
                status: error
                failure_reason: invalid_password
                details: Provided ingest password does not match.
            providerTimeout:
              summary: Provider did not finish in time
              value:
                status: timeout
                failure_reason: provider_timeout
    IngestBadRequest:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Invalid multipart payload (`failure_reason=invalid_request`).
    IngestInvalidPassword:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Incorrect ingest password (`failure_reason=invalid_password`).
    IngestSlotNotFound:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Slot not found or disabled (`failure_reason=slot_not_found` or `slot_disabled`).
    IngestPayloadTooLarge:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: File exceeds the configured slot limit or the global 20 MB safety cap (`failure_reason=payload_too_large`).
    IngestUnsupportedMedia:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Unsupported MIME type (validated against the multipart part `Content-Type`; allowed values: image/jpeg, image/png, image/webp) (`failure_reason=unsupported_media_type`).
    IngestRateLimited:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Concurrency limit reached (`failure_reason=rate_limited`).
      headers:
        Retry-After:
          description: Recommended delay in seconds before retrying.
          schema:
            type: integer
            minimum: 1
    IngestInternalError:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Unexpected server error (`failure_reason=internal_error`).
    IngestProviderError:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Provider returned an error (`failure_reason=provider_error`).
    IngestProviderUnavailable:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Provider temporarily unavailable (`failure_reason=provider_error`).
    IngestProviderTimeout:
      allOf:
        - $ref: '#/components/responses/IngestErrorResponse'
      description: Provider timeout (`failure_reason=provider_timeout`, `status=timeout`).
