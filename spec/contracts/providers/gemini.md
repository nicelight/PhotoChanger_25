# Gemini — контракт провайдера

## Общие сведения
- Gemini выполняет генерацию и редактирование изображений через единый метод `models.generateContent`. Все операции платформы (`style_transfer`, `image_edit`, `identity_transfer`) формируют структуру `contents` с частями `text`, `inline_data` или `file_data`.
- Для файлов, превышающих удобный объём inline-передачи, используется Files API: воркер загружает изображение и подставляет `file_data` с `file_uri`. Files API хранит объекты до 48 часов и ограничивает размер — до 2 ГБ на файл и 20 ГБ на проект.
- Аутентификация осуществляется заголовком `x-goog-api-key`. Публичная модель `gemini-2.5-flash-image` относится к Tier 2 (500 RPM, 2 000 RPD, 500 000 TPM).

## Ингест-ограничения
- Допустимые MIME: `image/jpeg`, `image/png`, `image/webp`, `image/heic`, `image/heif`; UI и ingest обязаны придерживаться этого списка.
- Inline-передача подходит только для небольших файлов; если payload не проходит по сетевым ограничениям или угрожает дедлайну `T_sync_response`, воркер использует Files API и подставляет `file_uri`.
- Все операции завершаются в пределах `T_sync_response`; по его истечении ingest возвращает 504, задача получает `failure_reason = 'timeout'`, воркер отменяет обращение к Gemini и освобождает ресурсы.

## Поддерживаемые операции
### Общая форма запроса
- Endpoint: `POST https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent`.
- Параметры: `model="gemini-2.5-flash-image"`; массив `contents` формируется из текстовых и медиапростей.
- Ответ: массив кандидатов; итоговое изображение передаётся как `content.parts[n].inline_data` (base64 PNG).

### `style_transfer`
- Входные данные: целевое изображение (`target_media_id`) и эталон стиля (`style_media_id`). Оба файла транслируются в `file_data` (или `inline_data`, если размер минимален).
- `prompt` описывает желаемый эффект; дополнительные настройки слота (`style_strength`, `output`) используются для формирования текстовых инструкций.
- Воркер гарантирует доступность Files API ссылок/временных URL на протяжении всего `T_sync_response`.

### `image_edit`
- Входные данные: исходное фото ingest (`ingest_media`) и текстовый `prompt`; при крупном файле используется Files API.
- Дополнительные поля (`guidance_scale`, `negative_prompt`, `output`, параметры multi-image fusion) переводятся в отдельные части `contents` и влияют на подсказки модели.
- Слот может добавлять дополнительные изображения (`template_media`), которые воркер размещает в `contents` отдельными `file_data`.

### `identity_transfer`
- Входные данные: `base_media_id` и `overlay_media_id` из `template_media` или временных медиа.
- `prompt` поясняет желаемый результат (замена лица, совмещение образов). Дополнительные настройки (`alignment`, `output`) конвертируются в текстовые подсказки.
- Воркер обязан обеспечить наличие обоих файлов через Files API/публичные URL до завершения `T_sync_response`.

## Лимиты и квоты провайдера
- Files API: до 2 ГБ на файл, 20 ГБ на проект, хранение 48 часов; поддерживаемые форматы — JPEG/PNG/WebP (используем ограниченный набор ради упрощения интеграции).
- Tier 2 (`gemini-2.5-flash-image`): 500 запросов в минуту, 2 000 в день, 500 000 токенов в минуту; адаптер обязан учитывать лимиты при планировании задач и backoff.
- Для inline-передачи Google рекомендует оставаться в пределах 20 МБ на запрос; сверх этого требуется Files API.

## Обработка ошибок и SLA
- Gemini возвращает ошибки Google RPC  с объектом `error`. Адаптер транслирует их в статусы ingest (`502`/`504`) и помечает задачу `failure_reason = 'provider_error'` либо `'timeout'`.
- Превышение `T_sync_response` приводит к прерыванию запроса, очистке временных файлов и остановке задачи. 
- При ответах `RESOURCE_EXHAUSTED` или `DEADLINE_EXCEEDED` допускается один повторный запрос (если до конца `T_sync_response` остаётся ≥ 5 с); повторные ошибки завершают задачу с `provider_error`.
- Ошибки валидации (`INVALID_ARGUMENT`) должны быть предотвращены валидацией слота/ingest; если всё-таки произошли, задача завершается `failure_reason='provider_error'`, а событие логируется для диагностики.

## Деградации и особые случаи
- Если Files API не успевает обработать загрузку (файл висит в статусе `PROCESSING`), адаптер прерывает операцию, очищает временные ссылки и возвращает `provider_timeout`.
- При временной недоступности сервиса (HTTP 503) рекомендуется backoff 5 с и повтор запроса в пределах окна SLA.
- Для массовых таймаутов требуется перевести слот в деградацию (флаг `slot.disabled=true`) и уведомить администраторов согласно операционному плану.


## Примечания по данным
- `Slot.settings_json` валидируется схемами операций; идентификаторы `template_media` и `media_object` конвертируются в `file_data`/`file_uri` перед вызовом API.
- Все временные ссылки и загруженные файлы должны оставаться доступными до завершения `T_sync_response`; продление TTL без повторной регистрации запрещено.
- Полученный `inline_data` декодируется, сохраняется в `Job.result_*`, а `result_inline_base64` очищается после отправки HTTP 200 согласно доменной модели.
