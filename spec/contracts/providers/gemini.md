# Gemini — контракт провайдера

## Общие сведения
- Gemini выполняет генерацию и редактирование изображений через единый метод `models.generateContent`. Все операции платформы (`style_transfer`, `image_edit`, `identity_transfer`) формируют структуру `contents` с частями `text`, `inline_data` или `file_data`.
- PhotoChanger ограничивается inline-передачей (`inline_data`) и отклоняет payload свыше 20 МБ.
- Аутентификация осуществляется заголовком `x-goog-api-key`. Публичная модель `gemini-2.5-flash-image` относится к Tier 2 (500 RPM, 2 000 RPD, 500 000 TPM).

## Ингест-ограничения
- Допустимые MIME: `image/jpeg`, `image/png`, `image/webp`; UI и ingest обязаны придерживаться этого списка.
- Payload обязателен к inline-передаче и не должен превышать 20 МБ, чтобы уложиться в сетевые ограничения и SLA.
- Все операции завершаются в пределах `T_sync_response`; по его истечении ingest возвращает 504, задача получает `failure_reason = 'timeout'`, воркер отменяет обращение к Gemini и освобождает ресурсы.

## Поддерживаемые операции
### Общая форма запроса
- Endpoint: `POST https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent`.
- Параметры: `model="gemini-2.5-flash-image"`; массив `contents` формируется из текстовых и медиапростей.
- Ответ: массив кандидатов; итоговое изображение передаётся как `content.parts[n].inline_data` (base64 PNG).

### `style_transfer`
- Входные данные: целевое изображение (`target_media_id`) и эталон стиля (`style_media_id`). Оба файла кодируются в `inline_data` (base64) до 20 МБ каждое.
- `prompt` описывает желаемый эффект; дополнительные настройки слота (`style_strength`, `output`) используются для формирования текстовых инструкций.
- Воркер гарантирует доступность Files API ссылок/временных URL на протяжении всего `T_sync_response`.

### `image_edit`
- Входные данные: исходное фото ingest (`ingest_media`) и текстовый `prompt`; изображение передаётся в `inline_data` и не может превышать 20 МБ.
- Дополнительные поля (`guidance_scale`, `negative_prompt`, `output`, параметры multi-image fusion) переводятся в отдельные части `contents` и влияют на подсказки модели.
- Слот может добавлять дополнительные изображения (`template_media`), которые воркер размещает в `contents` отдельными `file_data`.

- Входные данные: `base_media_id` и `overlay_media_id` из `template_media` или временных медиа; PhotoChanger кодирует их как `inline_data`.
- `prompt` поясняет желаемый результат (замена лица, совмещение образов). Дополнительные настройки (`alignment`, `output`) конвертируются в текстовые подсказки.
- Воркер обязан подготовить inline-представление файлов до вызова провайдера; внешние URL не используются.

## Лимиты и квоты провайдера
- PhotoChanger накладывает жёсткий лимит: суммарный размер inline-запроса ≤ 20 МБ.
- Tier 2 (`gemini-2.5-flash-image`): 500 запросов в минуту, 2 000 в день, 500 000 токенов в минуту; адаптер обязан учитывать лимиты при планировании задач и backoff.

## Обработка ошибок и SLA
- Gemini возвращает ошибки Google RPC  с объектом `error`. Адаптер транслирует их в статусы ingest (`502`/`504`) и помечает задачу `failure_reason = 'provider_error'` либо `'timeout'`.
- Превышение `T_sync_response` приводит к прерыванию запроса, очистке временных файлов и остановке задачи. 
- При ответах `RESOURCE_EXHAUSTED` или `DEADLINE_EXCEEDED` допускается один повторный запрос; повторная ошибка завершает задачу с `provider_error`.
- Ошибки валидации (`INVALID_ARGUMENT`) должны быть предотвращены валидацией слота/ingest; если всё-таки произошли, задача завершается `failure_reason='provider_error'`, а событие логируется для диагностики.

## Деградации и особые случаи
- Если обработка зависает (например, ответ долго не приходит), адаптер прерывает операцию и возвращает `provider_timeout`.
- При временной недоступности сервиса (HTTP 503) рекомендуется backoff 5 с и повтор запроса в пределах окна SLA.
- Для массовых таймаутов требуется перевести слот в деградацию (флаг `slot.disabled=true`) и уведомить администраторов согласно операционному плану.


## Примечания по данным
- `Slot.settings_json` валидируется схемами операций; идентификаторы `template_media` и `media_object` используются для подготовки inline-представления (`inline_data`) перед вызовом API.
- Временные файлы провайдера (inline) должны быть доступны до завершения `T_sync_response`; продление TTL не требуется, так как Files API не задействован.
- Полученный `inline_data` декодируется, сохраняется в `Job.result_*`, а `result_inline_base64` очищается после отправки HTTP 200 согласно доменной модели.
