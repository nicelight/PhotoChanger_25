# Turbotext — контракт провайдера

## Общие сведения
- Интеграция выполняется через HTTP API Turbotext с очередью: задачи регистрируются запросом `do=create_queue`, а результат читается polling-запросом `do=get_result`; webhook не используется.
- Провайдер работает с публичными ссылками на изображения и не хранит файлы: воркер обязан выдавать URL, доступные не менее `T_public_link_ttl = T_sync_response` секунд, опираясь на дедлайн `Job.expires_at = T_sync_response` для синхронной очистки и отмены.

## Ингест-ограничения
- Допустимые MIME: `image/jpeg`, `image/png`, `image/webp`; остальные форматы отклоняются ещё на этапе ingest/UI.
- Максимальный размер входного файла — 15 МБ; превышение приводит к ошибке валидации до обращения к Turbotext.
- Провайдер требует подготовленные публичные ссылки (`requires_public_media = true`), поэтому воркер обязан регистрировать временные файлы через `media_object` и контролировать TTL `T_public_link_ttl`, чтобы Turbotext гарантированно успел скачать их в пределах окна задачи.
- Параллелизм ограничен двумя одновременными задачами на провайдера; остальные ожидают в очереди платформы.
- В ожидании синхронного ответа API придерживается общего дедлайна `T_sync_response`; по истечении окна ingest завершает запрос кодом 504 и фиксирует `failure_reason = 'timeout'`.

## Поддерживаемые операции
### `style_transfer`
- Назначение: смешивание стилевого и целевого изображения для переноса художественного стиля.
- Endpoint Turbotext: `/api_ai/mix_images` с полями формы `url_image_target`, `url`, `content` и флагом очереди.
- Обязательные настройки слота: `prompt`, `target_media_id`, `style_media_id`; валидируются по общей схеме операции.
- Маппинг полей: воркер подставляет публичные ссылки шаблонных изображений (`template_media`) в `url_image_target`/`url`, а текстовый промпт — в `content`. Результат приходит ссылкой `uploaded_image`, которую нужно скачать и записать в поля `Job.result_*` (например, `result_file_path` + метаданные).

### `image_edit`
- Назначение: image-to-image редактирование по текстовому описанию с дополнительными параметрами силы эффекта, seed и масштаба.
- Endpoint Turbotext: `/api_ai/generate_image2image`; используется очередь и polling без webhook.
- Обязательные настройки: `prompt` и `source_media_id`; опционально  `strength`, `seed`, `scale`, `negative_prompt`, `original_language`, параметры блока `output`.
- Маппинг полей формы: `url` ← публичная ссылка по `source_media_id` (`media_object`), `content` ← `prompt`, остальные числовые и строковые поля подставляются согласно `field_map`. Результирующая ссылка `uploaded_image` скачивается и сохраняется в полях `Job.result_*`.

### `identity_transfer`
- Назначение: deepfake/face swap с использованием фотографий субъекта и лица; выполняется через очередь Turbotext.
- Endpoint Turbotext: `/api_ai/deepfake_photo` с полями `url`, `url_image_target`, `face_restore`; результат читается polling-запросами без webhook.
- Обязательные настройки: `subject_media_id`, `face_media_id`; опционально `face_restore`, `output`.
- Маппинг: `subject_media_id` и `face_media_id` конвертируются в публичные ссылки из `template_media`; булевый `face_restore` передаётся напрямую. Финальный `uploaded_image` скачивается и сохраняется в полях `Job.result_*` как файл (`result_file_path` + метаданные).

## Лимиты и квоты провайдера
- Turbotext потребляет публичные ссылки с TTL `T_public_link_ttl = T_sync_response` и форматами JPEG/PNG/WEBP; воркер не продлевает ссылки автоматически, повторная регистрация выполняется заново по необходимости.
- API работает по модели очереди: повторные попытки polling-а получают `{"action": "reconnect"}` без штрафа; нужно соблюдать собственные ограничения Turbotext по частоте опроса (конкретные значения уточняются у провайдера) и обрабатывать `limits` в ответе для мониторинга квот.

## Обработка ошибок и SLA
- Интеграция подчиняется общему дедлайну `T_sync_response`: по его наступлении ingest завершает запрос 504, воркер отправляет отмену в очередь и очищает временные файлы.
- Если Turbotext возвращает `success=false` или не предоставляет результат до дедлайна, задача фиксирует `failure_reason = 'provider_error'` либо `'timeout'`; повторные попытки не планируются — для новой обработки оператор отправляет новый POST.
- Истечение публичной ссылки (HTTP 410) трактуется как ошибка подготовки данных; при повторном запуске воркер обязан заново зарегистрировать `media_object` перед обращением к провайдеру.

## Примечания по данным
- `Slot.settings_json` хранит идентификаторы `template_media` и `media_object`; воркер преобразует их в публичные URL перед вызовом API Turbotext и не продлевает TTL автоматически.
- После завершения задачи результат скачивается по `uploaded_image` и сохраняется в полях `Job.result_*`; временные исходные файлы удаляются по окончании задачи или истечению TTL.
