# Turbotext — контракт провайдера

## Общие сведения
- Интеграция выполняется через REST API Turbotext (`https://www.turbotext.ru`) с формой `application/x-www-form-urlencoded`.
- Авторизация: заголовок `Authorization: Bearer {APIKEY}` обязателен для всех вызовов. Все операции проходят через очередь (`do=create_queue` → `do=get_result`).
- Провайдер работает только с публичными ссылками на изображения; воркер обязан использовать временное хранилище PhotoChanger (`media_object`) и обеспечивать доступность URL не менее `T_sync_response` секунд.

## Ингест-ограничения
- Допустимые входные форматы: `image/jpeg`, `image/png`, `image/webp`. Форматы HEIC/HEIF отклоняются на этапе ingest/UI.
- Turbotext требует, чтобы ссылки были общедоступными по HTTPS/HTTP; воркер обязан регистрировать временные файлы и контролировать TTL `T_public_link_ttl = T_sync_response`.
- Очередь PhotoChanger ограничивает параллелизм Turbotext согласно конфигурации платформы, чтобы не нарушать квоты и дедлайн `T_sync_response`.
- Ингест завершает запрос при наступлении `T_sync_response` (504, `failure_reason = 'timeout'`), воркер прекращает polling.

## Поддерживаемые операции
### Общий протокол
1. `POST /api_ai` с параметром `do=create_queue`, `method=<endpoint>` и настройками операции.
2. Ответ `success=true` возвращает `queueid`. PhotoChanger сохраняет его в `Job.provider_queue_id`.
3. Воркер выполняет polling `POST /api_ai` с `do=get_result` и `queueid` до завершения либо истечения `T_sync_response`.
4. Результат содержит `uploaded_image` — публичную ссылку на итоговый файл. Воркер скачивает файл и заполняет `Job.result_*`.

### `image_edit` (`/api_ai/generate_image2image`)
- Обязательные поля: `url` (публичная ссылка на исходное изображение), `content` (промпт).
- Дополнительные настройки слота: `strength` (`0–80`, default `40`), `seed` (`1–10^10`), `scale` (`0.1–20`), `negative_prompt`, `original_language`, `output`.
- Воркер маппит `source_media_id` на публичную ссылку, текстовые параметры передаются напрямую. Итог `uploaded_image` скачивается и сохраняется в `Job.result_*`.

### `style_transfer` (`/api_ai/mix_images`)
- Поля: `url_image_target` (целевое фото), `url` (источник стиля), `content` (опциональный текстовый эффект).
- Настройки слота содержат `target_media_id` и `style_media_id`, которые конвертируются в публичные ссылки.
- Результат `uploaded_image` скачивается и сохраняется; воркер контролирует TTL ссылок до завершения.

### `identity_transfer` (`/api_ai/deepfake_photo`)
- Поля: `url` (основное фото), `url_image_target` (лицо для подстановки), `face_restore` (опционально `True/False`).
- Слот хранит `subject_media_id` и `face_media_id`; воркер подставляет их как публичные URL и передаёт флаг `face_restore`.
- Результат загружается по `uploaded_image` и сохраняется в `Job.result_*`; временные ссылки очищаются после завершения задачи.

## Лимиты и квоты провайдера
- Провайдер возвращает `{"action":"reconnect"}` при ожидании — воркер должен делать backoff 2–3 с и не превышать частоту polling, согласованную с Turbotext.
- Turbotext учитывает каждую операцию как биллинговую единицу; повторные попытки требуют нового `create_queue`.
- TTL публичных ссылок должен соответствовать `T_public_link_ttl = T_sync_response`; просрочка ведёт к ошибкам скачивания (`410 Gone`).

## Обработка ошибок и SLA
- В случае `success=false` или отсутствия результата до дедлайна воркер помечает задачу `failure_reason = 'provider_error'` либо `'timeout'` и прекращает polling.
- Ошибки формата (например, неподдерживаемый MIME) должны отлавливаться до обращения к Turbotext.
- При истечении публичной ссылки воркер обязан зарегистрировать файл заново при повторном запуске задачи.

## Примечания по данным
- `Slot.settings_json` хранит идентификаторы `template_media` и `media_object`; адаптер конвертирует их в публичные URL при вызове API.
- Результирующий файл скачивается и сохраняется под `MEDIA_ROOT/results`, а метаданные фиксируются в `Job.result_*`.
- Очистка временных файлов выполняется после финализации задачи или по истечении TTL фоновой процедурой.
