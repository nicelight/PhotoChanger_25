# Аутентификация администраторов

## Обзор
`POST /api/login` предназначен для выдачи JWT административным пользователям UI/CLI.
В первой версии поддерживаются только предустановленные учётные записи `serg` и `igor`.
Сервис проверяет логин и пароль, хранит хэши в `runtime_credentials` и при успехе
возвращает access-токен для обращения к Admin API.

## Запрос
- `username` — строка в нижнем регистре длиной 3–64 символа, допустимы `a-z`, цифры,
  точки, дефисы и подчёркивания. Значение сравнивается без модификации.
- `password` — строка длиной 12–128 символов. Допустимы латиница, цифры и базовые
  спецсимволы ASCII; поле помечено форматом `password` и не логируется.

Неверный формат полей приводит к ответу `400` с кодом `invalid_payload` из общего
контракта ошибок Admin API.

## Ответ
Успешный ответ содержит объект `AuthToken`:
- `access_token` — JWT, подписанный HS256; значение соответствует шаблону
  `base64url(header).base64url(payload).base64url(signature)`.
- `token_type` — всегда `bearer`.
- `expires_in_sec` — срок действия токена в секундах. Значение совпадает с текущей
  конфигурацией `jwt_access_ttl_seconds` (по умолчанию 3600). Допустимый диапазон: 300–7200.

JWT включает claim'ы:
- `sub` — имя администратора (`serg`, `igor`).
- `permissions` — массив прав доступа. Минимальный набор: `settings:write`, `slots:write`,
  `stats:read`. Допускается расширение набора прав в будущем, UI обязан игнорировать незнакомые
  элементы.
- `exp` — UNIX-время истечения токена.
- `iat` — момент выпуска (используется для аудита и валидации re-issue).

Ответ сопровождается заголовками `Cache-Control: no-store` и `Pragma: no-cache`, чтобы
браузеры не кэшировали секреты.

## Конфигурация и секреты
- Алгоритм подписи: HS256 (HMAC-SHA256).
- Секрет: `AppConfig.jwt_secret`, поставляется через переменную окружения
  `PHOTOCHANGER_JWT_SECRET`. Секрет должен быть длиной ≥ 32 байта и ротуироваться вручную.
- Время жизни: `AppConfig.jwt_access_ttl_seconds`. По умолчанию 3600 секунд. Допустимые
  значения: 300–7200 секунд; выход за границы запрещён и приводит к ошибке конфигурации.
- Счётчики входа и токены хранятся в памяти сервиса; при перезапуске активные токены остаются
  валидными до истечения `exp`.

## Ошибки и троттлинг
- Неверная пара логин/пароль → `401 Unauthorized` с кодом `invalid_credentials`.
- Превышен лимит попыток входа → `429 Too Many Requests` с кодом `login_throttled`.
  Лимиты применяются по комбинации `username + remote_ip`: не более 5 попыток за 10 минут.
  Счётчик сбрасывается автоматически после окна и при успешном входе.
- Общие проблемы инфраструктуры (недоступная БД с credential, ошибка подписи) → `500`
  с кодами `internal_error`/`auth_service_failure`.

## Требования к журналированию
- Успешные входы логируются как `auth.login.success` без раскрытия пароля и токена.
- Ошибки авторизации фиксируются как `auth.login.failure` с полями `username`, `reason`
  (`invalid_credentials`, `throttled`).
- Для расследований хранится отметка времени и IP, но без хранения сессии в базе данных.
