# Правила настройки слотов

Этот документ описывает проверку, которую выполняет доменный сервис управления слотами при сохранении конфигурации.

## Допустимые провайдеры и операции

Перечень доступных поставщиков берётся из `configs/providers.json`. В текущей поставке поддерживаются два провайдера:

- **`gemini`** — операции `style_transfer`, `image_edit`, `identity_transfer`.
- **`turbotext`** — операции `style_transfer`, `image_edit`, `identity_transfer`.

Каждая операция содержит поле `needs`, определяющее обязательные ключи конфигурации. Перед сохранением слот должен указать ровно одну из описанных комбинаций `provider_id`/`operation_id`; любые другие значения будут отклонены.

## Валидация `settings_json`

1. **Полнота обязательных полей.** Для выбранной операции проверяется наличие всех ключей, перечисленных в `needs`. Отсутствие хотя бы одного поля приводит к ошибке сохранения.
2. **Шаблонные медиа.** Если в `settings_json` присутствует ключ `template_media`, он должен содержать массив строк или объектов с полем `setting_key`. Все такие ключи обязаны ссылаться на реально привязанные к слоту шаблоны (`slot_template.setting_key`). Пустые ссылки запрещены.
3. **Проверка состояния провайдера.** Перед обновлением слот блокируется, если в глобальных настройках (`Settings.provider_keys`) провайдер помечен как не сконфигурированный (`is_configured = False`).
4. **Дополнительные параметры.** Остальные значения `settings_json` сохраняются без изменений и передаются провайдеру «как есть», чтобы воркеры могли воспроизвести конфигурацию один в один.

Такие правила обеспечивают ссылочную целостность и предотвращают запуск слота с некорректными параметрами или отсутствующими шаблонными ресурсами.
