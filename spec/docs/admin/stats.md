# Статистика админ-панели

## Модели агрегаций

`src/app/schemas/stats.py` определяет единый набор структур для работы с
агрегированной статистикой:

- `StatsWindow` — перечисление поддерживаемых окон агрегации (`day`, `week`).
- `StatsCounters` — нормализованный набор счётчиков (успешные задачи, таймауты,
  ошибки провайдера, отмены, ошибки воркера, количество ingest-запросов).
  Вспомогательные методы позволяют безопасно приводить словари репозитория к
  модели и суммировать значения.
- `StatsMetric` — точка временного ряда с границами периода и счётчиками.
- `StatsSummary` — сводка, которую напрямую потребляет API. Поле `total_runs`
  считается на основе успешных/неуспешных запусков, дополнительное свойство
  `failure_count` упрощает отображение доли неудач.
- `StatsAggregation` — контейнер для результатов за конкретное окно, включает
  список метрик и готовую сводку.

Эти структуры используют `slots=True`, чтобы исключить случайное добавление
полей и уменьшить накладные расходы при сериализации.

## CachedStatsService

`src/app/services/stats.py` реализует `CachedStatsService`, который опирается на
интерфейс `StatsRepository`, нормализует диапазоны и использует кэш с раздельным
TTL:

- Поддерживаются окна `day` и `week`, выбираемые через параметр `window`.
- Для глобальной статистики применяется TTL 1 минута, для слотов — 5 минут.
  Значения можно переопределить при инициализации (`global_ttl`/`slot_ttl`),
  передача `timedelta(0)` отключает кэширование для выбранного типа агрегатов.
- Параметры `recent_results` (горизонт 72 ч, лимит 10 записей) конфигурируются
  через `AppConfig`/переменные окружения `PHOTOCHANGER_STATS_*` и применяются
  как в API, так и в воркерах.
- Диапазон `since` нормализуется: по умолчанию для слотов берутся последние 14
  дней (но не более 31 дня), для глобальной статистики — последние 8 недель (но
  не более 90 дней). Значения в будущем обрезаются до текущего момента.
- При запросе глобальной или слотовой статистики сервис формирует ключ вида
  `(slot_id, window, since)` и проверяет кэш. Значение `since` уже содержит
  нормализованный диапазон, поэтому записи с разными ограничениями диапазона не
  конфликтуют.
- Методы `collect_global_stats` и `collect_slot_stats` возвращают экземпляры
  `StatsAggregation`. Сводка вычисляется на основании метрик, полученных из
  репозитория.
- При вызове `record_processing_event` сервис пытается передать лог в
  `StatsRepository.store_processing_log` (если метод реализован) и инвалидирует
  все записи кэша для соответствующего слота, а также глобальные агрегаты.

Внутри сервис использует настраиваемый `clock`, что упрощает тестирование TTL.
Негативные значения TTL запрещены — выбрасывается `ValueError`.

## Контракт ProcessingLog

- JSON Schema: `spec/contracts/schemas/processing_log.json` (draft 2020-12) описывает обязательные поля `id`, `job_id`, `slot_id`, `status`, `occurred_at`, а также опциональные `message`, `provider_latency_ms` и структуру словаря `details`.
- OpenAPI: компоненты `ProcessingLog` и `ProcessingLogList` подключены через `spec/contracts/openapi.yaml` для будущих эндпоинтов админки и внешних аналитических интеграций.
- `details` допускает документированные ключи (`provider_id`, `provider_reference`, `attempt`, `error`, `expires_at`, `payload_path`, `result_file_path`, `result_checksum`, `inline_preview`, `failure_reason`) и дополнительные скалярные значения — StatsService обязан сохранять исходный порядок и не отбрасывать незнакомые поля.
- Поле `provider_latency_ms` фиксируется в миллисекундах и отсутствует, если событие относится к внутреннему действию (например, `received`).

## Интеграция с воркерами и JobService

Очередь воркеров (`QueueWorker`) уже публикует события через метод
`StatsService.record_processing_event`. Перед сохранением `CachedStatsService`
валидирует событие согласно `ProcessingLog` JSON Schema через библиотеку
`jsonschema` (draft 2020-12), что исключает попадание неконсистентных полей в
аналитику. После успешной проверки сервис автоматически инвалидирует кэш и, при
наличии репозитория, сохраняет лог для дальнейшей агрегации.
`JobService.append_processing_logs` продолжает писать данные в очередь, а
`StatsService` подписывается на те же события для обновления статистики.

## Тесты

`tests/unit/services/test_stats_service.py` покрывает основные сценарии:

- построение сводки из результатов репозитория,
- попадание/промахи кэша в зависимости от TTL,
- инвалидация кэша при поступлении новых логов, включая глобальные и
  слотовые ключи,
- делегирование сохранения логов в `StatsRepository`,
- валидация `ProcessingLog` перед записью (ошибочные события отклоняются).

Дополнительно `tests/contract/test_processing_log_schema.py` проверяет
положительные и отрицательные примеры сериализации журнала через библиотеку
`jsonschema`, чтобы гарантировать соответствие контракту.

Тесты используют заглушку репозитория и настраиваемые временные метки, что
позволяет моделировать различные окна и сценарии без обращения к БД.
