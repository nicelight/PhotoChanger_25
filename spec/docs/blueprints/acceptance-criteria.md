# Acceptance Criteria

## AC0. Аутентификация и секреты
- [ ] `/api/login` выдаёт JWT только для статических администраторов `serg` и `igor`; неизвестные логины или неверные пароли приводят к `401`, а частые попытки — к `429`.
- [ ] Выданный токен содержит claim `permissions` с набором прав пользователя и позволяет обращаться к эндпоинтам согласно брифу.
- [ ] `PUT /api/settings` позволяет ротацию ingest-пароля без перезапуска сервиса: значение хранится в `app_settings` в виде хэша и недоступно в ответе API.
- [ ] Запрос на обновление ingest-пароля требует токен с правом `settings:write` и фиксируется в журнале администрирования.

## AC1. Настройка слота
- [ ] API принимает и валидирует выбор провайдера и операции; при неверных полях возвращает `422` с подробностями.
- [ ] В списке всегда доступны 15 статических слотов (`slot-001` … `slot-015`); попытка обратиться к другому `slot_id` даёт `404`.
- [ ] Сохранённый слот возвращает актуальные настройки без индивидуальных секретов; UI строит ingest-ссылку по шаблону `<BASE_URL>/ingest/{slot_id}` и использует глобальный пароль из настроек.
- [ ] Изменение слота не влияет на уже запущенные Job; новые задачи используют обновлённые параметры.

## AC2. Ingest успешный (200 OK)
- [ ] При валидном пароле и файле Job создаётся в статусе `pending` и переходит в `processing`.
- [ ] Воркер завершает обработку до наступления `T_sync_response` и возвращает изображение.
- [ ] Исходный временный файл удаляется сразу после `is_finalized = true`.
- [ ] Итог сохраняется в полях `Job.result_*` и может быть перечитан до следующего запуска задачи; `result_inline_base64` очищается сразу после отправки ответа.

## AC3. Ingest с таймаутом (504)
- [ ] API прекращает ожидание строго по `T_sync_response` и отдаёт 504.
- [ ] Job фиксирует `is_finalized = true` и `failure_reason = 'timeout'`, дальнейшие ретраи не запускаются.
- [ ] Все временные файлы и сетевые операции воркера отменяются и очищаются.
- [ ] Поле `result_inline_base64`, если успело появиться до отмены, обнуляется и не сохраняется после ответа 504.

## AC4. Временные ссылки `media_object`
- [ ] Регистрация `media_object` всегда выдаёт `expires_at = created_at + T_public_link_ttl` (`T_sync_response`).
- [ ] Попытки запросить продление TTL отклоняются (`404/405`).
- [ ] По истечении TTL связанная задача фиксирует `failure_reason = 'timeout'`, а файл удаляется.

## AC5. Управление шаблонными медиа
- [ ] `POST /api/template-media/register` принимает только допустимые форматы и размеры; при превышении — `415/413`.
- [ ] Привязка к слоту обновляется атомарно; при удалении шаблона слоты теряют ссылки и уведомляют администратора.
- [ ] `DELETE /api/template-media/{id}` недоступен, если шаблон используется активным слотом без подтверждения.

## AC6. Мониторинг и алерты
- [ ] Метрики по p95 ingest, количеству активных Job и использованию `MEDIA_ROOT` доступны в системе мониторинга.
- [ ] Логи фиксируют входящие ingest, статусы Job и ошибки провайдеров без хранения бинарных данных.
- [ ] Алерт срабатывает при превышении доли Job с `failure_reason = 'timeout'` > 5% в течение 5 минут.
