# Оценка архитектуры PhotoChanger

## Методология проверки
- Синхронизированы требования из брифа с текущими SDD-документами и контрактами.
- Проверено соответствие доменной модели, контекстной диаграммы и расчёта дедлайнов целям асинхронного моста и TTL.
- Сверены схемы JSON и OpenAPI на наличие ключевых полей, необходимых для управления дедлайнами и очередью.

## Соответствие брифу
- Бриф задаёт архитектуру «асинхронного моста» с очередью в PostgreSQL, настраиваемым дедлайном `T_sync_response` (45–60 с) и единым контролем TTL через прямой расчёт `Job.expires_at`.【F:Docs/brief.md†L27-L110】
- Контекстная диаграмма и доменная модель фиксируют API, очередь, воркеры, адаптеры и хранилища в границах системы, что соответствует целевой архитектуре.【F:spec/docs/blueprints/context.md†L5-L33】【F:spec/docs/blueprints/domain-model.md†L1-L46】
- Blueprint контроля дедлайнов описывает прямое вычисление `Job.expires_at` и связывает его с TTL временных артефактов, что отвечает требованиям брифа по дедлайнам и очистке данных.【F:spec/docs/blueprints/deadline-guard.md†L1-L64】

## Обнаруженные расхождения
- JSON Schema `Job` в контрактах ранее не содержала поля `expires_at`, хотя бриф требует хранить и публиковать единый дедлайн задачи для API, воркеров и очистки; проблема устранена в текущем обновлении схемы.【F:spec/contracts/schemas/Job.json†L1-L64】【F:spec/docs/blueprints/deadline-guard.md†L15-L46】
- В NFR документе упоминалась возможность переключения между «in-process» и PostgreSQL очередью, что расходится с брифом, где очередь фиксирована в PostgreSQL как источник back-pressure.【F:spec/docs/blueprints/nfr.md†L9-L18】【F:Docs/brief.md†L31-L52】
- Открытых несоответствий между OpenAPI и брифом не выявлено: административные эндпоинты `/api/jobs` и `/api/jobs/{job_id}` задокументированы в обеих артефактах и используют прямой расчёт `job.expires_at` и `remaining_ms`, получаемые из конфигурации приложения.【F:spec/contracts/openapi.yaml†L250-L360】【F:Docs/brief.md†L1127-L1200】

## Рекомендации
1. Зафиксировать `Job.expires_at` в схемах и API-ответах как обязательное поле, чтобы клиенты и воркеры имели единый дедлайн (исправлено в текущем обновлении схемы).【F:spec/contracts/schemas/Job.json†L1-L64】
2. Уточнить NFR, исключив упоминание «in-process» очереди или описав миграционный сценарий, чтобы не создавать ложные ожидания относительно архитектуры очереди.【F:spec/docs/blueprints/nfr.md†L9-L18】
3. Продолжить проверку контрактов на наличие ключевых дедлайнов и метрик (например, включение `expires_at` в административные ответы о задачах), чтобы единый расчёт дедлайна оставался источником истины.

## Вывод
Основная архитектура (API → очередь PostgreSQL → воркеры → адаптеры) и механизмы расчёта дедлайнов корректно отражены в спецификациях и соответствуют брифу. Точечные корректировки — фиксация `Job.expires_at` в контрактах и уточнение формулировок в NFR — позволяют устранить найденные несоответствия и поддерживать оптимальный дизайн асинхронного моста.
