# Оценка архитектуры PhotoChanger

## Методология проверки
- Синхронизированы требования из брифа с текущими SDD-документами и контрактами.
- Проверено соответствие доменной модели, контекстной диаграммы и DeadlineGuard целям асинхронного моста и TTL.
- Сверены схемы JSON и OpenAPI на наличие ключевых полей, необходимых для управления дедлайнами и очередью.

## Соответствие брифу
- Бриф задаёт архитектуру «асинхронного моста» с очередью в PostgreSQL, дедлайном `T_sync_response` ≤ 50 с и единым контролем TTL через DeadlineGuard.【F:Docs/brief.md†L27-L69】
- Контекстная диаграмма и доменная модель фиксируют API, очередь, воркеры, адаптеры и хранилища в границах системы, что соответствует целевой архитектуре.【F:spec/docs/blueprints/context.md†L5-L33】【F:spec/docs/blueprints/domain-model.md†L1-L46】
- Blueprint DeadlineGuard описывает централизованное вычисление `Job.expires_at` и связывает его с TTL временных артефактов, что отвечает требованиям брифа по дедлайнам и очистке данных.【F:spec/docs/blueprints/deadline-guard.md†L1-L74】

## Обнаруженные расхождения
- JSON Schema `Job` в контрактах не содержала поля `expires_at`, хотя DeadlineGuard и бриф требуют хранить и публиковать единый дедлайн задачи для API, воркеров и очистки.【F:spec/contracts/schemas/Job.json†L1-L60】【F:spec/docs/blueprints/deadline-guard.md†L29-L65】
- В NFR документе упоминалась возможность переключения между «in-process» и PostgreSQL очередью, что расходится с брифом, где очередь фиксирована в PostgreSQL как источник back-pressure.【F:spec/docs/blueprints/nfr.md†L9-L18】【F:Docs/brief.md†L31-L52】

## Рекомендации
1. Зафиксировать `Job.expires_at` в схемах и API-ответах как обязательное поле, чтобы клиенты и воркеры имели единый дедлайн (исправлено в текущем обновлении схемы).【F:spec/contracts/schemas/Job.json†L1-L64】
2. Уточнить NFR, исключив упоминание «in-process» очереди или описав миграционный сценарий, чтобы не создавать ложные ожидания относительно архитектуры очереди.【F:spec/docs/blueprints/nfr.md†L9-L18】
3. Продолжить проверку контрактов на наличие ключевых дедлайнов и метрик (например, включение `expires_at` в административные ответы о задачах) при расширении API, чтобы DeadlineGuard оставался источником истины.

## Вывод
Основная архитектура (API → очередь PostgreSQL → воркеры → адаптеры) и механизмы DeadlineGuard корректно отражены в спецификациях и соответствуют брифу. Точечные корректировки — фиксация `Job.expires_at` в контрактах и уточнение формулировок в NFR — позволяют устранить найденные несоответствия и поддерживать оптимальный дизайн асинхронного моста.
