# Ограничения, допущения и риски

## Технические ограничения
- `T_sync_response` настраивается в диапазоне 45–60 с: ingest обязан завершить запрос (200/504) до наступления актуального дедлайна, независимо от состояния провайдера. (`/Docs/brief.md`)
- Временные медиа (`media_object`) живут фиксированный TTL `T_public_link_ttl = T_sync_response` и не продлеваются автоматически воркерами. (`/Docs/brief.md`)
- Обработанные результаты хранятся в составе Job как последний ответ и автоматически очищаются по TTL 72 часов. (`/Docs/brief.md`)
- Gemini Files API: размеры файлов ≤ 2 ГБ, типы MIME ограничены (JPEG, PNG, WEBP, HEIC/HEIF); квоты 500 req/min и 2 000 req/day. (`/Docs/brief.md`)
- Turbotext: требует публичные ссылки и использует только polling; идентификатор `queueid` сохраняется в `Job.provider_job_reference` для фонового опроса. (`/Docs/brief.md`)
- Очередь задач реализована исключительно на PostgreSQL (`job` + `SELECT … FOR UPDATE SKIP LOCKED`), поэтому требуется поддерживать индексы и мониторинг блокировок. (`/Docs/brief.md`)

## Организационные ограничения
- JWT выдаётся встроенным сервисом `/api/login` для статических администраторов (`serg`, `igor`); их пароли генерируются на деплое и хранятся в `secrets/runtime_credentials.json`, доступ к которому ограничен.
- Ingest-пароль хранится в `app_settings` в виде хэша и обновляется через `PUT /api/settings`; требуется двусторонняя аутентификация администратора и протоколирование операций.
- Управление TLS и базовой авторизацией (сертификаты, ключи) выполняет команда инфраструктуры, приложение должно поддерживать конфигурацию через переменные окружения.
- Любые новые провайдеры добавляются только после обновления брифа и расширения контрактов.

## Бизнес-допущения
- Пользователи DSLR Remote Pro могут обновлять приложение для использования новых ingest-ссылок без изменений в рабочем процессе.
- Администраторы готовы повторно регистрировать временные файлы, если требуется сохранить доступ к предпросмотрам после истечения TTL.
- Лимиты провайдеров не будут превышаться при текущем объёме обработок; при росте нагрузки будут настроены rate-limiters.

## Риски и меры
| Риск | Описание | Митигирующие действия |
| --- | --- | --- |
| Просрочка `T_sync_response` | Система обязана немедленно отменять задачу при таймауте; нарушение ведёт к зависанию ресурсов. | Явное прерывание задач при наступлении дедлайна, отмена HTTP-запросов к провайдеру, очистка временных файлов. |
| Переполнение временного хранилища | Очередь ingest превышает доступное дисковое пространство в `MEDIA_ROOT`. | Мониторинг объёма, ограничения `MEDIA_MAX_FILE_SIZE_MB`, автоматический GC и алерты. |
| Нарушение лимитов провайдера | Gemini/Turbotext отклоняют запросы из-за квот и форматов. | Валидация MIME/размеров, rate-limiting на адаптере, конфигурация параллелизма. |
| Утечка публичных ссылок | Временные URL доступны после завершения задачи. | TTL фиксирован как `T_public_link_ttl = T_sync_response`, автоматическая очистка при `is_finalized = true`, отсутствие механизма продления. |
| Потеря результата после 504 | Клиент не получает изображение, даже если провайдер вернул его позже. | Фиксация `failure_reason = 'timeout'`, информирование клиента о необходимости перезапуска ingest. |
| Несогласованность слотов | Администраторы меняют настройки во время активных задач. | Версионирование `Slot.updated_at`, логирование изменений, применение новых настроек только на будущие Jobs. |
| Падение воркера/очереди | Задачи застревают в статусе `pending`. | Heartbeat и автоперезапуск воркеров, idempotent подбор задач (PG `FOR UPDATE SKIP LOCKED`). |
| Компрометация статических администраторов | Утечка файла `secrets/runtime_credentials.json` или подбор паролей `serg`/`igor` приводит к выпуску JWT с повышенными правами. | Ограничение доступа к файлу, хранение только хэшей, rate-limit на `/api/login`, журналирование и ручная смена паролей через перегенерацию секрета. |
| Утечка ingest-пароля | Компрометация `app_settings["ingest.dslr_password"]` позволяет неавторизованным клиентам запускать ingest. | Хранение только хэша и соли, ротация через `PUT /api/settings`, аудит операций и секретов, регулярная смена пароля по расписанию. |

## Предметы, требующие дальнейшей проработки
- Тонкая настройка параметров PostgreSQL для очереди (индексация `job.status`, контроль `vacuum` и лимитов хранения).
- Расширение списка провайдеров и абстракция общих операций (требует обновления брифа).
- Оценка необходимости расширения хранения результатов сверх одного последнего ответа в Job.
