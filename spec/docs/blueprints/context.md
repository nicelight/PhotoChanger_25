# Контекст и границы PhotoChanger

## Системная граница
Платформа PhotoChanger развёрнута как HTTP-сервер, принимающий ingest-запросы и управляющий AI-обработкой фотографий согласно утверждённым продуктовым требованиям. Система включает:
- Ingest API c валидацией входящих POST от DSLR Remote Pro.
- Очередь задач на PostgreSQL и воркеры.
- Адаптеры провайдеров (Gemini, Turbotext и др.).
- Временное и постоянное медиа-хранилище.
- Публичная выдача итоговых файлов с TTL 72 часа (`T_result_retention`).
- Административный UI/API для управления слотами, пользователями и шаблонными медиа.
- Встроенный сервис аутентификации (`/api/login`), выдающий JWT для статических администраторов (`serg`, `igor`).

## Внешние акторы
- **DSLR Remote Pro** — отправляет `POST /ingest/{slotId}` с фото и секретом.
- **Администратор** — настраивает слоты, загружает шаблонные медиа, управляет секретами (ingest-пароль) и инициирует их ротацию.
- **AI-провайдеры** — внешние API, выполняющие операции по настройкам слота.
- **Система мониторинга/логирования** — получает технические метрики и алерты.
- **Потребители публичных ссылок** — Turbotext, UI и другие клиенты, скачивающие временные файлы по `GET /public/media/{id}` и итоговые изображения по `GET /public/results/{job_id}`.

## Диаграмма контекста
```mermaid
flowchart LR
    subgraph PhotoChanger Platform
        API[Ingest & Admin API]
        Queue[Очередь задач]
        Worker[AI Workers]
        Storage[Media Storage]
        Providers[Адаптеры провайдеров]
        UI[Slot Management UI]
    end

    DSLR[DSLR Remote Pro] -->|POST /ingest/{slotId}| API
    Admin[Администратор] -->|JWT + UI/API| UI
    Admin -->|/api/login| API
    UI -->|Конфигурация слотов| API
    UI -->|GET /public/results/{job_id}| API
    API --> Queue
    Queue --> Worker
    Worker --> Providers
    Providers --> Worker
    Worker --> Storage
    Storage -->|GET /public/media/{id}| ExternalClient[Провайдеры, скачивающие public_url]
    API -->|Публичная ссылка на результат| Gallery[UI/Пользователи, скачивающие итог]
    API -->|Результат / 504| DSLR
    Monitoring[Мониторинг/Логи] <-->|Метрики, события| API
```

## Scope и out-of-scope
### Внутри границ
- Управление жизненным циклом Slot и Job.
- Очередь задач с контролем дедлайна `T_sync_response`.
- Настройка значения `T_sync_response` через административную страницу настроек UI (диапазон 45–60 с) с автоматическим пересчётом зависимых TTL.
- Валидация и очистка временных медиа-объектов.
- Интеграция с Gemini и Turbotext по действующим контрактам платформы.
- Управление статическими администраторами (`serg`, `igor`) и выдача JWT непосредственно сервисом (`/api/login`).
- Хранение и ротация ingest-пароля через `PUT /api/settings` без участия внешних систем.

### Вне границ (требуют отдельного согласования)
- Регистрация новых пользователей, восстановление доступа и self-service смена паролей (вне объёма MVP со статическими учётками).
- Подключение внешнего Identity Provider или федерации учётных записей.
- Расширенные UI-фичи (advanced analytics, drag&drop верстка) сверх базовой настройки слотов.
- Автоматическое продление TTL воркерами после финальных статусов.
- Масштабирование очереди за пределы PostgreSQL (например, Kafka) — рассматривается в будущих итерациях.

## Зависимости и интеграции
- Подключение к файловой системе/облачному стореджу для `MEDIA_ROOT`.
- Доступ к внешнему интернету для вызовов AI-провайдеров и отдачи публичных ссылок.
- Поддержание TLS-сертификатов для HTTPS, чтобы соответствовать требованиям безопасности ingest и публичных ссылок.
