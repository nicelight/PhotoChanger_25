# Нефункциональные требования

## Производительность
- Время ответа ingest API при успешной обработке ≤ `T_sync_response` (настраивается в диапазоне 45–60 с, по умолчанию 48 с). (`/Docs/brief.md`)
- Очередь должна поддерживать back-pressure: новые запросы блокируются/отклоняются, если воркеры не успевают обрабатывать задачи.
- Публичные медиа выдаются без задержек, достаточных для скачивания провайдером до истечения TTL.

## Надёжность
- При наступлении 504 воркеры обязаны прервать попытки и освободить ресурсы (idempotent отмена).
- Очередь/воркеры восстанавливаются после перезапуска без потери задач (использование PG `SELECT ... FOR UPDATE SKIP LOCKED`).
- Ретраи ограничены конфигурацией (N попыток) и не выходят за дедлайн `T_sync_response`.

## Масштабируемость
- Очередь задач фиксирована на PostgreSQL и должна выдерживать рост нагрузки за счёт масштабирования базы и воркеров без смены
  механизма очереди.
- Возможность горизонтального масштабирования воркеров с учётом лимитов провайдера (rate-limit).

## Безопасность
- Все административные запросы требуют `Authorization: Bearer <JWT>`; права разделены на чтение/запись слотов и медиа.
- TLS обязателен для ingest и публичных ссылок; сертификаты обновляются без простоя.
- Не допускается логирование бинарных данных изображений и секретов (паролей, токенов провайдеров).
- `/api/login` выдаёт JWT только статическим администраторам (`serg`, `igor`); пароли генерируются на деплое, сохраняются в `secrets/runtime_credentials.json` и обрабатываются в виде хэшей.
- Ротация ingest-пароля выполняется администраторами через `PUT /api/settings`; операция журналируется и требует повторной аутентификации токеном с правом `settings:write`.

## Наблюдаемость и алертинг
- Логируются статусы Job, переходы состояний, финализации, таймауты, ретраи и ошибки провайдеров.
- Метрики: p95 времени ingest, количество активных Job по статусам, использование диска `MEDIA_ROOT`, частота 504.
- Алерты на переполнение очереди, превышение доли Job с `failure_reason = 'timeout'`, недоступность провайдеров.

## Сервисабилити
- Документация по слотам, провайдерам и медиа доступна в `/spec/docs` и обновляется вместе с контрактами.
- Скрипты обслуживания (`scripts/dev.sh`, очистители) запускаются одной командой и логируют результат.

## Соответствие требованиям провайдеров
- Gemini: соблюдение квот 500 req/min, 2 000 req/day, допустимых MIME и размера файлов ≤ 2 ГБ.
- Turbotext: мгновенная доступность публичных ссылок (`TTL = T_public_link_ttl = clamp(T_sync_response, 45, 60)`), хранение `queueid`/`asyncid`, поддержка webhook.

## Управление данными
- Исходные файлы удаляются сразу после `is_finalized = true` либо по наступлении `T_ingest_ttl`.
- Результаты хранятся в полях `Job.result_*` и автоматически очищаются по TTL 72 часа (`media_cache.processed_media_ttl_hours`); временное поле `result_inline_base64` очищается немедленно после выдачи HTTP 200/504, а новое выполнение перезаписывает предыдущий ответ.
- Публичные ссылки живут фиксированный TTL `T_public_link_ttl = clamp(T_sync_response, 45, 60)` и не продлеваются: при необходимости требуется повторная регистрация файла.
