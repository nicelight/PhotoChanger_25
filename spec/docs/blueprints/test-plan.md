# Test Plan PhotoChanger

## Цели тестирования
Подтвердить, что реализация соответствует контрактам брифа `/Docs/brief.md`, покрывает ключевые use-cases и выдерживает нефункциональные требования (таймауты, очистку медиа, лимиты провайдеров).

## Уровни тестирования
- **Unit**
  - Валидация параметров слотов и операций провайдеров.
  - Парсинг/генерация запросов к Gemini и Turbotext, преобразование ответов в доменные сущности.
  - Управление состояниями Job (переходы, дедлайны, отмена).
- **Contract**
  - Проверка соответствия API `POST /ingest/{slotId}`, `/api/media/register`, `/public/media/{id}` спецификациям (`spec/contracts`).
  - JSON Schema для `Slot`, `Job`, `MediaObject`.
  - Валидация `SlotStatsResponse` — `summary.last_reset_at` присутствует и соответствует формату `date-time`.
  - Аутентификация: `POST /api/login` выдаёт JWT только для `serg`/`igor`, неверные пары получают `401`, повторные попытки ограничены `429`.
  - Управление настройками: `GET/PUT /api/settings` не раскрывают ingest-пароль в ответе, принимают только хэшируемое значение для ротации и позволяют обновить `ingest.sync_response_timeout_sec` в диапазоне 45–60 секунд с пересчётом TTL в ответе.
  - **Integration**
    - Интеракция API ↔ очередь ↔ воркеры с моками провайдеров.
    - Очистка медиа после финализации Job; подтверждение заполнения полей `Job.result_*` и временного `result_inline_base64` с последующим обнулением.
    - Сценарий таймаута 504 удостоверяется, что `result_inline_base64` очищается сразу после ответа и не остаётся в записи Job.
    - Автоистечение `media_object` через `T_public_link_ttl = T_sync_response` секунд и установка `failure_reason = 'timeout'` без ручного продления.
    - Ротация ingest-пароля через `PUT /api/settings` обновляет конфигурацию без прерывания активных ingest и сохраняет аудит операции.
  - **E2E**
    - Полный ingest с успешным завершением в пределах актуального `T_sync_response` (45–60 с).
    - Инжест с таймаутом: мок провайдера задерживает ответ дольше `T_sync_response`, система отдаёт 504 и очищает данные.
    - Сценарии Turbotext: регистрация public_url, polling `do=get_result` с фиксацией `queueid`, обработка ответа внутри окна ожидания и завершение задачи без webhook.
    - Смена ingest-пароля: администратор получает новый JWT, обновляет пароль через `/api/settings`, после чего ingest принимает только новое значение.

## Инструменты и окружение
- Тестовый раннер: `pytest` (unit/integration/e2e), дополнительно `schemathesis` или `pytest` с JSON Schema для контрактов.
- Моки провайдеров: локальные HTTP-серверы или фикстуры, эмулирующие ответы Gemini/Turbotext.
- Инструменты генерации стаба: `scripts/gen_stubs.py` (после обновления контрактов).
- CI pipeline запускает `scripts/dev.sh`, включающий линтеры, тесты и статический анализ.

## Ответственность
- **Разработчики backend** — unit/contract tests, поддержка моков провайдеров, интеграционные сценарии.
- **Команда QA** — e2e сценарии, ручная проверка UI, контроль чек-листов приёмки.
- **DevOps/Инфраструктура** — нагрузочное тестирование ingest, мониторинг и алерты, проверка очистки диска.

## Покрытие NFR
- Замеры времени ответов ingest и количества 504 фиксируются во время e2e тестов (сценарий "успех" и "таймаут").
- Тесты мониторинга проверяют публикацию метрик и логов при изменении статуса Job.
- Отдельные тесты валидации гарантируют отсутствие логирования бинарных данных.

## Матрица трассируемости
| Use-case | Unit | Contract | Integration | E2E |
| --- | --- | --- | --- | --- |
| UC1 Настройка слота | ✅ Валидаторы слотов | ✅ Admin API схемы | ✅ Сохранение + обновление слота | ⚪ (UI smoke в ручном режиме) |
| UC2 Ingest успех | ✅ State machine Job (включая `is_finalized`) | ✅ POST /ingest schema | ✅ Очередь ↔ провайдер | ✅ Полный поток Gemini |
| UC3 Ingest 504 | ✅ Таймауты Job (`failure_reason`) | ✅ POST /ingest 504 case | ✅ Отмена воркера | ✅ Полный поток с задержкой |
| UC4 Истечение медиа | ✅ Таймер TTL (`T_sync_response` сек) | ✅ Регистрация `/api/media/register` | ✅ Автоудаление записи | ✅ Сценарий с Turbotext |
| UC5 Шаблонные медиа | ✅ Проверка MIME/размера | ✅ Template media API | ✅ Привязка к слоту | ⚪ Ручной smoke |

## Выходные артефакты
- Отчёт о прогонах тестов (CI pipeline).
- Логи e2e тестов с подтверждением очистки медиа и соблюдения таймаутов.
- Обновлённые диаграммы/контракты при обнаружении расхождений.
