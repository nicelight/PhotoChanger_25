# Test Plan PhotoChanger

## Цели тестирования
Подтвердить, что реализация соответствует контрактам брифа `/Docs/brief.md`, покрывает ключевые use-cases и выдерживает нефункциональные требования (таймауты, очистку медиа, лимиты провайдеров).

## Уровни тестирования
- **Unit**
  - Валидация параметров слотов и операций провайдеров.
  - Парсинг/генерация запросов к Gemini и Turbotext, преобразование ответов в доменные сущности.
  - Управление состояниями Job (переходы, дедлайны, отмена).
- **Contract**
  - Проверка соответствия API `POST /ingest/{slotId}`, `/api/media/register`, `/api/media/extend`, `/public/media/{id}` спецификациям (`spec/contracts`).
  - JSON Schema для `Slot`, `Job`, `Result`, `MediaObject`.
  - Валидация `SlotStatsResponse` — `summary.last_reset_at` присутствует и соответствует формату `date-time`.
- **Integration**
  - Интеракция API ↔ очередь ↔ воркеры с моками провайдеров.
  - Очистка медиа после финальных статусов; связь Job ↔ Result.
  - Продление `media_object` в статусах `pending/processing`.
- **E2E**
  - Полный ingest с успешным завершением в пределах 50 секунд.
  - Инжест с таймаутом: мок провайдера задерживает ответ, система отдаёт 504 и очищает данные.
  - Сценарии Turbotext: регистрация public_url, polling/webhook ответ, закрытие задачи.

## Инструменты и окружение
- Тестовый раннер: `pytest` (unit/integration/e2e), дополнительно `schemathesis` или `pytest` с JSON Schema для контрактов.
- Моки провайдеров: локальные HTTP-серверы или фикстуры, эмулирующие ответы Gemini/Turbotext.
- Инструменты генерации стаба: `scripts/gen_stubs.py` (после обновления контрактов).
- CI pipeline запускает `scripts/dev.sh`, включающий линтеры, тесты и статический анализ.

## Ответственность
- **Разработчики backend** — unit/contract tests, поддержка моков провайдеров, интеграционные сценарии.
- **Команда QA** — e2e сценарии, ручная проверка UI, контроль чек-листов приёмки.
- **DevOps/Инфраструктура** — нагрузочное тестирование ingest, мониторинг и алерты, проверка очистки диска.

## Покрытие NFR
- Замеры времени ответов ingest и количества 504 фиксируются во время e2e тестов (сценарий "успех" и "таймаут").
- Тесты мониторинга проверяют публикацию метрик и логов при изменении статуса Job.
- Отдельные тесты валидации гарантируют отсутствие логирования бинарных данных.

## Матрица трассируемости
| Use-case | Unit | Contract | Integration | E2E |
| --- | --- | --- | --- | --- |
| UC1 Настройка слота | ✅ Валидаторы слотов | ✅ Admin API схемы | ✅ Сохранение + обновление слота | ⚪ (UI smoke в ручном режиме) |
| UC2 Ingest успех | ✅ State machine Job | ✅ POST /ingest schema | ✅ Очередь ↔ провайдер | ✅ Полный поток Gemini |
| UC3 Ingest 504 | ✅ Таймауты Job | ✅ POST /ingest 504 case | ✅ Отмена воркера | ✅ Полный поток с задержкой |
| UC4 Продление медиа | ✅ Валидатор TTL | ✅ /api/media/extend | ✅ Обновление expires_at | ✅ Сценарий с Turbotext |
| UC5 Шаблонные медиа | ✅ Проверка MIME/размера | ✅ Template media API | ✅ Привязка к слоту | ⚪ Ручной smoke |

## Выходные артефакты
- Отчёт о прогонах тестов (CI pipeline).
- Логи e2e тестов с подтверждением очистки медиа и соблюдения таймаутов.
- Обновлённые диаграммы/контракты при обнаружении расхождений.
