# Vision PhotoChanger

## Цель продукта
Создать серверную платформу обработки фотографий с AI-провайдерами, которая позволяет администраторам настраивать "слоты" обработки и принимать ingest-запросы от DSLR Remote Pro в течение окна синхронного ожидания ≤ 50 секунд, возвращая результат или консистентно завершая запрос ошибкой 504 согласно `/Docs/brief.md`.

## Уникальная ценность
- Единая точка интеграции с несколькими провайдерами (Gemini, Turbotext и др.) с учётом их лимитов, форматов и квот.
- Сохранение консистентности медиа-объектов: исходные файлы живут только в статусах `pending/processing`, а результаты фиксируются в полях `Job.result_*` как последний успешный ответ.
- Управление слотовыми настройками через UI с выдачей ingest-ссылок, которые совместимы с DSLR Remote Pro без доработок клиента.

## Целевые пользователи и заинтересованные стороны
- **Администраторы контента** — создают и настраивают слоты, управляют шаблонными медиа.
- **Операторы студий** — запускают обработку из DSLR Remote Pro, контролируют статусы задач.
- **AI-провайдеры** — внешние сервисы, предоставляющие модели обработки изображений.
- **Команда эксплуатации** — следит за метриками, логами, перезапусками очереди и очистителями медиа.

## Целевые метрики успеха
- ≥ 95% ingest-запросов завершаются статусом 200 в пределах `T_sync_response` (≤ 50 с) без превышения лимитов провайдера.
- Доля Job с `failure_reason = 'timeout'` ≤ 5% при номинальной нагрузке и корректной конфигурации слотов.
- 0 утечек временных файлов после наступления TTL; фоновые очистители завершают цикл ≤ 1 минуты после истечения срока.
- SLA доступности ingest API ≥ 99% в рабочее время.

## Границы MVP
- Поддержка минимум двух провайдеров (Gemini и Turbotext) с разными режимами (синхронный ответ, очередь и webhook).
- Очередь задач реализована как единая персистентная очередь на PostgreSQL (`job` + `SELECT … FOR UPDATE SKIP LOCKED`).
- JWT-аутентификация для административных операций выдаётся самим сервисом (`POST /api/login`) для статических пользователей `serg` и `igor`; ingest ссылки защищены единым паролем, который хранится в `app_settings` и ротируется через `PUT /api/settings` без простоя.
- Нет автоматического продления TTL: временные ссылки живут 60 секунд и после истечения удаляются без возможности продления.

## Внешние ограничения и зависимости
- DSLR Remote Pro формирует фиксированный multipart POST с полями `password`, данными файла и метаданными; сервер должен корректно обрабатывать вариации необязательных полей.
- Лимиты провайдеров (размер файлов Gemini ≤ 2 ГБ, набор допустимых MIME: JPEG/PNG/WEBP/HEIC/HEIF и др.) диктуют валидацию входных данных.
- Публичное медиа-хранилище должно гарантировать доступность временных ссылок полные 60 секунд; дедлайн `Job.expires_at` фиксируется как `max(T_sync_response, MEDIA_PUBLIC_LINK_TTL_SEC)`, чтобы очистка и фоновые воркеры не завершали задачу раньше этого окна.【F:Docs/brief.md†L19-L24】【F:Docs/brief.md†L108-L137】

## Стратегические вехи
1. Завершение пакета SDD (Vision → Контекст → Доменные модели → Контракты).
2. Реализация контрактов ingest/media + стабы API.
3. Интеграция очереди, воркеров и первого провайдера (Gemini).
4. Подключение Turbotext с публичными ссылками, настройка очистителей медиа.
5. Вывод MVP в эксплуатацию с мониторингом и ретраями.
