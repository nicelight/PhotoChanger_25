# Constraints & Risks — PhotoChanger

## 1. Ограничения (Constraints)
- **KISS-монолит**: один процесс FastAPI + uvicorn, PostgreSQL 15, локальное файловое хранилище; внешние очереди и воркеры запрещены (ADR-0001).
- **SLA ingest**: `T_sync_response` в пределах 10–60 с, по умолчанию 48 с. Провайдеры, не укладывающиеся в окно, не поддерживаются без отдельного ADR.
- **Concurrency cap**: до 30 параллельных ingest-запросов (подтверждено тимлидом 2025-10-31); внешний rate limiting не планируется.
- **Media TTL**: итоговые файлы доступны 72 ч; временные медиа и провайдерские ссылки живут не дольше `T_sync_response`.
- **Security**: ingest пароль глобален и хранится в plaintext в settings; админ-доступ — только статические аккаунты `serg`/`igor`.
- **Storage footprint**: медиахранилище разделено на `temp/` и `results/`; использование облачных CDN отложено.

## 2. Допущения (Assumptions)
- DSLR Remote Pro продолжит использовать существующий multipart формат без breaking изменений.
- Провайдеры Gemini и Turbotext гарантируют ответ ≤60 с при корректных платёжных лимитах; quota-исчерпание рассматривается как `provider_error`.
- Cron-среда доступна каждые 15 мин и умеет запускать Python-скрипты с доступом к `media/` и БД.
- Ops-команда мониторит `/metrics` и реагирует на алерты p95/504, заполняемость диска и ошибки cron.
- TLS и секреты (API keys) поставляются внешней командой эксплуатации; репозиторий не хранит приватных ключей.

## 3. Риски и меры
| Риск | Вероятность | Влияние | Митигирующая мера |
|------|-------------|---------|-------------------|
| Провайдер отвечает > `T_sync_response` | Средняя | Рост 504, нарушение SLA | Явные таймауты `asyncio.wait_for`, логирование, возможность переключения слота на другого провайдера; алерты по доле 504. |
| Переполнение `media/results` | Средняя | Потеря диска, сбои ingest | Cron `cleanup_media.py`, мониторинг размера каталогов, ручной рестарт очистки через Ops. |
| Ошибки конфигураций слотов | Средняя | Некорректная обработка | Валидация схем `PUT /api/slots/{slot_id}`, журнал изменений, тестовые слоты перед продом. |
| Утечка ingest пароля (plaintext) | Средняя | Неавторизованные запросы | TLS, доступ к `/api/settings` только админам, регулярная ротация через UI, запрет логирования значения, контроль прав на БД/бэкапы, throttling 10 неверных попыток (15 мин блокировка). |
| Недоступность PostgreSQL | Низкая | Приём ingest невозможен | Health-check `/healthz`, метрики, резервные копии, автоматический перезапуск. |
| Cron не запустился | Низкая | Накопление просроченных медиа | Логи cron, алерты на отсутствие записей `cleaned_at`, ручной запуск. |
