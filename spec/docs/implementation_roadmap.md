# Roadmap реализации платформы PhotoChanger

## Фаза 0. Аналитика и синхронизация SDD
- Сверить требования брифа и существующих документов (`spec/docs`, `spec/contracts`) и задокументировать расхождения для цикла Re-Sync. Обновить чек-лист контроля из `agents.md`.
- Уточнить артефакты SDD, требующие доработки (vision, context, domain model, test plan) и спланировать ревью согласно `spec/docs/sdd_roadmap.md`.

## Фаза 1. Контракты и схемы (SPEC REVIEW)
- Провести ревью `spec/contracts/openapi.yaml`, подтвердить покрытие всех описанных в брифе сценариев и статусов, оформить протокол ревью без изменения файлов, если расхождений не выявлено.
- Проверить актуальность JSON Schema для сущностей `Slot`, `Job`, `MediaObject`, `TemplateMedia`, `Result`, `Settings`, `AuthToken`, `Error` и др.; при отсутствии расхождений зафиксировать это в протоколе.
- Убедиться, что спецификации провайдеров (Gemini, Turbotext) в `spec/contracts/providers/*.md` соответствуют лимитам и форматам, ожидаемым в реализации. Фиксировать только найденные несоответствия.
- Подготовить ADRы по ключевым решениям (хранение TTL, polling БД, очистка медиа) со ссылкой на бриф.

## Фаза 2. Генерация стабов и scaffolding (STUBS GEN)
- Перегенерировать контроллеры и DTO из актуального OpenAPI только при изменении контрактов; иначе подтвердить готовность текущих стабов.
- Провести аудит существующих каркасов доменных сервисов (`JobService`, `SlotService`, `SettingsService`, `MediaService`, `StatsService`) и адаптеров провайдеров, отметить доработки, необходимые перед реализацией.
- Проверить наличие каркаса очереди на PostgreSQL (`JobRepository`, `QueueWorker`), интерфейсов хранения медиа и таймеров TTL; создать недостающие элементы.
- Уточнить структуру UI (страницы списка слотов, настройки слота, статистика, просмотр результатов), дополнить отсутствующие заглушки без бизнес-логики.

## Фаза 3. Тестирование контрактов и инфраструктуры (CONTRACT TESTS GREEN)
- К старту фазы предположительно готовы: автосгенерированные контроллеры и DTO без бизнес-логики, каркасы `JobService`, `SlotService`, `QueueWorker`, интерфейсы стораджа и провайдеров, а также конфигурация приложения, поднимающая сервер со стабами. Эти элементы собраны на Фазе 2 и служат тестовым стендом.
- Реализовать контрактные тесты API (используя схемы) для всех эндпоинтов: позитивные и негативные сценарии, статусы ошибок и валидации.
- Создать интеграционные тесты очереди: постановка `Job`, обработка воркером, соблюдение дедлайна `expires_at`, ручная отмена.
- Подготовить моки провайдеров Gemini и Turbotext с режимами успеха, таймаута и ошибок, поддерживающими требуемые MIME и размеры.
- Проверить расчёт TTL (`T_sync_response`, `T_public_link_ttl`, `T_result_retention`) и очистку артефактов через unit-тесты доменных функций.

### Как выглядит Фаза 3 на практике (простое объяснение)
- **Проверяем, что «договорённости» по API соблюдаются.** Берём описанные ранее правила обмена данными (контракты) и запускаем небольшие программы-проверки. Они отправляют примерные запросы к серверу и убеждаются, что сервер отвечает именно так, как обещано в спецификациях.
- **Убеждаемся, что очередь задач работает как конвейер.** В тестовой базе создаём задания на обработку фото и включаем тестовый рабочий процесс. Смотрим, что задания доходят до «воркера», вовремя завершатся или отменяются, если время вышло.
- **Меняем провайдеров на «муляжи».** Вместо настоящих Gemini и Turbotext подключаем учебные заглушки. Они умеют отвечать «успехом», «ошибкой» или «долго молчать», чтобы мы видели, как наш сервер реагирует на разные ситуации без риска и лишних затрат.
- **Следим, чтобы временные таймеры не подвели.** Вручную запускаем тесты, которые проверяют расчёт сроков хранения результатов и своевременное удаление лишних файлов, чтобы потом в продакшне не заполнять диск.

## Фаза 4. Реализация серверного приложения (IMPL)

### 4.1 Ingest и очередь
- Имплементировать Ingest API: валидация входа, создание `Job`, сохранение payload, polling статуса, возврат 200/504 с соблюдением дедлайна.
- Реализовать очередь задач на PostgreSQL с `SELECT … FOR UPDATE SKIP LOCKED`, учётом параллелизма и back-pressure.

### 4.3 Воркеры и постобработка
- Разработать воркер: интеграция с провайдерами, учёт `expires_at`, сохранение результатов, очистка временных файлов, запись `ProcessingLog`.
- Настроить хранилище итоговых файлов (`MEDIA_ROOT/results`), публичные ссылки `GET /public/results/{job_id}`, TTL 72 часа и очиститель с возвратом `410 Gone` после истечения срока.

### 4.5 Административная платформа (домен, безопасность, API)
- Провести REFLECT-анализ недостающих компонентов (`SettingsService`, `SlotService`, `StatsService`, репозитории, безопасность) и согласовать с тимлидом (CONSULT) состав данных, JWT-claims, требования к пагинации/фильтрам статистики.
- Подготовить миграции и схему хранения для административных сущностей: настройки платформы, слоты, шаблонные медиа, агрегаты статистики.
- Реализовать слой инфраструктуры: `SettingsRepository`, `SlotRepository`, `TemplateMediaRepository`, `StatsRepository` с unit-тестами и подключением к Postgres.
- Реализовать доменные сервисы: `SettingsService` (ротация ingest-пароля, пересчёт TTL), `SlotService` (CRUD, валидация operations/settings_json, ETag), `StatsService` (агрегаты по `processing_logs`, recent_results, кеширование) и интегрировать их с событиями очереди.
- Подключить сервисы и репозитории в DI-контейнер, обеспечить обновление `QueueWorker`/`JobService` для публикации событий в `StatsService`.
- Реализовать `/api/login` с выдачей JWT (claims `permissions`, `exp`), настроить `require_bearer_authentication` и проверку прав (`settings:write`, `slots:write`, `stats:read`).
- Имплементировать Admin API: `GET/PUT /api/settings`, CRUD слотов (list/get/create/update/archive), управление шаблонными медиа, `/api/stats/global`, `/api/stats/{slot_id}`, выдачу `recent_results` с пагинацией.
- Добавить контрактные/юнит-тесты для административных эндпоинтов и документацию (flow JWT, границы прав, лимиты и runbook администрирования).

### 4.6 Безопасность и эксплуатационные метрики
- Добавить авторизацию и защиту эндпоинтов, расширить ротацию секретов, внедрить логирование, метрики таймаутов/ретраев/очисток согласно NFR.

## Фаза 5. Интеграция провайдеров и UI
- Подключить реальный адаптер Gemini: вызов `models.generateContent`, работа с Files API, обработка квот, повторные попытки, логирование ошибок.
- Подключить адаптер Turbotext: регистрация `media_object`, polling `queueid`, уважение `T_sync_response`, завершение на таймаут.
- Имплементировать UI админ-панели: список слотов, форма настроек (динамические поля по операции), галерея `recent_results`, кнопка копирования ingest-ссылки, страницы статистики.
- Настроить публичные страницы скачивания и отображение истечения TTL (`410 Gone`).

## Фаза 6. Нефункциональные требования и эксплуатация
- Внедрить ограничение параллелизма на провайдера, глобальный rate limiting ingest/админ API, ручную отмену задач.
- Реализовать сбор метрик (ингест, таймауты, polling воркера, очистки), экспорт в Prometheus/логгирование согласно NFR и risk constraints.
- Добавить TLS-конфигурацию и безопасное хранение секретов (`app_settings`, `provider_secret`), шифрование и ротацию ключей.
- Настроить фоновые задания очистки (`payload`, `media_object`, `result_file_path`) и обработку `410 Gone` для истёкших ссылок.

## Фаза 7. Тестирование end-to-end и релизная подготовка (E2E GREEN)
- Прогнать e2e сценарии: успешный ingest ≤ `T_sync_response`, ingest с таймаутом 504, сбой провайдера, истечение публичной ссылки, скачивание результатов после UI опроса.
- Организовать нагрузочное тестирование: оценка p95, доли 504, устойчивости очереди и ретраев в рамках целевых метрик.
- Подготовить чек-листы для регресса UI и API, соответствующие test-plan.
- Сформировать релизную документацию: обновлённый README (запуск, переменные окружения), инструкции по провайдерам, эксплуатационные регламенты.

## Фаза 8. Оперативная поддержка и эволюция
- Внедрить процесс Re-Sync при изменении брифа: мониторинг изменений, обновление контрактов и реализаций через SDD-ворота.
- Создать backlog улучшений: новые провайдеры, дополнительные операции, расширение статистики и автоматизация очистки хранилищ.
- Настроить алерты по SLA (`T_sync_response`, процент 504), контроль квот провайдеров, резервное копирование шаблонов и результатов.
