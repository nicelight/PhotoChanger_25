# Нефункциональные требования — PhotoChanger

## 1. Производительность и масштабирование
- Ingest API обрабатывает до 30 параллельных запросов с p95 времени ответа < `T_sync_response`.
- Размер загружаемого файла ограничен 15 МБ (жёсткий лимит FastAPI 2 ГБ); проверка MIME: JPEG, PNG, WEBP, HEIC/HEIF.
- `/api/slots`, `/api/settings`, `/api/stats` отвечают <1 с при номинальной нагрузке (до 5 одновременных админов).
- Нет горизонтального масштабирования; вертикальные ресурсы (CPU/GPU) подбираются под SLA, scale-out решается отдельным ADR.

## 2. Надёжность и доступность
- ≥99.5 % доступности для ingest, `/public/results`, `/metrics`, `/healthz`.
- Тест на таймаут возвращает 504 и очищает temp-файлы за ≤1 мин после истечения `T_sync_response`.
- Итоговые результаты доступны 72 ч; очистка просрочки завершается ≤15 мин после TTL.
- Бэкап PostgreSQL ежедневно; снапшоты `media/results` перед релизом.

## 3. Безопасность
- Ингест пароль хранится только в хэшированном виде (`settings`); админ JWT подписывается `JWT_SIGNING_KEY`.
- Ограничение входа: блокировка после 10 неудачных попыток на 15 мин.
- API логи не содержат бинарных данных или секретов; аудиторские события фиксируются для логинов и настроек.
- TLS обязателен для всех внешних интерфейсов; ключи/сертификаты вне репозитория.

## 4. Наблюдаемость и эксплуатация
- `/metrics` публикует p95 ingest, долю 504, размер `media/temp|results`, счётчик cron-очистки.
- `/healthz` проверяет БД, файловую систему и быстрый ping провайдеров (≤1 с).
- Cron `cleanup_media.py` выполняется каждые 15 мин и делает запись в лог о количестве удалённых объектов.
- Alertmanager оповещает о росте 504 >5 %, заполнении `media/` >80 %, отсутствии cron-очисток >30 мин.

## 5. Поддерживаемость и качество
- Кодовая база следует KISS: модули `ingest`, `media`, `slots`, `settings`, `stats` с единым `AppConfig`.
- Обязательные проверки перед релизом: `ruff`, `black`, `mypy`, pytest (unit + интеграционные + контрактные + cleanup).
- Документация и контракты (OpenAPI, JSON Schema) синхронизируются с SemVer в `spec/contracts/VERSION.json`.
- Любые архитектурные изменения фиксируются ADR; публичные контракты обновляются через MINOR/MAJOR bump.
