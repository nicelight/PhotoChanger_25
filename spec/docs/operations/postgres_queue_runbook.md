# PostgreSQL Queue Runbook

Этот документ описывает подготовку и обслуживание очереди задач PhotoChanger на
PostgreSQL. Очередь хранит задания ingest (`jobs`) и историю обработки
(`processing_logs`); схема управляется Alembic-миграциями.

## Конфигурация приложения

- `PHOTOCHANGER_DATABASE_URL` — DSN PostgreSQL, который использует серверное
  приложение и Alembic. Пример для локальной разработки:
  `postgresql://postgres:postgres@localhost:5432/photochanger`.
- `PHOTOCHANGER_QUEUE_STATEMENT_TIMEOUT_MS` — значение `statement_timeout` в
  миллисекундах для всех запросов очереди. По умолчанию используется 5000 мс, что
  укладывается в окно `T_sync_response`. При изменении таймаута убедитесь, что он
  меньше дедлайна ingest и согласован с настройками PostgreSQL.
- `PHOTOCHANGER_QUEUE_MAX_IN_FLIGHT_JOBS` — верхняя граница активных задач,
  после которой ingest возвращает `429 queue_busy`. Значение по умолчанию — 12
  (оставляет запас относительно 15 статических слотов и помогает удерживать SLA
  при спайках).
- `PHOTOCHANGER_STATS_SLOT_CACHE_TTL_SECONDS` и
  `PHOTOCHANGER_STATS_GLOBAL_CACHE_TTL_SECONDS` — TTL кеша статистики. По
  умолчанию — 300 и 60 секунд соответственно, значения должны укладываться в SLA
  обновления UI (≤5 мин для слота и ≤1 мин глобально).
- `PHOTOCHANGER_STATS_RECENT_RESULTS_RETENTION_HOURS` и
  `PHOTOCHANGER_STATS_RECENT_RESULTS_LIMIT` — параметры выдачи
  `recent_results`. По умолчанию возвращаются до 10 завершённых задач за
  последние 72 часа; уменьшение лимита снижает нагрузку на БД и объём кэша.

После обновления конфигурации перезапустите приложение, чтобы очередь
пересоздала соединение с новыми параметрами.

## Применение миграций

1. Установите зависимости: `pip install alembic sqlalchemy psycopg[binary]`.
2. Убедитесь, что переменная окружения `PHOTOCHANGER_DATABASE_URL` указывает на
   нужную базу данных.
3. Выполните `alembic upgrade head` из корня репозитория.

Миграция `202510280001_create_queue_tables` создаёт таблицы `jobs` и
`processing_logs` вместе с индексами:

- `ix_jobs_status_finalized_expires` ускоряет выборку активных задач и очистку
  просроченных записей.
- `ix_jobs_slot_created_at` упорядочивает задачи внутри слотов.
- `ix_processing_logs_job_occurred` используется для выдачи истории обработки в
  UI и аналитике.

При возникновении ошибки `queue schema is missing` убедитесь, что миграции
применены и что приложение использует тот же DSN, что и Alembic.

## Обслуживание и эксплуатация

- Очередь рассчитывает back-pressure по количеству активных (`is_finalized =
  false`) задач. Настройка `QUEUE_MAX_IN_FLIGHT_JOBS` по умолчанию ограничивает
  параллелизм двенадцатью задачами, что обеспечивает ~20 % запас от доступных
  слотов и снижает риск таймаутов провайдеров. Поддерживайте регулярный мониторинг
  задержек и очищайте просроченные записи через `release_expired`/фоновые задачи.
- Настройте регулярный `VACUUM`/`ANALYZE` для таблиц `jobs` и
  `processing_logs`, особенно под нагрузкой воркеров. Пул состоит из четырёх асинхронных задач внутри FastAPI; при росте задержек сначала проверяйте лимиты провайдера и back-pressure, а не увеличивайте число воркеров.
- При ротации базы данных повторно прогоните `alembic upgrade head` перед
  запуском приложения.
- Для интеграционных тестов используйте переменные `TEST_POSTGRES_*` и запуск
  миграций через Alembic (см. `tests/conftest.py`).
