# Провайдер Turbotext (фото-API)

> Источник: [Официальная документация Turbotext Photo AI](https://www.turbotext.ru/photo_ai/docs/info) (раздел «Фото - методы»).

## Аутентификация и базовый протокол

- **Хост**: `https://www.turbotext.ru`.
- **Тип запросов**: `POST` с `Content-Type: application/x-www-form-urlencoded`.
- **Авторизация**: заголовок `Authorization: Bearer {APIKEY}` обязателен для всех вызовов.
- **Шаг 1 — создание очереди**: передать `do=create_queue` и параметры операции. Успешный ответ `{"success":true,"queueid":<ID>}`.
- **Шаг 2 — опрос результата**: запрос с `do=get_result` и `queueid`. Пока генерация не готова, сервис возвращает `{"action":"reconnect"}`; после завершения — JSON с `success=true`, блоком `data` и ссылкой `uploaded_image` на готовый файл.
- **Ожидание результата**: платформа хранит `queueid` и повторяет polling только в пределах `T_sync_response`; по истечении окна задача завершается.
- **Хранение файлов**: входные изображения должны быть доступны по публичным HTTPS/HTTP URL (например, через временное медиа-хранилище платформы). Готовый результат скачивается по ссылке из поля `uploaded_image`.

## Операции

### Обработка фото (`/api_ai/generate_image2image`)

| Параметр | Тип | Обязательность | Описание |
| --- | --- | --- | --- |
| `url` | string (URL) | required | Ссылка на исходное изображение (форматы: JPG/PNG/WEBP). |
| `content` | string | required | Текстовый промпт, описывающий желаемые изменения. |
| `strength` | integer | optional (`0–80`, default `40`) | Степень изменения исходной картинки. |
| `seed` | integer | optional (`1–10^10`, default random) | Фиксирует детерминированность результата. |
| `scale` | float | optional (`0.1–20`, default `7.5`) | Guidance scale. |
| `negative_prompt` | string | optional | Что нужно исключить (до ~80 слов). |
| `original_language` | string | optional (default `ru`) | Язык исходного промпта. |
| `user_id` | integer | optional (default `1`) | Служебный идентификатор аккаунта Turbotext. |

**Ответ**: после `do=get_result` Turbotext возвращает `data.image` (массив путей, например `"image/generate_image2image_id12_0.png"`), промпт и параметры генерации, а также `uploaded_image` с прямой ссылкой на результат.

### Метод «Микс-фото» (`/api_ai/mix_images`)

| Параметр | Тип | Обязательность | Описание |
| --- | --- | --- | --- |
| `url_image_target` | string (URL) | required | Фото, в которое переносится стиль/сочетается изображение. |
| `url` | string (URL) | required | Фото-источник стиля. |
| `content` | string | optional | Дополнительное текстовое описание эффекта. |

**Ответ**: блок `data` содержит сведения о ширине/высоте, `prompt`, `strength`, `pattern_prompt`; итоговая ссылка — в `uploaded_image`.

### Замена лица (`/api_ai/deepfake_photo`)

| Параметр | Тип | Обязательность | Описание |
| --- | --- | --- | --- |
| `url` | string (URL) | required | Фото человека, которому требуется заменить лицо. |
| `url_image_target` | string (URL) | required | Фото с лицом, которое нужно перенести. |
| `face_restore` | boolean (`True/False`) | optional | Включает дообработку лица после подстановки. |

**Ответ**: `data.image` содержит массив ссылок на результат (обычно одно изображение) с признаками `width`, `height`, `face_restore`; публичная ссылка на файл возвращается в `uploaded_image`.

## Особенности интеграции

- Все методы работают через очередь: платформа хранит `queueid` и сопоставляет его с задачей в своей очереди.
- Поле `action="reconnect"` при опросе означает, что нужно повторить `do=get_result` через интервал (например, 2–3 секунды).
- После выдачи ingest 504 задача немедленно финализируется: воркер прекращает polling, очищает временные ресурсы и помечает `failure_reason = 'timeout'`.
- Turbotext считает каждую операцию «Фото попыткой», поэтому биллинг и квоты должны учитывать количество обращений к API.
- Входные ссылки должны указывать на изображения с MIME из `MEDIA_ALLOWED_MIME` (JPEG/PNG/WEBP). Остальные форматы необходимо отклонять до обращения к API Turbotext, иначе сервис вернёт ошибку формата.

## Ссылки

1. [Основы работы с API Turbotext — Фото методы](https://www.turbotext.ru/photo_ai/docs/info)

## Деградации и ретраи

### Очередь зависла (`action="reconnect"` > `T_sync_response`)
- Если при polling значение `action="reconnect"` повторяется, но окно SLA ещё не истекло, продолжайте опрос каждые 2–3 с.
- Как только до конца SLA остаётся < 5 с, прекращайте опрос, возвращайте 504 (`provider_timeout`), очищайте временные ссылки.
- При повторении ситуации ≥ 3 раз за 15 минут переведите слот в «degraded» и уведомите админа.

### Ошибки `success=false`
- Код `error="LIMIT"` → верните ingest 429 или 503 (`provider_error`), пометьте слот как деградирующий, запросите у заказчика увеличение квоты.
- Ошибки вида `url_error`, `params_error` означают проблему с конфигурацией: задача завершается `provider_error`, добавляется запись в журнал, слот требует проверки настроек.
- Ошибки `face_not_detected`/`quality_limit` логируются в `job_history`; повторная отправка допускается только по ручному запросу администратора, чтобы не списывать лишние попытки.

### Недоступность сервиса (`HTTP 500/502/503`)
- Делайте до двух повторов `create_queue` с экспоненциальным backoff (2 с, затем 5 с), если остаётся ≥ 10 с. После второй неудачи — `provider_error`.
- Сообщайте админу, если HTTP 503 повторяется более 5 раз в течение 10 минут.

### Потеря результата
- Если `uploaded_image` возвращает 404/410 при скачивании, пробуйте ещё раз, пока SLA позволяет (обычно результат доступен повторно 1–2 раза).
- При повторных 404 итоговый статус — `provider_error`, адаптер логирует предупреждение и отправляет админам уведомление, что провайдер потерял файл.

### Удержание публичных ссылок
- Проверяйте TTL `media_object`. Если ссылка близка к истечению, но провайдер ещё обрабатывает задачу, рассмотреть продление (создать новую ссылку и обновить параметры) или завершить с ошибкой, чтобы избежать 410 и двойного биллинга.
