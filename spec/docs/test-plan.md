# Test Plan — PhotoChanger

## 1. Область действия
- Покрывает все интерфейсы PhotoChanger Iteration 2: ingest API, Admin API/UI, провайдерские драйверы, публичные ссылки, cron-очистку и наблюдаемость.
- Фокус на проверке SLA (`T_sync_response`, TTL медиа 72 ч), корректности ошибок 504/502, работоспособности управления слотами и шаблонными медиа.

## 2. Среды тестирования
- **Local**: разработчики запускают `uvicorn src.app.main:app --reload` + локальную PostgreSQL (docker-compose), временные каталоги в `./media/temp|results`.
- **CI**: изолированные контейнеры с PostgreSQL, фиктивными API ключами, временными каталогами (`pytest` + `pytest-postgresql`).
- **Staging**: копия прод-окружения с мок-ключами провайдеров; обязательный прогон smoke-тестов и health-check перед релизом.

## 3. Типы тестов и ответственность
| Тип | Область | Инструменты | Ответственный |
|-----|---------|-------------|---------------|
| Unit | Сервисы модулей `ingest`, `media`, `slots`, `settings`, `stats`; утилиты TTL | `pytest`, `pytest-mock` | Разработчик |
| Интеграционные | FastAPI приложение с in-memory PostgreSQL, временными каталогами; сценарии UC2/UC3/UC4 | `pytest`, `httpx.AsyncClient` | Разработчик |
| Контрактные | Драйверы `GeminiDriver`, `TurbotextDriver` (mock-серверы) | `pytest`, `respx`/`pytest-httpserver` | Разработчик |
| UI smoke | Логин, редактирование слота, просмотр статистики | Playwright или Cypress | QA/Разработчик |
| Ops/cron | `scripts/cleanup_media.py`, health-check, метрики | Pytest + e2e скрипты | Ops/Разработчик |
| Нагрузочные (целевые) | 30 одновременных ingest-запросов, выдержка p95 | Locust/k6 (по мере готовности) | Ops/Разработчик |

## 4. Покрываемые сценарии
- UC0–UC6 из `spec/docs/use-cases.md` — обязательные интеграционные сценарии.
- AC-01…AC-08 из `spec/docs/acceptance-criteria.md` — минимум один автоматизированный тест на критерий.
- Дополнительные проверки: ротация ingest-пароля, валидация MIME/размеров, очистка просроченных публичных ссылок, метрики `/metrics`.

## 5. Автоматизация и отчётность
- CI пайплайн запускает `ruff`, `black`, `mypy`, unit + интеграционные + контрактные тесты, тест скрипта очистки.
- Отчёты о тестах публикуются в CI (JUnit XML). Негативные сценарии (timeout, provider error) фиксируются отдельными тест-кейсами.
- Перед релизом на staging выполняется smoke-набор UI + проверка `/metrics` и `/healthz`.
- По результатам релиза обновляется `.memory/PROGRESS.md`, а критические дефекты фиксируются в `.memory/WORKLOG.md`.

## 6. Управление рисками тестирования
- В случае недоступности реальных провайдеров используются мок-серверы; интеграция с live API возможна только на staging с ограниченным трафиком.
- При изменении SLA (например, расширение диапазона `T_sync_response`) необходимо обновлять контрактные тесты и SemVer (`spec/contracts/VERSION.json`).
- Неавтоматизированные проверки (нагрузочные, UI) имеют владельцев и чеклисты; отсутствие результатов блокирует релиз.
