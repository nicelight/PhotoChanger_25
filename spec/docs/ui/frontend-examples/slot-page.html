 <!-- (HTML + CSS + Vanilla JS) -->
 <!-- В проде: slot-state.js, slot-ui.js, slot-mapping.js, slot-api.js, slot-events.js, slot-index.js. -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Слот — AI обработка — Vanilla JS</title>
  <style>
    :root{ --h-a:195; --h-b:8; --h-c:54; --s:100%; --l:93%; --text:#0f172a; --muted:#334155cc; --glass:18px; --gap:clamp(12px,2vw,18px); --pad:clamp(14px,1.8vw,22px); }
    @property --l{syntax:'<percentage>';inherits:true;initial-value:93%}
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter;color:var(--text)}

    .bg{ min-height:100dvh; overflow-x:hidden; background:
      radial-gradient(120vmax 120vmax at 0% 0%,    hsl(var(--h-a) var(--s) var(--l) / .85) 0 40%, transparent 70%),
      radial-gradient(130vmax 130vmax at 0% 100%,  hsl(var(--h-c) var(--s) var(--l) / .85) 0 40%, transparent 70%),
      radial-gradient(140vmax 140vmax at 100% 50%, hsl(var(--h-b) var(--s) var(--l) / .85) 0 40%, transparent 70%),
      linear-gradient(180deg, color-mix(in oklab, white 90%, hsl(var(--h-a) var(--s) var(--l)) 10%), white);
      animation:breathe 3s ease-in-out infinite; }
    @keyframes breathe{0%,100%{--l:92%}50%{--l:95%}}

    main{ display:grid; place-items:center; padding:clamp(20px,5vmin,60px) }
    .shell{ width:min(980px,96vw); display:grid; gap:var(--gap) }

    /* ▲ Форме даём 8% непрозрачности и лёгкое стекло */
    #upload-form{ 
      background: rgba(255,255,255,0.08); /* 8% */
      border:1px solid color-mix(in oklab, white 75%, #0f172a 25% / 30%);
      border-radius: calc(var(--glass) + 6px);
      box-shadow: 0 10px 30px rgba(2,6,23,.12);
      backdrop-filter: blur(6px);
      padding: var(--gap);
      display:grid;
      gap: var(--gap);
    }

    .card{ border-radius:var(--glass); background:transparent; border:1px dashed color-mix(in oklab, white 75%, #0f172a 25% / 35%); padding:var(--pad) }
    .slot-heading{ display:grid; gap:var(--gap) }
    .slot-heading__meta{ display:grid; gap:8px }
    .slot-heading__model{ margin:0; font-weight:700; color:#0f172acc; font-size:clamp(16px,2cqi,20px); display:flex; gap:.5em; flex-wrap:wrap; align-items:center }
    .slot-heading__separator{ margin:0 .5em; opacity:.6 }
    .slot-heading__slot{ margin:0 }
    .slot-heading h1{ margin:0 }

    h1{ font-size:clamp(28px,4cqi,48px); margin:0 }
    label.title{ font-weight:700; display:block; margin-bottom:8px }
    input[type="text"], input[type="password"], select, textarea{ width:100%; border-radius:14px; padding:12px 14px; border:1px solid color-mix(in oklab, white 75%, #0f172a 25% / 35%); background:transparent; outline:none }
    select{
      appearance:none;
      background:color-mix(in oklab, hsl(var(--h-a) var(--s) var(--l)), #0f172a 5%);
      color:var(--text);
      cursor:pointer;
      box-shadow:0 2px 6px rgba(15,23,42,.12);
    }
    select:focus{ border-color:hsl(var(--h-a) var(--s) calc(var(--l) - 10%)); box-shadow:0 0 0 3px rgba(59,130,246,.25); }
    select option{
      background:color-mix(in oklab, hsl(var(--h-a) var(--s) var(--l)), #0f172a 8%);
      color:var(--text);
    }
    textarea{ resize:vertical }

    .muted-hint{ color:var(--muted); font-size:14px; margin-top:8px }
    .has-error{ border-color:#ef4444 !important; box-shadow:0 0 0 2px rgba(239,68,68,.18) }

    /* Switch */
    .switch-row{ display:flex; align-items:center; gap:10px }
    .switch{ appearance:none; width:32px; height:18px; border-radius:999px; position:relative; outline:none; cursor:pointer; background:rgba(15,23,42,.12); transition:background .18s ease }
    .switch::after{ content:""; position:absolute; top:2px; left:2px; width:14px; height:14px; border-radius:50%; background:#fff; box-shadow:0 1px 3px rgba(2,6,23,.18); transition:transform .18s ease }
    .switch:checked{ background:color-mix(in oklab, hsl(var(--h-a) var(--s) var(--l)), #0f172a 20%) }
    .switch:checked::after{ transform:translateX(14px) }
    .switch-label{ user-select:none; color:#0f172acc; font-weight:600 }

    .uploads{ display:none; margin-top:10px; gap:var(--gap); }
    .uploads.show{ display:grid }

    /* Upload / drop-zone */
    .drop{ position:relative; display:grid; place-items:center; gap:8px; padding:18px; text-align:center; border-radius:calc(var(--glass) - 2px);
      outline:2px dashed color-mix(in oklab, hsl(var(--h-a) var(--s) var(--l)) 70%, #0f172a 30% / 40%);
      outline-offset:-8px; cursor:pointer; min-height:160px }
    .drop.large{ aspect-ratio:16/10; padding:0; border-radius:calc(var(--glass) - 6px); border:1px solid color-mix(in oklab, white 75%, #0f172a 25% / 35%); overflow:hidden; max-width: min(100%, 800px); margin-inline:auto; }
    .drop:focus-visible{ outline:3px solid #fff; outline-offset:-6px; }
    .drop.dragging{ outline-color:#fff; background:rgba(255,255,255,.08) }
    .drop input[type=file]{ position:absolute; inset:0; opacity:0; cursor:pointer; z-index:1 }
    .remove-btn{ position:absolute; top:10px; right:10px; z-index:2; border:none; border-radius:12px; padding:8px 10px; font-weight:600; cursor:pointer; background:color-mix(in oklab, white 85%, #000 15% / 20%); backdrop-filter:blur(6px); color:#0f172a; box-shadow:0 2px 10px rgba(2,6,23,.12); opacity:0; transition:opacity .18s ease,transform .18s ease }
    .drop.has-image:hover .remove-btn, .drop.has-image:focus-within .remove-btn{ opacity:1 }

    /* Превью: мягкое появление ~500 мс */
    .drop .drop-preview{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:none; opacity:0; z-index:1; transition:opacity .5s ease }
    .drop.has-image .drop-preview{ display:block }
    .drop.has-image .placeholder{ position:relative; z-index:0; display:grid; gap:6px; place-items:center; padding:18px; color:var(--muted); outline:1px solid color-mix(in oklab, #0f172a 20%, white 80% / 45%); outline-offset:-6px; border-radius:calc(var(--glass) - 10px); }

    .placeholder{ position:relative; z-index:0; display:grid; gap:6px; place-items:center; padding:18px; color:var(--muted) }
    .error{ margin-top:8px; font-size:14px; color:#b91c1c }

    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:var(--gap) }

    .btns{ display:flex; gap:12px; justify-content:flex-end; flex-wrap:wrap }
    .btn{ border:1px solid color-mix(in oklab, white 75%, #0f172a 25% / 35%); background:transparent; border-radius:12px; padding:10px 16px; font-weight:700; cursor:pointer; color:inherit; text-decoration:none; display:inline-flex; align-items:center; gap:8px }
    .btn:hover{ background:rgba(255,255,255,.35) }

    .inline{ display:flex; gap:10px; align-items:center }
    .inline input[type="text"]{ flex:1 }

    /* Кнопки внутри выпадаемых секций */
    .uploads-actions{ display:flex; justify-content:flex-start; }
    .uploads-actions .btn{ margin-top:8px; }

    /* Карточка результатов */
    .slot-results{ display:grid; gap:var(--gap); }
    .slot-results__header{ display:flex; justify-content:space-between; gap:var(--gap); flex-wrap:wrap; align-items:flex-start }
    .slot-results__grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(180px,1fr)); gap:var(--gap); transition:opacity .2s ease; }
    .slot-results__grid.-loading{ opacity:.6; }
    .slot-results__item{ display:grid; gap:8px; padding:12px; border-radius:calc(var(--glass) - 6px); border:1px solid color-mix(in oklab, white 75%, #0f172a 25% / 25%); background:rgba(255,255,255,.18); backdrop-filter:blur(4px); position:relative }
    .slot-results__thumb-wrap{ position:relative; border-radius:12px; overflow:hidden; background:rgba(15,23,42,.08) }
    .slot-results__thumb{ width:100%; aspect-ratio:4/3; object-fit:cover; display:block }
    .slot-results__meta{ display:grid; gap:4px; font-size:13px; color:var(--muted) }
    .slot-results__meta strong{ color:var(--text); font-size:14px }
    .slot-results__empty{ padding:16px; border-radius:12px; border:1px dashed color-mix(in oklab, white 75%, #0f172a 25% / 35%); text-align:center }
    .slot-results__actions{ display:flex; gap:8px; justify-content:flex-start; flex-wrap:wrap }
    .btn.-ghost{ background:rgba(255,255,255,.16) }
    .btn.-ghost:hover{ background:rgba(255,255,255,.3) }
    .btn.is-disabled{ pointer-events:none; opacity:.6 }
    .slot-results__error{ color:#b91c1c; font-size:14px }

    /* Всплывающее сообщение (toast) для ошибок сервера */
    .toast{ position:fixed; right:16px; top:16px; display:grid; gap:8px; z-index:9999 }
    .toast-item{ min-width:260px; max-width:min(92vw,420px); padding:12px 14px; border-radius:12px; box-shadow:0 8px 28px rgba(2,6,23,.25); color:#0f172a; backdrop-filter:blur(6px); border:1px solid rgba(15,23,42,.12); background:rgba(255,255,255,.96); opacity:0; transform:translateY(-6px); transition:opacity .25s ease, transform .25s ease }
    .toast-item.show{ opacity:1; transform:translateY(0) }
    .toast-item.error{ border-color:#fecaca; background:rgba(254,226,226,.96) }
    .toast-item.success{ border-color:#bbf7d0; background:rgba(220,252,231,.96) }

    /* Только для скринридеров */
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }

    /* Минимальная универсальная анимация формы: лёгкий пульс */
    @keyframes pulseForm { 0% { opacity: 1 } 50% { opacity: .08 } 100% { opacity: 1 } }
    #upload-form.-pulse { animation: pulseForm .4s ease }
  </style>
</head>
<body
  data-slot-id="slot-001"
  data-provider="gemini"
  data-model-name="Gemini Ultra Portrait"
  data-operation="identity_transfer"
  data-slot-api="/api/slots/slot-001"
  data-slot-save="/api/slots/slot-001"
  data-test-run="/api/slots/slot-001/test-run"
  data-template-upload="/api/template-media/register?slot_id=slot-001"
  data-template-media-kind="style_reference"
  data-template-media-id="tmpl-style-001"
  data-slot-size-limit="15"
  data-slot-sync="48"
>
  <div class="bg">
    <main>
      <div class="shell">
        <!-- Форма. Отправку на backend не выполняем здесь -->
        <form id="upload-form" onsubmit="return false;">
          <!-- 1. Заголовок и название слота -->
          <div class="card slot-heading">
            <div class="slot-heading__meta">
              <h1>Слот — AI обработка</h1>
              <p class="slot-heading__model" id="slot-model-label" aria-live="polite">
                <span id="slot-model-text">AI-модель: — выберите провайдера —</span>
                <span class="slot-heading__separator" aria-hidden="true">•</span>
                <span>Слот <span id="slot-id-value">slot-001</span></span>
              </p>
              <p class="slot-heading__slot muted-hint">Значение выдаётся бэкендом: ingest-ссылка привязана к слоту и выбранной модели.</p>
            </div>
            <label class="title" for="title">Название</label>
            <input id="title" name="title" type="text" placeholder="Например: Корпоративный портрет для сайта" />
            <p class="muted-hint">Название появится в списке слотов на главной странице.</p>
          </div>

          <!-- 3. Провайдер → Операция -->
          <div class="card">
            <div class="grid-2">
              <div>
                <label class="title" for="provider">Провайдер</label>
                <select id="provider" name="provider" aria-label="Выбор AI-провайдера">
                  <option value="" selected disabled>— выберите —</option>
                  <option value="gemini">Gemini</option>
                  <option value="turbotext">Turbotext</option>
                </select>
              </div>
              <div id="operation-select-wrap">
                <label class="title" for="operation">Операция</label>
                <select id="operation" name="operation" aria-label="Выбор операции" disabled>
                  <option value="" selected disabled>— выберите провайдера —</option>
                </select>
              </div>
            </div>
            <p id="op-req" class="muted-hint" style="display:none"></p>
          </div>

          <!-- 4. Параметры операции (только промпт) -->
          <div class="card" id="params-card">
            <label class="title" for="long">Параметры операции</label>
            <textarea id="long" name="long" rows="6" placeholder="Промпт к ИИ…"></textarea>
            <p class="muted-hint">Опишите желаемую обработку. Если операция использует шаблонное изображение, называйте его как «Изображение №2».</p>
          </div>

          <!-- 5. Тумблер + Second_image -->
          <div class="card" data-block="second-wrap-card">
            <div class="switch-row">
              <input id="toggle-second" class="switch" type="checkbox" />
              <label class="switch-label" for="toggle-second">Добавить вторичное изображение</label>
            </div>
            <div id="second-wrap" class="uploads">
              <label class="drop large" id="drop-second" tabindex="0" role="button" aria-label="Загрузка изображения-шаблона">
                <span class="sr-only">Нажмите или перетащите файл (JPG/PNG) сюда</span>
                <button type="button" class="remove-btn" data-action="remove" data-for="Second_image">Убрать</button>
                <img id="preview-second" class="drop-preview" alt="Превью шаблона" loading="lazy" decoding="async" />
                <div class="placeholder">
                  <strong>Изображение — Шаблон стиля</strong>
                  <small>Кликните или перетащите JPG/PNG</small>
                </div>
                 <input id="input-second" name="Second_image" type="file" accept="image/jpeg,image/png" />
                 <input type="hidden" name="Second_image_status" id="Second_image_status" value="removed" />
                <input type="hidden" id="Second_image_media_id" value="tmpl-style-001" />
              </label>
              <div id="error-second" class="error" style="display:none"></div>
            </div>
          </div>

          <!-- 6. Тумблер + First_image -->
          <div class="card" data-block="first-wrap-card">
            <div class="switch-row">
              <input id="toggle-first" class="switch" type="checkbox" />
              <label class="switch-label" for="toggle-first">Протестировать AI обработку</label>
            </div>
            <p id="hint-first" class="muted-hint" style="display:none">Добавьте фотографию, которую нужно обработать</p>

            <div id="first-wrap" class="uploads">
              <label class="drop large" id="drop-first" tabindex="0" role="button" aria-label="Загрузка тестового изображения">
                <span class="sr-only">Нажмите или перетащите файл (JPG/PNG) сюда</span>
                <button type="button" class="remove-btn" data-action="remove" data-for="First_image">Убрать</button>
                <img id="preview-first" class="drop-preview" alt="Превью фото" loading="lazy" decoding="async" />
                <div class="placeholder">
                  <strong>Фото для тестов</strong>
                  <small>Кликните или перетащите JPG/PNG</small>
                </div>
                <input id="input-first" name="First_image" type="file" accept="image/jpeg,image/png" />
                <input type="hidden" name="First_image_status" id="First_image_status" value="removed" />
              </label>
              <div id="error-first" class="error" style="display:none"></div>
              <div class="uploads-actions">
                <button id="btn-test1" type="button" class="btn">Тест1</button>
              </div>
            </div>
          </div>

          <!-- 7. Кнопки + ingest-ссылка -->
          <div class="card">
            <div class="grid-2" style="align-items:end">
              <div>
                <label class="title" for="ingest-url">Ingest-ссылка слота</label>
                <div class="inline">
                  <input id="ingest-url" type="text" readonly placeholder="Появится после выбора модели" />
                  <button id="btn-copy" type="button" class="btn" disabled>Копировать</button>
                </div>
                <p class="muted-hint">Ссылка совпадает с отображаемой на главной странице и используется DSLR Remote Pro.</p>
              </div>
              <div class="btns">
                <button type="button" class="btn" id="btn-save1">Сохранить1</button>
              </div>
            </div>
            <p id="server-response" style="color:var(--muted);margin-top:8px"></p>
          </div>
        </form>

        <!-- 8. Галерея последних результатов слота -->
        <section class="card slot-results" id="slot-results" aria-labelledby="slot-results-title">
          <div class="slot-results__header">
            <div>
              <h2 id="slot-results-title">Последние результаты</h2>
              <p class="muted-hint">Показываем превью успешно обработанных изображений. Ссылки на скачивание активны 72&nbsp;часа после готовности файла.</p>
            </div>
            <button type="button" class="btn -ghost" id="results-refresh">Обновить</button>
          </div>
          <p id="slot-results-error" class="slot-results__error" role="status" style="display:none"></p>
          <div id="slot-results-empty" class="slot-results__empty muted-hint">Пока нет готовых изображений для этого слота.</div>
          <div id="slot-results-grid" class="slot-results__grid" role="list"></div>
        </section>
      </div>
    </main>
  </div>

  <!-- Toast контейнер -->
  <div class="toast" id="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- Демонстрационные данные recent_results (используются, если API недоступно) -->
  <script id="slot-page-sample" type="application/json">
  {
    "recent_results": [
      {
        "job_id": "11111111-1111-4111-8111-111111111111",
        "thumbnail_url": "https://picsum.photos/seed/slot1/360/270",
        "download_url": "https://api.example.com/public/results/11111111-1111-4111-8111-111111111111",
        "completed_at": "2024-06-17T09:24:00Z",
        "result_expires_at": "2024-06-20T09:24:00Z",
        "mime": "image/jpeg"
      },
      {
        "job_id": "22222222-2222-4222-8222-222222222222",
        "thumbnail_url": "https://picsum.photos/seed/slot2/360/270",
        "download_url": "https://api.example.com/public/results/22222222-2222-4222-8222-222222222222",
        "completed_at": "2024-06-16T20:52:00Z",
        "result_expires_at": "2024-06-19T20:52:00Z",
        "mime": "image/png"
      }
    ]
  }
  </script>

  <script>
    (function(){
      'use strict';
      // --- Конфиг провайдеров/операций и требований к полям ---
      const CONFIG = {
        gemini: {
          label: 'Gemini',
          operations: {
            style_transfer: { label: 'Style Transfer', needs: { prompt:true, second:true, first:false } },
            identity_transfer: { label: 'Identity Transfer', needs: { prompt:true, second:true, first:true } },
            image_edit: { label: 'Image Edit', needs: { prompt:true, second:false, first:true } }
          }
        },
        turbotext: {
          label: 'TurboText',
          operations: {
            image2image: { label: 'Image2Image (рекомендуем)', needs: { prompt:true, second:false, first:true } },
            style_transfer: { label: 'Style Transfer', needs: { prompt:true, second:true, first:true } },
            image_edit: { label: 'Image Edit', needs: { prompt:true, second:false, first:true } },
            identity_transfer: { label: 'Identity Transfer', needs: { prompt:false, second:true, first:true } }
          }
        }
      };
      const TURBOTEXT_DEFAULT_OPERATION = 'image2image';
      const GEMINI_DEFAULT_OPERATION = 'identity_transfer';

      // --- Helpers ---
      const $ = (id) => document.getElementById(id);
      const byId = $; // alias
      const slotMeta = {
        id: document.body.dataset.slotId || 'slot-001',
        provider: document.body.dataset.provider || '',
        operation: document.body.dataset.operation || '',
        modelName: document.body.dataset.modelName || '',
        sizeLimitMb: Number(document.body.dataset.slotSizeLimit || 15),
        syncResponseSeconds: Number(document.body.dataset.slotSync || 48),
      };
      const PRESET_PROVIDER = slotMeta.provider;
      const PRESET_MODEL_NAME = slotMeta.modelName;
      const PRESET_OPERATION = slotMeta.operation;
      const promptInput = byId('long');
      const SLOT_DETAILS_ENDPOINT = document.body.dataset.slotApi || `/api/slots/${slotMeta.id}`;
      const SLOT_SAVE_ENDPOINT = document.body.dataset.slotSave || SLOT_DETAILS_ENDPOINT;
      const SLOT_TEST_RUN_ENDPOINT = document.body.dataset.testRun || `${SLOT_DETAILS_ENDPOINT}/test-run`;
      const TEMPLATE_UPLOAD_ENDPOINT =
        document.body.dataset.templateUpload || `/api/template-media/register?slot_id=${slotMeta.id}`;
      const templateMediaState = {
        kind: document.body.dataset.templateMediaKind || 'style_reference',
        mediaId: document.body.dataset.templateMediaId || '',
        pendingFile: null,
      };
      const testImageState = { file: null };
      const secondMediaHidden = byId('Second_image_media_id');
      if (secondMediaHidden && secondMediaHidden.value && !templateMediaState.mediaId) {
        templateMediaState.mediaId = secondMediaHidden.value;
      }
      if (templateMediaState.mediaId) {
        const secondStatus = byId('Second_image_status');
        if (secondStatus) {
          secondStatus.value = 'present';
        }
      }
      const slotModelLabel = byId('slot-model-label');
      const slotModelText = byId('slot-model-text');
      const slotIdValue = byId('slot-id-value');
      const ingestInput = byId('ingest-url');
      const copyBtn = byId('btn-copy');
      if(slotIdValue){ slotIdValue.textContent = slotMeta.id; }
      const setStatus = (name, present) => { const el = $(`${name}_status`); if (el) el.value = present ? 'present' : 'removed'; };
      const isValid = (f) => {
        if (!f) return false;
        const t = (f.type || '').toLowerCase();
        if (t === 'image/jpeg' || t === 'image/png' || t === 'image/jpg') return true;
        const name = (f.name || '').toLowerCase();
        return /(\.jpe?g|\.png)$/.test(name);
      };
      const show = (el) => el && el.classList.add('show');
      const hide = (el) => el && el.classList.remove('show');
      const pulse = (el)=>{ if(!el) return; el.classList.remove('-pulse'); void el.offsetWidth; el.classList.add('-pulse'); };

      const resultsGrid = byId('slot-results-grid');
      const resultsEmpty = byId('slot-results-empty');
      const resultsError = byId('slot-results-error');
      const resultsRefresh = byId('results-refresh');
      const sampleNode = document.getElementById('slot-page-sample');
      let cachedSample = null;
      if(sampleNode){
        try{
          cachedSample = JSON.parse(sampleNode.textContent || '{}');
        }catch(err){
          console.warn('[Slot sample] parse error', err);
        }
      }

      function formatDateTime(value){
        if(!value) return '';
        try{
          const dt = new Date(value);
          if(Number.isNaN(dt.getTime())) return value;
          return new Intl.DateTimeFormat('ru-RU', { dateStyle:'medium', timeStyle:'short' }).format(dt);
        }catch(err){ return value; }
      }

      function renderRecentResults(list){
        if(!resultsGrid) return;
        resultsGrid.innerHTML = '';
        const items = Array.isArray(list) ? list : [];
        if(!items.length){
          if(resultsEmpty) resultsEmpty.style.display = '';
          return;
        }
        if(resultsEmpty) resultsEmpty.style.display = 'none';

        items.forEach((item)=>{
          const node = document.createElement('article');
          node.className = 'slot-results__item';
          node.setAttribute('role','listitem');

          const thumbWrap = document.createElement('div');
          thumbWrap.className = 'slot-results__thumb-wrap';
          const img = document.createElement('img');
          img.className = 'slot-results__thumb';
          img.loading = 'lazy';
          img.decoding = 'async';
          img.alt = 'Превью результата обработки';
          img.src = item.thumbnail_url || item.download_url || '';
          thumbWrap.appendChild(img);

          const meta = document.createElement('div');
          meta.className = 'slot-results__meta';
          const completed = document.createElement('strong');
          completed.textContent = `Завершено: ${formatDateTime(item.completed_at)}`;
          const expires = document.createElement('span');
          expires.textContent = `Ссылка активна до ${formatDateTime(item.result_expires_at)}`;
          const mime = document.createElement('span');
          mime.textContent = item.mime ? `Формат: ${item.mime}` : '';
          meta.appendChild(completed);
          meta.appendChild(expires);
          if(item.mime){ meta.appendChild(mime); }

          const actions = document.createElement('div');
          actions.className = 'slot-results__actions';
          const downloadBtn = document.createElement('a');
          downloadBtn.className = 'btn -ghost';
          downloadBtn.href = item.download_url || '#';
          downloadBtn.target = '_blank';
          downloadBtn.rel = 'noopener noreferrer';
          downloadBtn.textContent = 'Скачать';
          if(item.download_url){
            downloadBtn.setAttribute('download','');
          } else {
            downloadBtn.setAttribute('aria-disabled','true');
            downloadBtn.classList.add('is-disabled');
          }
          actions.appendChild(downloadBtn);

          node.appendChild(thumbWrap);
          node.appendChild(meta);
          node.appendChild(actions);
          resultsGrid.appendChild(node);
        });
      }

      function setResultsError(message){
        if(!resultsError) return;
        if(message){
          resultsError.textContent = message;
          resultsError.style.display = '';
        } else {
          resultsError.textContent = '';
          resultsError.style.display = 'none';
        }
      }

      async function requestRecentResults(){
        if(!SLOT_DETAILS_ENDPOINT) return { recent_results: [] };
        try{
          const response = await fetch(SLOT_DETAILS_ENDPOINT, { headers: { 'Accept': 'application/json' } });
          if(!response.ok){
            throw new Error(`API ответил статусом ${response.status}`);
          }
          const data = await response.json();
          hydrateSlotFromServer(data);
          return data;
        }catch(err){
          throw err;
        }
      }

      async function loadRecentResults(options){
        if(!resultsGrid) return;
        const silent = options && options.silent;
        if(resultsEmpty){
          resultsEmpty.style.display = 'none';
        }
        if(!silent){
          resultsGrid.classList.add('-loading');
        }
        setResultsError('');
        try{
          let payload = null;
          if(options && options.forceSample){
            payload = cachedSample;
          }
          if(!payload){
            payload = await requestRecentResults();
          }
          const list = payload?.recent_results || payload?.slot?.recent_results || [];
          renderRecentResults(list);
        }catch(err){
          console.warn('[Recent results]', err);
          setResultsError('Не удалось загрузить результаты. Используем демонстрационные данные.');
          const fallback = cachedSample?.recent_results || [];
          renderRecentResults(fallback);
          if(!fallback.length && resultsEmpty){
            resultsEmpty.style.display = '';
          }
        }finally{
          resultsGrid.classList.remove('-loading');
        }
      }

      if(resultsRefresh){
        resultsRefresh.addEventListener('click', ()=> loadRecentResults({ silent:false }));
      }


      // --- Toast ---
      function toast(msg, type){
        const box = byId('toast');
        if(!box) return;
        const item = document.createElement('div');
        item.className = 'toast-item ' + (type || '');
        item.textContent = msg;
        box.appendChild(item);
        requestAnimationFrame(() => item.classList.add('show'));
        setTimeout(() => { item.classList.remove('show'); setTimeout(() => item.remove(), 300); }, 4200);
      }
      window.toast = toast;

      const FIELD_MAP = {
        display_name: '#title',
        provider: '#provider',
        operation: '#operation',
        'settings.prompt': '#long',
        template_media: '#drop-second',
      };

      function clearFieldErrors(){
        document.querySelectorAll('.has-error').forEach((node)=>{
          node.classList.remove('has-error');
          node.removeAttribute('aria-invalid');
        });
      }

      function normalizeIssues(payload){
        if(!payload) return [];
        if(Array.isArray(payload.errors)) return payload.errors;
        if(Array.isArray(payload.detail)) return payload.detail;
        return [];
      }

      function applyFieldErrors(payload){
        const issues = normalizeIssues(payload);
        if(!issues.length) return false;
        issues.forEach((issue)=>{
          const fieldPath = issue.field || (Array.isArray(issue.loc) ? issue.loc.filter(Boolean).join('.') : '');
          const selector = FIELD_MAP[fieldPath];
          if(!selector) return;
          const el = document.querySelector(selector);
          if(!el) return;
          el.classList.add('has-error');
          el.setAttribute('aria-invalid','true');
          if(issue.message){
            el.dataset.errorMessage = issue.message;
          }
        });
        return true;
      }

      function needsTemplateMedia(){
        const status = byId('Second_image_status');
        return !!(status && status.value === 'present');
      }

      async function ensureTemplateMediaBinding(){
        if(templateMediaState.pendingFile){
          const formData = new FormData();
          formData.append('slot_id', slotMeta.id);
          formData.append('media_kind', templateMediaState.kind);
          formData.append(
            'file',
            templateMediaState.pendingFile,
            templateMediaState.pendingFile.name || 'template-image.png'
          );
          const response = await fetch(TEMPLATE_UPLOAD_ENDPOINT, {
            method: 'POST',
            body: formData,
          });
          if(!response.ok){
            throw new Error(`Не удалось загрузить шаблонное изображение (HTTP ${response.status})`);
          }
          const data = await response.json();
          templateMediaState.mediaId = data.media_object_id || data.id || '';
          templateMediaState.pendingFile = null;
          if(secondMediaHidden && templateMediaState.mediaId){
            secondMediaHidden.value = templateMediaState.mediaId;
          }
        }
        if(templateMediaState.mediaId){
          return [{
            media_kind: templateMediaState.kind,
            media_object_id: templateMediaState.mediaId,
          }];
        }
        return [];
      }

      async function collectTemplateMediaBindings(){
        if(!needsTemplateMedia()){
          return [];
        }
        const bindings = await ensureTemplateMediaBinding();
        if(!bindings.length){
          throw new Error('Добавьте шаблонное изображение или отключите блок «Изображение — Шаблон стиля».');
        }
        return bindings;
      }

      function getPromptValue(){
        return (promptInput?.value || '').trim();
      }

      function collectProviderSettings(provider){
        const settings = { prompt: getPromptValue() };
        if(provider === 'gemini'){
          settings.output = { mime_type: 'image/png' };
        }
        return settings;
      }

      async function persistSlot(payload){
        const response = await fetch(SLOT_SAVE_ENDPOINT, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          body: JSON.stringify(payload),
        });
        if(response.status === 422){
          const body = await response.json().catch(()=> ({}));
          applyFieldErrors(body);
          throw new Error('Проверьте выделенные поля');
        }
        if(!response.ok){
          throw new Error(`Сервис вернул статус ${response.status}`);
        }
        const data = await response.json().catch(()=> ({}));
        hydrateSlotFromServer(data);
        return data;
      }

      function hydrateSlotFromServer(payload){
        if(!payload) return;
        const slot = payload.slot || payload;
        if(!slot || typeof slot !== 'object') return;
        slotMeta.provider = slot.provider || slotMeta.provider;
        slotMeta.operation = slot.operation || slotMeta.operation;
        slotMeta.modelName = slot.display_name || slotMeta.modelName;
        if(typeof slot.size_limit_mb === 'number'){ slotMeta.sizeLimitMb = slot.size_limit_mb; }
        if(typeof slot.sync_response_seconds === 'number'){ slotMeta.syncResponseSeconds = slot.sync_response_seconds; }
        if(promptInput && slot.settings && typeof slot.settings.prompt === 'string'){
          promptInput.value = slot.settings.prompt;
        }
        if(slot.template_media && slot.template_media.length){
          const binding = slot.template_media[0];
          templateMediaState.mediaId = binding.media_object_id;
          templateMediaState.pendingFile = null;
          if(secondMediaHidden){ secondMediaHidden.value = binding.media_object_id; }
          const status = byId('Second_image_status');
          if(status){ status.value = 'present'; }
          const toggleSecond = byId('toggle-second');
          if(toggleSecond && !toggleSecond.checked){
            toggleSecond.checked = true;
            toggleSecond.dispatchEvent(new Event('change'));
          }
        }
        updateSlotHeader(slot.provider || slotMeta.provider);
      }

      async function runSlotTest(templateMediaBindings){
        if(!testImageState.file){
          throw new Error('Загрузите файл «Фото для тестов».');
        }
        const formData = new FormData();
        formData.append('prompt', getPromptValue());
        formData.append('provider', providerSel.value);
        formData.append('operation', slotMeta.operation || operationSel.value);
        formData.append('test_image', testImageState.file, testImageState.file.name || 'test-image.jpg');
        if(templateMediaBindings?.length){
          formData.append('template_media', JSON.stringify(templateMediaBindings));
        }
        const response = await fetch(SLOT_TEST_RUN_ENDPOINT, {
          method: 'POST',
          body: formData,
        });
        if(response.status === 422){
          const body = await response.json().catch(()=> ({}));
          applyFieldErrors(body);
          throw new Error('Исправьте ошибки тестового запуска.');
        }
        if(!response.ok){
          throw new Error(`Test-run завершился статусом ${response.status}`);
        }
        return response.json().catch(()=> ({}));
      }

      // --- Toggles ---
      function bindToggle(toggleId, panelId){
        const t = byId(toggleId); const panel = byId(panelId);
        if(!t || !panel) return;
        const apply = () => t.checked ? show(panel) : hide(panel);
        t.addEventListener('change', apply);
        apply();
      }
      bindToggle('toggle-second','second-wrap');
      bindToggle('toggle-first','first-wrap');

      // Подсказка под тумблером «Протестировать AI обработку»
      (function(){
        const t = document.getElementById('toggle-first');
        const hint = document.getElementById('hint-first');
        if(!t || !hint) return;
        const apply = () => { hint.style.display = t.checked ? '' : 'none'; };
        t.addEventListener('change', apply);
        apply();
      })();

      // --- Upload slots + drop-zone & fade-in ---
      function bindSlot(prefix){
        const input = byId(`input-${prefix}`);
        const preview = byId(`preview-${prefix}`);
        const drop = byId(`drop-${prefix}`);
        const err = byId(`error-${prefix}`);
        const panel = drop ? drop.closest('.uploads') : null;
        const hiddenName = prefix === 'second' ? 'Second_image' : 'First_image';
        let url = null;

        function setErr(msg){ if(!err) return; err.textContent = msg || ''; err.style.display = msg ? 'block' : 'none'; }
        function clear(){
          if(url){ URL.revokeObjectURL(url); url = null; }
          if(preview){
            preview.style.opacity = '0';
            preview.addEventListener('transitionend', function hideOnFade(e){
              if(e.propertyName === 'opacity'){
                preview.style.display = 'none';
                preview.removeEventListener('transitionend', hideOnFade);
              }
            });
          }
          if(drop){ drop.classList.remove('has-image'); }
          setStatus(hiddenName,false);
          if(hiddenName === 'Second_image'){
            templateMediaState.pendingFile = null;
            templateMediaState.mediaId = '';
            if(secondMediaHidden){ secondMediaHidden.value = ''; }
          }
          if(hiddenName === 'First_image'){
            testImageState.file = null;
          }
        }
        function onFile(file){
          if(!file) return;
          if(!isValid(file)){
            setErr('Неверный формат. Разрешены только JPG и PNG.');
            if(input) input.value='';
            clear();
            return;
          }
          setErr('');
          if(url){ URL.revokeObjectURL(url); }
          url = URL.createObjectURL(file);
          if(panel) panel.classList.add('show');
          drop.classList.add('has-image');
          preview.src = url;
          preview.style.display='block';
          preview.style.opacity='0';
          requestAnimationFrame(()=>{ preview.style.opacity='1'; });
          setStatus(hiddenName,true);
          if(hiddenName === 'Second_image'){
            templateMediaState.pendingFile = file;
            templateMediaState.mediaId = '';
            if(secondMediaHidden){ secondMediaHidden.value = ''; }
          }
          if(hiddenName === 'First_image'){
            testImageState.file = file;
          }
        }

        if(input){ input.addEventListener('change', ()=> onFile(input.files && input.files[0])); }

        if(drop){ drop.addEventListener('click', (e)=>{
          const t = e.target;
          if(t && t.getAttribute && t.getAttribute('data-action')==='remove'){
            e.preventDefault(); e.stopPropagation();
            if(input) input.value='';
            clear();
          }
        }); }

        if(drop){
          const on = (ev,fn)=> drop.addEventListener(ev,fn);
          on('dragover', (e)=>{ e.preventDefault(); drop.classList.add('dragging'); });
          on('dragenter', (e)=>{ e.preventDefault(); drop.classList.add('dragging'); });
          on('dragleave', ()=> drop.classList.remove('dragging'));
          on('drop', (e)=>{
            e.preventDefault(); drop.classList.remove('dragging');
            const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
            if(file){
              onFile(file);
              if(input){
                const dt = new DataTransfer();
                dt.items.add(file);
                input.files = dt.files;
              }
            }
          });
        }
      } // end bindSlot
      bindSlot('second');
      bindSlot('first');

      // --- Provider → Operation → Required fields ---
      const providerSel = byId('provider');
      const operationSel = byId('operation');
      const operationSelectWrap = byId('operation-select-wrap');
      const reqHint = byId('op-req');
      const GEMINI_PROVIDER = 'gemini';
      const TURBOTEXT_PROVIDER = 'turbotext';

      function resetOperation(){
        operationSel.innerHTML = '<option value="" disabled selected>— выберите операцию —</option>';
        operationSel.disabled = true;
        slotMeta.operation = '';
        reqHint.style.display = 'none';
        if(operationSelectWrap){ operationSelectWrap.style.display = ''; }
      }

      function setOperationValue(provider, opKey){
        if(!provider || !opKey) return;
        const cfg = CONFIG[provider];
        if(!cfg || !cfg.operations || !cfg.operations[opKey]) return;
        operationSel.value = opKey;
        slotMeta.operation = opKey;
        applyNeeds(cfg.operations[opKey].needs);
      }

      function applyNeeds(needs){
        const normalized = needs || { prompt:true, second:false, first:true };
        // needs: {prompt, second, first}
        // Prompt field visibility
        const promptArea = byId('long').closest('.card');
        if(promptArea){
          // оставляем карту, но если prompt не нужен — просто подсказкой укажем, что он опционален
          const lbl = promptArea.querySelector('label.title');
          if(lbl){ lbl.textContent = normalized.prompt ? 'Параметры операции' : 'Параметры операции (промпт опционален)'; }
        }
        // Images toggles: автопоказ только если нужно — без блокировки ручного выключения
        const tFirst = byId('toggle-first');
        const tSecond = byId('toggle-second');
        if(tFirst){ tFirst.checked = normalized.first || tFirst.checked; tFirst.dispatchEvent(new Event('change')); }
        if(tSecond){ tSecond.checked = normalized.second || tSecond.checked; tSecond.dispatchEvent(new Event('change')); }

        // Compose human-readable requirements
        const req = [];
        if(normalized.first) req.push('нужно «Фото для тестов»');
        if(normalized.second) req.push('нужно «Изображение — Шаблон стиля»');
        if(normalized.prompt) req.push('нужен текстовый промпт');
        reqHint.textContent = req.length ? ('Для выбранной операции: ' + req.join('; ') + '.') : 'Для выбранной операции специальных требований нет.';
        reqHint.style.display = '';
      }

      function pickGeminiDefault(ops){
        if(PRESET_OPERATION && ops[PRESET_OPERATION]) return PRESET_OPERATION;
        if(ops[GEMINI_DEFAULT_OPERATION]) return GEMINI_DEFAULT_OPERATION;
        const keys = Object.keys(ops || {});
        return keys[0] || '';
      }

      providerSel.addEventListener('change', ()=>{
        const prov = providerSel.value;
        resetOperation();
        const config = CONFIG[prov];
        if(!prov || !config){
          slotMeta.provider = '';
          slotMeta.modelName = '';
          updateSlotHeader('');
          return;
        }
        const ops = config.operations || {};
        const frag = document.createDocumentFragment();
        Object.entries(ops).forEach(([key, meta])=>{
          const opt = document.createElement('option');
          opt.value = key; opt.textContent = meta.label;
          frag.appendChild(opt);
        });
        operationSel.appendChild(frag);
        operationSel.disabled = false;
        slotMeta.provider = prov;
        slotMeta.modelName = (prov === PRESET_PROVIDER && PRESET_MODEL_NAME) ? PRESET_MODEL_NAME : (config.label || prov);

        if(prov === GEMINI_PROVIDER){
          const defaultOp = pickGeminiDefault(ops);
          if(operationSelectWrap){ operationSelectWrap.style.display = 'none'; }
          setOperationValue(prov, defaultOp);
        } else {
          if(operationSelectWrap){ operationSelectWrap.style.display = ''; }
          if(prov === TURBOTEXT_PROVIDER){
            setOperationValue(prov, TURBOTEXT_DEFAULT_OPERATION);
          }
        }

        updateSlotHeader(prov);
      });

      operationSel.addEventListener('change', ()=>{
        const prov = providerSel.value;
        const op = operationSel.value;
        if(!prov || !op || !CONFIG[prov] || !CONFIG[prov].operations[op]) return;
        if(prov === TURBOTEXT_PROVIDER && op !== TURBOTEXT_DEFAULT_OPERATION){
          toast('Эта операция пока ещё не работает в Turbotext. Используйте Image2Image.', 'error');
          operationSel.value = TURBOTEXT_DEFAULT_OPERATION;
          setOperationValue(prov, TURBOTEXT_DEFAULT_OPERATION);
          return;
        }
        setOperationValue(prov, op);
      });

      // --- Предзаполнение данными слота из атрибутов body ---
      (function prefillSlotFromData(){
        if(slotMeta.provider){
          providerSel.value = slotMeta.provider;
          providerSel.dispatchEvent(new Event('change'));
          if(slotMeta.provider === GEMINI_PROVIDER && PRESET_OPERATION){
            setOperationValue(GEMINI_PROVIDER, PRESET_OPERATION);
          }
          if(slotMeta.provider === TURBOTEXT_PROVIDER && PRESET_OPERATION){
            operationSel.value = PRESET_OPERATION;
            operationSel.dispatchEvent(new Event('change'));
          }
        } else {
          updateSlotHeader('');
        }
      })();

      // --- Кнопка «Тест1» ---
      (function(){
        const b = document.getElementById('btn-test1');
        if(!b) return;
        b.addEventListener('click', async function(){
          clearFieldErrors();
          const st = document.getElementById('First_image_status');
          if(!st || st.value !== 'present'){
            return toast('Загрузите тестовое фото перед запуском «Тест1».', 'error');
          }
          if(!(slotMeta.provider || providerSel.value)){
            return toast('Сначала выберите провайдера и операцию.', 'error');
          }
          const prov = slotMeta.provider || providerSel.value;
          const op = slotMeta.operation || operationSel.value;
          const provConfig = CONFIG[prov];
          const needs = provConfig?.operations?.[op]?.needs || { prompt:true, second:false, first:true };
          if(needs.prompt && !getPromptValue()){
            return toast('Добавьте промпт перед тестовым запуском.', 'error');
          }
          if(needs.second && byId('Second_image_status').value !== 'present'){
            return toast('Для выбранной операции нужен шаблон «Изображение — Шаблон стиля».', 'error');
          }
          try{
            const templateBindings = await collectTemplateMediaBindings();
            await runSlotTest(templateBindings);
            pulse(document.getElementById('upload-form'));
            toast('Тестовый запуск отправлен. Смотрите обновления в галерее ниже.', 'success');
          }catch(err){
            console.warn('[Test run]', err);
            toast(err.message || 'Не удалось выполнить тест', 'error');
          }
        });
      })();

      // --- Генерация ingest-ссылки (клиентская заглушка) ---
      const INGEST_BASE_URL = 'https://api.example.com/ingest/';
      function generateIngestURL(slotId, providerSlug){
        if(slotId && providerSlug){
          return `${INGEST_BASE_URL}${providerSlug}/${slotId}`;
        }
        return '';
      }

      function updateSlotHeader(providerOverride){
        const provider = providerOverride || slotMeta.provider || '';
        const providerLabel = provider && CONFIG[provider]?.label ? CONFIG[provider].label : provider;
        const displayName = slotMeta.modelName || providerLabel || '— выберите провайдера —';
        if(slotModelText){
          const slugPart = provider ? ` (${provider})` : '';
          slotModelText.textContent = `AI-модель: ${displayName}${slugPart}`;
        }
        if(slotIdValue){ slotIdValue.textContent = slotMeta.id; }
        if(ingestInput){
          const url = generateIngestURL(slotMeta.id, provider);
          ingestInput.value = url;
          if(copyBtn){ copyBtn.disabled = !provider; }
        }
      }

      // --- Кнопка «Копировать» ---
      (function(){
        const btn = copyBtn;
        if(!btn || !ingestInput) return;
        btn.addEventListener('click', async ()=>{
          const value = (ingestInput.value || '').trim();
          if(!value){ return toast('Нет ссылки для копирования', 'error'); }
          try{
            await navigator.clipboard.writeText(value);
            toast('Ссылка скопирована', 'success');
          }catch(e){
            ingestInput.select(); document.execCommand('copy');
            toast('Ссылка скопирована', 'success');
          }
        });
      })();

      // --- Кнопка «Сохранить слот» — валидация и выдача ingest URL ---
      (function(){
        const save = document.getElementById('btn-save1');
        if(!save) return;
        save.addEventListener('click', async function(){
          const form = document.getElementById('upload-form');
          if(!form) return;
          clearFieldErrors();
          const title = (byId('title').value || '').trim();
          const prov = byId('provider').value;
          if(!title){ toast('Заполните название слота', 'error'); return pulse(form); }
          if(!prov){ toast('Выберите провайдера', 'error'); return pulse(form); }

          const provConfig = CONFIG[prov];
          if(!provConfig){
            toast('Провайдер недоступен', 'error'); return pulse(form);
          }
          let op = slotMeta.operation || operationSel.value;
          if(prov === GEMINI_PROVIDER && !op){
            op = pickGeminiDefault(provConfig.operations || {});
            setOperationValue(prov, op);
          }
          if(prov === TURBOTEXT_PROVIDER){
            if(!op){ op = TURBOTEXT_DEFAULT_OPERATION; }
            if(op !== TURBOTEXT_DEFAULT_OPERATION){
              op = TURBOTEXT_DEFAULT_OPERATION;
              setOperationValue(prov, op);
            }
          }
          if(!op){
            toast('Выберите операцию', 'error'); return pulse(form);
          }
          slotMeta.operation = op;

          const needs = provConfig?.operations?.[op]?.needs || { prompt:true, second:false, first:true };
          if(needs.prompt && !getPromptValue()){
            toast('Добавьте текстовый промпт для операции', 'error'); return pulse(form);
          }
          if(needs.second && byId('Second_image_status').value !== 'present'){
            toast('Для этой операции требуется «Изображение — Шаблон стиля»', 'error'); return pulse(form);
          }

          try{
            const templateMedia = await collectTemplateMediaBindings();
            const payload = {
              slot_id: slotMeta.id,
              display_name: title,
              provider: prov,
              operation: op,
              is_active: true,
              size_limit_mb: slotMeta.sizeLimitMb,
              sync_response_seconds: slotMeta.syncResponseSeconds,
              settings: collectProviderSettings(prov),
              template_media: templateMedia,
            };
            await persistSlot(payload);
            slotMeta.provider = prov;
            slotMeta.modelName = (prov === PRESET_PROVIDER && PRESET_MODEL_NAME) ? PRESET_MODEL_NAME : (CONFIG[prov]?.label || prov);
            updateSlotHeader(prov);
            if(copyBtn){ copyBtn.disabled = false; }
            pulse(form);
            toast('Конфигурация сохранена через PUT /api/slots/{slot_id}', 'success');
            const message = `Слот «${title}» обновлён через ${SLOT_SAVE_ENDPOINT}.`;
            byId('server-response').textContent = message;
          }catch(err){
            console.warn('[Save slot]', err);
            toast(err.message || 'Не удалось сохранить слот', 'error');
          }
        });
      })();

      loadRecentResults({ silent:true });

      // --- Self tests ---
      try{
        console.assert(document.body.dataset.slotId, 'slot id data attribute exists');
        console.assert(byId('slot-model-label'), 'Slot model label exists');
        console.assert(slotModelText, 'Slot model text exists');
        console.assert(ingestInput, 'Ingest input exists');
        console.assert(byId('toggle-second') && byId('second-wrap'), 'Second toggle/panel exist');
        console.assert(byId('toggle-first') && byId('first-wrap'), 'First toggle/panel exist');
        console.assert(byId('Second_image_status').value === 'removed', 'Second_image_status default removed');
        console.assert(byId('First_image_status').value === 'removed', 'First_image_status default removed');
        console.assert(byId('input-second').getAttribute('accept').includes('image/jpeg'), 'input-second accepts jpeg');
        console.assert(byId('input-second').getAttribute('accept').includes('image/png'), 'input-second accepts png');
        console.assert(byId('slot-results-grid'), 'Results grid exists');
      }catch(e){ console.warn('[Self-test]', e); }

    })();
  </script>
</body>
</html>
