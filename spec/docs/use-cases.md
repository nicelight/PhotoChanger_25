# Use Cases — PhotoChanger

Документ синхронизирован с `docs/BRIEF.md`, `docs/PRD.md` (Iteration 2) и `docs/ARCHITECTURE.md`. Диаграммы последовательностей/состояний будут размещены в `spec/diagrams/` (см. US PHC-1.0.3) и привязаны к сценариям ниже.

## Общие требования
- Ingest-поток принимает `multipart/form-data`, обязательные поля формы — `password` (строка), `hash` (hex-checksum) и `fileToUpload` (часть с заголовком `Content-Type = image/jpeg|image/png|image/webp`, размер ≤ лимита слота и абсолютного капа 20 МБ). Дополнительные поля DSLR Remote Pro передаёт произвольно, система их не ограничивает.
- Успешный ответ `POST /api/ingest/{slot_id}` — только бинарное изображение с заголовками `Content-Type` (одно из поддерживаемых значений), `Content-Length`, `Cache-Control: no-store`. `job_id` и JSON в ответе не возвращаются.
- Ошибочные ответы ingest API оформляются как JSON: `{"status": "<error>|timeout", "failure_reason": "<строковый код>", "details": "<опциональный текст>"}`. Если верификация прошла до создания `job_id`, поле не передаётся. HTTP-коды соответствуют PRD: 400/401/404/413/415/429/500/502/503/504.
- Cron `scripts/cleanup_media.py` запускается каждые 15 минут и удаляет просроченные каталоги `media/results/{slot_id}/{job_id}` (payload + preview), а также обновляет `media_object.cleaned_at`.

## UC0. Вход администратора и ротация ingest-пароля
- **Цель:** администратор обновляет глобальный ingest-пароль и убеждается, что он применён.
- **Акторы:** Администратор (`serg`/`igor`), Auth API, Settings API, Audit log.
- **Предусловия:** статические учётные записи активны, администратор знает текущие креды.
- **Основной поток:**
  1. `POST /api/login` — получение JWT с правами `settings:read`/`settings:write` (TTL 24 ч).
  2. `GET /api/settings` — просмотр текущих параметров (`T_sync_response`, TTL, дата/автор последних изменений).
  3. `PUT /api/settings` с новым `ingest.dslr_password` — сервис хэширует пароль, обновляет метаданные и фиксирует событие в аудите.
  4. Ingest API начинает использовать новый хэш без рестарта; UI выводит обновлённые метаданные при следующем запросе.
- **Альтернативы:** `401 Unauthorized` — неверные креды; `429 Too Many Requests` — превышен лимит попыток; `403 Forbidden` — нет права `settings:write`.
- **Итог:** пароль обновлён, аудит содержит запись, операторы получают новое значение от администратора.
- **Диаграмма:** `spec/diagrams/uc0-admin-password-sequence.mmd` (план).

## UC1. Настройка слота администратором
- **Цель:** скорректировать конфигурацию одного из статических слотов `slot-001` … `slot-015`.
- **Акторы:** Администратор, Admin UI, Slots API, Template Media API.
- **Предусловия:** JWT с правами `slots:read`/`slots:write`.
- **Основной поток:**
  1. `GET /api/slots` — список слотов с конфигурацией (провайдер, операция, `size_limit_mb`, `t_sync_response`, `template_media_id`, версия).
  2. При необходимости — загрузка шаблона `POST /api/template-media/register`; сервис проверяет MIME, размер и возвращает `template_media_id` + превью.
  3. Администратор в UI указывает провайдера, операцию и параметры (JSON), опираясь на ограничения из PRD.
  4. `PUT /api/slots/{slot_id}` — Slots API валидирует схему и лимиты провайдера, сохраняет изменения, обновляет журнал и версию.
  5. UI показывает подтверждение и актуальный ingest-URL `<BASE_URL>/api/ingest/{slot_id}`; пароль передаётся отдельно.
- **Альтернативы:** `422 Unprocessable Entity` — неверный провайдер/операция/JSON или превышен лимит размера; `404 Not Found` — слот выключен; `409 Conflict` — версия устарела; для шаблонных медиа — `422` (формат), `409` (файл используется).
- **Итог:** слот готов принимать ingest-запросы с новой конфигурацией; журнал фиксирует автора и время.
- **Диаграмма:** `spec/diagrams/uc1-slot-edit-sequence.mmd` (план).

## UC2. Успешный ingest (синхронный ответ)
- **Цель:** DSLR Remote Pro получает результат в пределах `T_sync_response`.
- **Акторы:** DSLR Remote Pro, Ingest API, IngestService, Provider Driver (Gemini/Turbotext), Media Store, PostgreSQL.
- **Предусловия:** слот активен; пароль валиден; лимиты конкурентности не превышены.
- **Основной поток:**
  1. `POST /api/ingest/{slot_id}` — multipart с обязательными `password`, `hash` и `fileToUpload`; дополнительные поля принимаются без ограничений.
  2. Ingest API проверяет существование слота, сверяет `password`, пересчитывает checksum файла и сравнивает с `hash`, валидирует размер/MIME по заголовку части и фактическому объёму, захватывает семафоры (пер-слот и глобальный).
  3. Создаётся `job_history(status='pending')`, фиксируется `sync_deadline = started_at + T_sync_response`, формируется `JobContext` с путями в хранилище результатов.
  4. `IngestService` вызывает драйвер: `await asyncio.wait_for(driver.process(job_ctx), timeout=T_sync_response)`.
  5. Драйвер возвращает обработанное изображение до истечения таймаута.
  6. Результат сохраняется в `media/results/{slot_id}/{job_id}/payload.{ext}` вместе с превью `preview.webp`; `job_history` обновляется (`status='done'`, `result_expires_at = now + 72h`), метрики фиксируются.
  7. Клиент получает `200 OK` с бинарным телом результата и соответствующими заголовками. `job_id` наружу не выдаётся; при необходимости оператор использует публичную галерею.
- **Альтернативы:** `401`, `404`, `413`, `415`, `429`, `5xx` — см. UC3 и UC6; тела ошибок соответствуют общим требованиям.
- **Итог:** оператор получает готовое изображение; результат доступен 72 ч через публичную ссылку; статистика обновлена.
- **Диаграмма:** `spec/diagrams/uc2-ingest-success-sequence.mmd` (готово).

## UC3. Ingest с таймаутом (`504 Gateway Timeout`)
- **Цель:** корректно завершить запрос при превышении `T_sync_response`.
- **Акторы:** DSLR Remote Pro, Ingest API, IngestService, Provider Driver, Media Store, PostgreSQL.
- **Предусловия:** совпадают с UC2.
- **Основной поток / отклонение:**
  1. Шаги 1–4 UC2 выполняются идентично.
  2. Драйвер не успевает завершить операцию; `asyncio.wait_for` поднимает `TimeoutError`.
  3. `IngestService` обновляет `job_history(status='timeout', failure_reason='provider_timeout')`, удаляет каталог `media/results/{slot_id}/{job_id}` (если создан) и освобождает семафоры.
  4. Клиент получает `504 Gateway Timeout` с телом `{"status":"timeout","failure_reason":"provider_timeout"}`.
- **Альтернативы:** при сетевых сбоях — `502`/`503` с подходящей причиной; при превышении лимитов — ответы UC2.
- **Итог:** оператор информирован о таймауте и может повторить запрос; статистика фиксирует событие; просроченных файлов не остаётся.
- **Диаграмма:** `spec/diagrams/uc3-ingest-timeout-sequence.mmd` (последовательность) и `spec/diagrams/uc3-ingest-state.mmd` (state) — готовы.

## UC4. Истечение TTL результата
- **Цель:** гарантировать автоматическое удаление результатов и публичных ссылок по истечении 72 ч.
- **Акторы:** Публичный клиент, Public API, Media Store, Cron.
- **Предусловия:** `job_history.status='done'`, файл лежит в `media/results`, TTL не истёк.
- **Основной поток:**
  1. `GET /public/results/{job_id}` — Public API проверяет наличие файла и TTL.
  2. При успехе возвращается `200 OK` с бинарным файлом и `Content-Disposition: attachment`.
  3. После истечения срока cron очищает `media/results` и обновляет `media_object.cleaned_at`; ленивые проверки API также могут удалить файлы.
  4. Запросы после очистки получают `410 Gone` с телом `{"status":"error","failure_reason":"result_expired"}`.
- **Альтернативы:** `404 Not Found` — неверный `job_id` или результат ещё не готов (`{"status":"error","failure_reason":"result_not_found"}`); `503` — временная недоступность хранилища.
- **Итог:** просроченные результаты удаляются, публичные ссылки становятся недействительными, галерея при следующем опросе скрывает элементы.
- **Диаграмма:** `spec/diagrams/uc4-mediaobject-state.mmd` (готово).

## UC5. Управление шаблонными медиа
- **Цель:** администратор управляет шаблонными ресурсами для провайдеров.
- **Акторы:** Администратор, Admin UI, Template Media API, Media Store.
- **Предусловия:** JWT с правами `slots:write`; учтены ограничения провайдера по форматам.
- **Основной поток:**
  1. `POST /api/template-media/register` — загрузка файла (фон, маска, стиль). API валидирует MIME/размер и сохраняет объект в `media/templates`, возвращает `template_media_id` и превью.
  2. ID шаблона привязывается к слоту в UI и передаётся в `PUT /api/slots/{slot_id}`.
  3. При удалении UI вызывает `DELETE /api/template-media/{id}`; API проверяет, что медиа больше не используются слотами, и удаляет файл.
- **Альтернативы:** `422` — неподдерживаемый формат/размер; `409` — попытка удалить используемое медиа.
- **Итог:** шаблонные ресурсы доступны драйверам, но не публикуются для внешних клиентов.
- **Диаграмма:** `spec/diagrams/uc5-gallery-sequence.mmd` (готово).

## UC6. Просмотр результатов слота и скачивание
- **Цель:** администратор или оператор просматривает недавние результаты и управляет SLA.
- **Акторы:** Администратор/UI, Slots API, Stats API, Public API.
- **Предусловия:** есть завершённые задачи со статусом `done`, TTL не истёк.
- **Основной поток:**
  1. `GET /api/slots/{slot_id}` — UI получает конфигурацию и блок `recent_results` (до 10 записей: `job_id`, время, статус, MIME, `public_url`, `expires_at`).
  2. `GET /api/stats/slots` — получение сводных метрик (p95, доля 504, counters).
  3. Пользователь выбирает результат; UI вызывает `GET /public/results/{job_id}`. При успехе — `200` с файлом; при истощении TTL — `410 Gone`, UI помечает карточку как недоступную.
  4. Кнопка «Очистить медиакеш» вызывает `POST /api/slots/{slot_id}/cleanup`, что инициирует отложенную очистку устаревших результатов (каталоги `media/results/{slot_id}/{job_id}` с истёкшим TTL); актуальные файлы и превью остаются.
- **Альтернативы:** `401/403` — недостаточно прав; `404` — слот отсутствует; `503` — временно недоступны хранилище/БД.
- **Итог:** администратор видит актуальные конфигурации и статистику, может скачивать свежие результаты и управлять очисткой.
- **Диаграммы:** `spec/diagrams/uc6-ops-sequence.mmd`, `spec/diagrams/cron-cleanup-state.mmd`.
