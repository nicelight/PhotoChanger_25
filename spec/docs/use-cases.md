# Use Cases — PhotoChanger

Документ опирается на `.memory/USECASES.md`, `docs/PRD.md` и `docs/ARCHITECTURE.md`. Диаграммы последовательностей и состояний будут размещены в `spec/diagrams/` (US PHC-1.0.3) и связываются с разделами ниже.

## UC0. Вход администратора и ротация ingest-пароля
- **Цель:** администратор обновляет глобальный ingest-пароль и подтверждает его применение.
- **Акторы:** Администратор (`serg`/`igor`), Auth API, Settings API.
- **Предусловия:** Администратор знает текущие учетные данные, сервис `/api/login` доступен.
- **Основной поток:**
  1. `POST /api/login` → выдаётся JWT с правами `settings:write`.
  2. `PUT /api/settings` с новым паролем (`ingest.dslr_password`), сервис сохраняет хэш и аудит.
  3. `GET /api/settings` возвращает метаданные (дата обновления, автор).
- **Альтернативы:** неверный логин/пароль → `401`; превышен лимит попыток → `429`; отсутствие прав `settings:write` → `403`.
- **Итог:** новый пароль вступает в силу немедленно; ingest API использует актуальный хэш.
- **Диаграмма:** `spec/diagrams/uc0-admin-password-sequence.mmd` (планируется).

## UC1. Настройка слота администратором
- **Цель:** обновить конфигурацию одного из 15 слотов.
- **Акторы:** Администратор, Slot Management API/UI.
- **Предусловия:** JWT с правами `slots:write`.
- **Основной поток:** просмотр списка слотов → выбор слота → загрузка формы с текущими параметрами → редактирование → `PUT /api/slots/{slot_id}` → валидация схемы → сохранение в БД → UI показывает обновлённую конфигурацию и ссылку ingest.
- **Альтернативы:** `422` при невалидных параметрах, `404` при несуществующем слоте, `409` при конфликте версий (`version`).
- **Итог:** слот активен с новыми настройками; журнал изменений фиксирует событие.
- **Диаграмма:** `spec/diagrams/uc1-slot-edit-sequence.mmd` (планируется).

## UC2. Успешный ingest
- **Цель:** DSLR Remote Pro получает результат в пределах `T_sync_response`.
- **Акторы:** DSLR Remote Pro, Ingest API, Provider Driver, Media Store, PostgreSQL.
- **Основной поток:** `POST /api/ingest/{slot_id}` → проверка пароля/слота → `JobContext` → сохранение temp → `wait_for(driver.process)` → получение результата → сохранение итогового файла → обновление `job_history` (`done`) → ответ 200 с `/public/results/{job_id}` и inline превью (если запрошено).
- **Альтернативы:** `401`, `413`, `415`, `404`, `502` (см. UC3/UC5/UC6).
- **Итог:** файл доступен 72 ч, статистика обновлена.
- **Диаграмма:** `spec/diagrams/uc2-ingest-success-sequence.mmd`.

## UC3. Таймаут ingest (504)
- **Цель:** корректно завершить запрос при превышении `T_sync_response`.
- **Акторы:** DSLR Remote Pro, Ingest API, Provider Driver.
- **Основной поток:** `POST /api/ingest/{slot_id}` → вызов драйвера → `asyncio.TimeoutError` → статус `timeout` в `job_history` → удаление temp-файлов → ответ 504.
- **Итог:** оператор может повторить запрос; статистика фиксирует таймауты; алерты могут сработать при превышении порогов.
- **Диаграмма:** `spec/diagrams/uc3-ingest-timeout-sequence.mmd`.

## UC4. Истечение временной ссылки провайдера
- **Цель:** обеспечить автоматическое удаление временных ссылок (`MediaObject`) после TTL.
- **Акторы:** AI-провайдер, Media Store, Provider Driver, Cron.
- **Основной поток:** регистрация `MediaObject` → провайдер скачивает файл → по истечении TTL cron или ленивый доступ удаляет запись и файл → дальнейшие запросы получают `410 Gone`.
- **Итог:** провайдер понимает, что ссылка просрочена; система освобождает диск.
- **Диаграмма:** `spec/diagrams/uc4-mediaobject-state.mmd` (state diagram).

## UC5. Управление шаблонными медиа и галереей
- **Цель:** администратор управляет шаблонными файлами и просматривает последние результаты.
- **Акторы:** Администратор, Admin API/UI, Media Store, Public API.
- **Основной поток:** `POST /api/template-media/register` → валидация MIME/размера → привязка к слоту → `GET /api/slots/{slot_id}` → отображение `recent_results` (до 10) → UI показывает превью `/public/results/{job_id}`.
- **Альтернативы:** `422` (некорректные медиа), `404` (нет файла/слота), `410` (просроченный результат).
- **Итог:** UI обновляет галерею; просроченные результаты скрываются автоматически.
- **Диаграмма:** `spec/diagrams/uc5-gallery-sequence.mmd`.

## UC6. Наблюдаемость и Ops
- **Цель:** команда эксплуатации контролирует SLA и управляет очисткой.
- **Акторы:** Ops-инженер, Monitoring, Cron.
- **Основной поток:** `/metrics` → проверка p95/504/размеров медиа → `/healthz` → Cron `cleanup_media.py` каждые 15 мин → алерты при аномалиях.
- **Альтернативы:** отсутствие метрик → инцидент P1; падение cron → ручной перезапуск; превышение диска → эскалация.
- **Итог:** система остаётся в пределах SLA, диск не переполняется.
- **Диаграммы:** `spec/diagrams/uc6-ops-sequence.mmd`, `spec/diagrams/cron-cleanup-state.mmd`.
